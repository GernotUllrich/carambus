<div class="container mx-auto my-8 px-4">
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">
        Setzliste Ã¼bernehmen: <%= @tournament.title %>
      </h1>
      <%= link_to 'â† ZurÃ¼ck', tournament_path(@tournament), class: 'btn btn-secondary' %>
    </div>

    <!-- ErklÃ¤rung -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-blue-900 mb-2">ğŸ’¡ So funktioniert's:</h3>
      <ol class="list-decimal list-inside text-blue-800 space-y-1">
        <li>Laden Sie die <strong>offizielle Einladung</strong> (PDF oder Screenshot) hoch</li>
        <li>Carambus extrahiert automatisch die <strong>Setzliste</strong></li>
        <li>Sie prÃ¼fen und bestÃ¤tigen die erkannten Spieler</li>
        <li>Die Reihenfolge wird Ã¼bernommen</li>
      </ol>
    </div>

    <!-- Upload-Bereich -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“§ Offizielle Einladung hochladen</h2>
      
      <% if @tournament.data['invitation_filename'].present? %>
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-green-800">
                âœ… Einladung vorhanden: <strong><%= @tournament.data['invitation_filename'] %></strong>
              </p>
            </div>
            <div>
              <%= link_to 'Erneut parsen', parse_invitation_tournament_path(@tournament), 
                  class: 'btn btn-primary btn-sm' %>
            </div>
          </div>
        </div>
      <% end %>

      <%= form_with url: upload_invitation_tournament_path(@tournament), method: :post, 
          multipart: true, local: true, class: 'space-y-4', id: 'invitation-upload-form' do |f| %>
        
        <div id="upload-area" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition relative">
          <!-- Drag Overlay -->
          <div id="drag-overlay" class="absolute inset-0 bg-blue-100 bg-opacity-90 border-4 border-blue-500 border-dashed rounded-lg flex items-center justify-center hidden z-10">
            <div class="text-center">
              <span class="text-6xl mb-4 block">ğŸ“¥</span>
              <p class="text-xl font-bold text-blue-900">Datei hier ablegen</p>
            </div>
          </div>
          
          <div class="mb-4">
            <span class="text-6xl">ğŸ“„</span>
          </div>
          
          <%= f.file_field :invitation_file, 
              accept: 'application/pdf,image/png,image/jpeg',
              class: 'hidden',
              id: 'invitation-upload',
              onchange: 'updateFileName(this)' %>
          
          <label for="invitation-upload" class="cursor-pointer">
            <span class="btn btn-primary">
              Datei auswÃ¤hlen
            </span>
          </label>
          
          <p class="text-gray-600 mt-2" id="selected-file-name">
            PDF oder Screenshot (PNG, JPG)<br>
            <span class="text-sm text-blue-600">ğŸ’¡ Oder Datei hierher ziehen (z.B. aus E-Mail)</span>
          </p>
          
          <p class="text-sm text-gray-500 mt-4">
            UnterstÃ¼tzte Formate: PDF, PNG, JPEG<br>
            Die Setzliste wird automatisch extrahiert!
          </p>
        </div>

        <div class="flex justify-end">
          <%= f.submit 'Hochladen & automatisch parsen', 
              class: 'btn btn-primary btn-lg',
              data: { disable_with: 'Wird verarbeitet...' } %>
        </div>
      <% end %>
    </div>

    <!-- Alternative: ClubCloud-Reihenfolge -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“Š Alternative: Mit ClubCloud-Meldeliste weitermachen</h2>
      
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <p class="text-gray-700 mb-4">
            Falls keine Einladung vorliegt, kÃ¶nnen Sie mit der <strong>Meldeliste von ClubCloud</strong> 
            direkt zu Schritt 3 (Teilnehmerliste bearbeiten) weitermachen.
          </p>
          
          <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
            <p class="text-sm text-blue-900 mb-2"><strong>Zwei MÃ¶glichkeiten:</strong></p>
            <ul class="list-disc list-inside text-sm text-blue-800 space-y-1">
              <li><strong>Nach Rangliste sortiert:</strong> Carambus sortiert automatisch nach der aktuellen Rangliste (empfohlen fÃ¼r Landesturniere)</li>
              <li><strong>Wie in ClubCloud:</strong> Ãœbernimmt die Reihenfolge exakt wie sie in ClubCloud steht</li>
            </ul>
          </div>
          
          <% if @tournament.source_url.present? %>
            <%= link_to 'ğŸ”— ClubCloud Ã¶ffnen (zum Vergleich)', @tournament.source_url,
                target: '_blank',
                class: 'btn btn-secondary mb-4',
                rel: 'noopener' %>
          <% end %>
          
          <% if @clubcloud_seedings.any? %>
            <div class="bg-gray-50 p-4 rounded mb-4">
              <h4 class="font-semibold mb-2">ClubCloud-Meldeliste (<%= @clubcloud_seedings.count %> Spieler):</h4>
              <ol class="list-decimal list-inside text-sm max-h-48 overflow-y-auto">
                <% @clubcloud_seedings.each do |seeding| %>
                  <li><%= seeding.player.fullname %></li>
                <% end %>
              </ol>
            </div>
            
            <div class="flex gap-3">
              <%= button_to 'â†’ Mit Meldeliste zu Schritt 3 (nach Rangliste sortiert)', 
                  use_clubcloud_as_participants_tournament_path(@tournament),
                  method: :post,
                  class: 'btn btn-primary',
                  data: { confirm: 'Meldeliste von ClubCloud als Teilnehmerliste Ã¼bernehmen und nach Rangliste sortieren?\n\nDie Spieler werden automatisch nach der Carambus-Rangliste sortiert.' } %>
              
              <%= form_with url: apply_seeding_order_tournament_path(@tournament), method: :post, class: 'inline' do |f| %>
                <%= hidden_field_tag 'seeding_order[]', @clubcloud_seedings.map(&:player_id) %>
                <%= f.submit 'Diese Reihenfolge Ã¼bernehmen (wie in ClubCloud)', 
                    class: 'btn btn-outline-primary',
                    data: { confirm: 'ClubCloud-Reihenfolge exakt wie sie ist als Setzliste Ã¼bernehmen und zu Schritt 3 weitergehen?' } %>
              <% end %>
            </div>
          <% else %>
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
              <p class="text-yellow-800">
                âš ï¸ Keine ClubCloud-Daten verfÃ¼gbar.<br>
                <span class="text-sm">Bitte zuerst in Schritt 1 die Meldeliste von ClubCloud laden.</span>
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Manuelle Sortierung -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold mb-4">âœï¸ Alternative: Manuell sortieren</h2>
      
      <p class="text-gray-700 mb-4">
        Oder sortieren Sie die Liste automatisch nach aktueller Rangliste:
      </p>
      
      <%= button_to 'Nach Rangliste sortieren', 
          order_by_ranking_or_handicap_tournament_path(@tournament),
          method: :post,
          class: 'btn btn-outline-primary',
          disabled: !%w{new_tournament accreditation_finished}.include?(@tournament.state) %>
    </div>

  </div>
</div>

<script>
function updateFileName(input) {
  const fileName = input.files[0]?.name || 'PDF oder Screenshot (PNG, JPG)';
  document.getElementById('selected-file-name').innerHTML = fileName + '<br><span class="text-sm text-blue-600">ğŸ’¡ Oder Datei hierher ziehen (z.B. aus E-Mail)</span>';
}

// WICHTIG: Event-Handler MÃœSSEN sofort registriert werden (vor DOMContentLoaded)
// Sonst Ã¶ffnet Safari/Comet die Datei direkt statt Drag & Drop zu verwenden
(function() {
  // Speichere Upload-Bereich Referenz fÃ¼r spÃ¤tere PrÃ¼fung
  let uploadAreaRef = null;
  
  // Setze Upload-Bereich Referenz sobald DOM bereit ist
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      uploadAreaRef = document.getElementById('upload-area');
    });
  } else {
    uploadAreaRef = document.getElementById('upload-area');
  }
  
  function preventDefaults(e) {
    // PrÃ¼fe ob Event Ã¼ber Upload-Bereich ist
    // Wenn ja, NICHT verhindern (dann kÃ¼mmert sich der Upload-Handler darum)
    if (uploadAreaRef && uploadAreaRef.contains(e.target)) {
      return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    return false;
  }

  // Verhindere Standard-Verhalten GLOBAL und sehr frÃ¼h
  // Dies verhindert dass Browser PDFs Ã¶ffnet wenn sie gezogen werden
  // ABER: Nur auÃŸerhalb des Upload-Bereichs
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    // Capture-Phase (true) = Handler wird frÃ¼h ausgefÃ¼hrt
    document.addEventListener(eventName, preventDefaults, true);
    window.addEventListener(eventName, preventDefaults, true);
    if (document.body) {
      document.body.addEventListener(eventName, preventDefaults, true);
    }
  });
})();

// Drag & Drop FunktionalitÃ¤t
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('upload-area');
  const dragOverlay = document.getElementById('drag-overlay');
  const fileInput = document.getElementById('invitation-upload');
  const form = document.getElementById('invitation-upload-form');

  if (!uploadArea || !fileInput) return;

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  }

  // Highlight beim Drag Ã¼ber Upload-Bereich
  uploadArea.addEventListener('dragenter', function(e) {
    preventDefaults(e);
    dragOverlay.classList.remove('hidden');
    uploadArea.classList.add('border-blue-500');
    uploadArea.classList.add('bg-blue-50');
  }, false);

  uploadArea.addEventListener('dragover', function(e) {
    preventDefaults(e);
    // Setze dropEffect explizit auf 'copy' (verhindert 'link' oder 'move')
    if (e.dataTransfer) {
      try {
        e.dataTransfer.dropEffect = 'copy';
      } catch (err) {
        // Ignoriere Fehler wenn dropEffect nicht unterstÃ¼tzt wird
      }
    }
    dragOverlay.classList.remove('hidden');
    uploadArea.classList.add('border-blue-500');
    uploadArea.classList.add('bg-blue-50');
  }, false);

  uploadArea.addEventListener('dragleave', function(e) {
    preventDefaults(e);
    // Nur verstecken wenn wirklich auÃŸerhalb des Upload-Bereichs
    if (!uploadArea.contains(e.relatedTarget)) {
      dragOverlay.classList.add('hidden');
      uploadArea.classList.remove('border-blue-500');
      uploadArea.classList.remove('bg-blue-50');
    }
  }, false);

  // Datei-Drop verarbeiten
  uploadArea.addEventListener('drop', function(e) {
    preventDefaults(e);
    
    dragOverlay.classList.add('hidden');
    uploadArea.classList.remove('border-blue-500');
    uploadArea.classList.remove('bg-blue-50');
    
    const dt = e.dataTransfer;
    if (!dt) {
      console.error('DataTransfer nicht verfÃ¼gbar');
      return;
    }

    let file = null;

    // Versuch 1: dt.files (Standard)
    const files = dt.files;
    if (files && files.length > 0) {
      file = files[0];
    }

    // Versuch 2: dt.items API (Fallback)
    if (!file && dt.items && dt.items.length > 0) {
      for (let i = 0; i < dt.items.length; i++) {
        const item = dt.items[i];
        if (item.kind === 'file') {
          try {
            file = item.getAsFile();
            if (file) break;
          } catch (error) {
            console.log('getAsFile() fehlgeschlagen:', error);
          }
        }
      }
    }

    if (!file) {
      console.warn('Keine Dateien im DataTransfer gefunden');
      alert('Keine Datei erkannt. Bitte ziehen Sie eine Datei direkt (nicht einen Link) in den Upload-Bereich.');
      return;
    }

    // PrÃ¼fe Dateityp
    const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
    const fileType = file.type || '';
    const fileName = file.name.toLowerCase();
    
    const isValidType = validTypes.includes(fileType) || 
                        fileName.endsWith('.pdf') || 
                        fileName.endsWith('.png') || 
                        fileName.endsWith('.jpg') || 
                        fileName.endsWith('.jpeg');

    if (!isValidType) {
      alert('Bitte nur PDF, PNG oder JPEG Dateien hochladen!');
      return;
    }

    // Setze Datei ins Input-Feld
    // Verwende DataTransfer API (Standard-Methode)
    try {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      // Update Anzeige
      updateFileName(fileInput);
    } catch (error) {
      console.error('Fehler beim Setzen der Datei:', error);
      // Fallback: Versuche direkt Ã¼ber FileList
      try {
        // FÃ¼r Ã¤ltere Browser ohne DataTransfer API
        const fileList = {
          0: file,
          length: 1,
          item: function(index) { return index === 0 ? file : null; }
        };
        Object.defineProperty(fileInput, 'files', {
          value: fileList,
          writable: false,
          configurable: true
        });
        updateFileName(fileInput);
      } catch (fallbackError) {
        console.error('Auch Fallback fehlgeschlagen:', fallbackError);
        alert('Fehler beim Verarbeiten der Datei. Bitte nutzen Sie die Dateiauswahl.');
      }
    }
  }, false);
});
</script>

<style>
.upload-area:hover {
  background-color: #f8fafc;
}

#upload-area.drag-over {
  border-color: #3b82f6;
  background-color: #eff6ff;
}

#drag-overlay {
  pointer-events: none;
}
</style>

