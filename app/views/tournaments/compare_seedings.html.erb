<div class="container mx-auto my-8 px-4">
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">
        Setzliste Ã¼bernehmen: <%= @tournament.title %>
      </h1>
      <%= link_to 'â† ZurÃ¼ck', tournament_path(@tournament), class: 'btn btn-secondary' %>
    </div>

    <!-- ErklÃ¤rung -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-blue-900 mb-2">ğŸ’¡ So funktioniert's:</h3>
      <ol class="list-decimal list-inside text-blue-800 space-y-1">
        <li>Laden Sie die <strong>offizielle Einladung</strong> (PDF oder Screenshot) hoch</li>
        <li>Carambus extrahiert automatisch die <strong>Setzliste</strong></li>
        <li>Sie prÃ¼fen und bestÃ¤tigen die erkannten Spieler</li>
        <li>Die Reihenfolge wird Ã¼bernommen</li>
      </ol>
    </div>

    <!-- Upload-Bereich -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“§ Offizielle Einladung hochladen</h2>
      
      <% if @tournament.data['invitation_filename'].present? %>
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-green-800">
                âœ… Einladung vorhanden: <strong><%= @tournament.data['invitation_filename'] %></strong>
              </p>
            </div>
            <div>
              <%= link_to 'Erneut parsen', parse_invitation_tournament_path(@tournament), 
                  class: 'btn btn-primary btn-sm' %>
            </div>
          </div>
        </div>
      <% end %>

      <%= form_with url: upload_invitation_tournament_path(@tournament), method: :post, 
          multipart: true, local: true, class: 'space-y-4', id: 'invitation-upload-form' do |f| %>
        
        <div id="upload-area" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition relative">
          <!-- Drag Overlay -->
          <div id="drag-overlay" class="absolute inset-0 bg-blue-100 bg-opacity-90 border-4 border-blue-500 border-dashed rounded-lg flex items-center justify-center hidden z-10">
            <div class="text-center">
              <span class="text-6xl mb-4 block">ğŸ“¥</span>
              <p class="text-xl font-bold text-blue-900">Datei hier ablegen</p>
            </div>
          </div>
          
          <div class="mb-4">
            <span class="text-6xl">ğŸ“„</span>
          </div>
          
          <%= f.file_field :invitation_file, 
              accept: 'application/pdf,image/png,image/jpeg',
              class: 'hidden',
              id: 'invitation-upload',
              onchange: 'updateFileName(this)' %>
          
          <label for="invitation-upload" class="cursor-pointer">
            <span class="btn btn-primary">
              Datei auswÃ¤hlen
            </span>
          </label>
          
          <p class="text-gray-600 mt-2" id="selected-file-name">
            PDF oder Screenshot (PNG, JPG)<br>
            <span class="text-sm text-blue-600">ğŸ’¡ Oder Datei hierher ziehen (z.B. aus E-Mail)</span>
          </p>
          
          <p class="text-sm text-gray-500 mt-4">
            UnterstÃ¼tzte Formate: PDF, PNG, JPEG<br>
            Die Setzliste wird automatisch extrahiert!
          </p>
        </div>

        <div class="flex justify-end">
          <%= f.submit 'Hochladen & automatisch parsen', 
              class: 'btn btn-primary btn-lg',
              data: { disable_with: 'Wird verarbeitet...' } %>
        </div>
      <% end %>
    </div>

    <!-- Alternative: ClubCloud-Reihenfolge -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“Š Alternative: ClubCloud-Reihenfolge verwenden</h2>
      
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <p class="text-gray-700 mb-4">
            Falls keine Einladung vorliegt, kÃ¶nnen Sie die aktuelle Reihenfolge
            aus der ClubCloud Ã¼bernehmen.
          </p>
          
          <% if @tournament.source_url.present? %>
            <%= link_to 'ğŸ”— ClubCloud Ã¶ffnen (zum Vergleich)', @tournament.source_url,
                target: '_blank',
                class: 'btn btn-secondary mb-4',
                rel: 'noopener' %>
          <% end %>
          
          <% if @clubcloud_seedings.any? %>
            <div class="bg-gray-50 p-4 rounded">
              <h4 class="font-semibold mb-2">ClubCloud-Meldeliste:</h4>
              <ol class="list-decimal list-inside">
                <% @clubcloud_seedings.each do |seeding| %>
                  <li><%= seeding.player.fullname %></li>
                <% end %>
              </ol>
            </div>
            
            <%= form_with url: apply_seeding_order_tournament_path(@tournament), method: :post do |f| %>
              <%= hidden_field_tag 'seeding_order[]', @clubcloud_seedings.map(&:player_id) %>
              <%= f.submit 'Diese Reihenfolge Ã¼bernehmen', 
                  class: 'btn btn-outline-primary mt-4',
                  data: { confirm: 'ClubCloud-Reihenfolge als Setzliste Ã¼bernehmen?' } %>
            <% end %>
          <% else %>
            <p class="text-gray-500 italic">Keine ClubCloud-Daten verfÃ¼gbar</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Manuelle Sortierung -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold mb-4">âœï¸ Alternative: Manuell sortieren</h2>
      
      <p class="text-gray-700 mb-4">
        Oder sortieren Sie die Liste automatisch nach aktueller Rangliste:
      </p>
      
      <%= button_to 'Nach Rangliste sortieren', 
          order_by_ranking_or_handicap_tournament_path(@tournament),
          method: :post,
          class: 'btn btn-outline-primary',
          disabled: !%w{new_tournament accreditation_finished}.include?(@tournament.state) %>
    </div>

  </div>
</div>

<script>
function updateFileName(input) {
  const fileName = input.files[0]?.name || 'PDF oder Screenshot (PNG, JPG)';
  document.getElementById('selected-file-name').innerHTML = fileName + '<br><span class="text-sm text-blue-600">ğŸ’¡ Oder Datei hierher ziehen (z.B. aus E-Mail)</span>';
}

// Drag & Drop FunktionalitÃ¤t mit Browser-KompatibilitÃ¤t
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('upload-area');
  const dragOverlay = document.getElementById('drag-overlay');
  const fileInput = document.getElementById('invitation-upload');
  const form = document.getElementById('invitation-upload-form');

  if (!uploadArea || !fileInput) return;

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
    return false;
  }

  // Verhindere Standard-Verhalten auf der gesamten Seite
  // ABER: Lassen wir Drop-Events auf dem Upload-Bereich durchlaufen
  document.addEventListener('dragover', function(e) {
    // Nur verhindern wenn NICHT Ã¼ber Upload-Bereich
    if (!uploadArea.contains(e.target)) {
      preventDefaults(e);
    }
  }, false);

  document.addEventListener('drop', function(e) {
    // Nur verhindern wenn NICHT Ã¼ber Upload-Bereich
    if (!uploadArea.contains(e.target)) {
      preventDefaults(e);
    }
  }, false);

  // Highlight beim Drag Ã¼ber Upload-Bereich
  uploadArea.addEventListener('dragenter', function(e) {
    preventDefaults(e);
    dragOverlay.classList.remove('hidden');
    uploadArea.classList.add('border-blue-500');
    uploadArea.classList.add('bg-blue-50');
  }, false);

  uploadArea.addEventListener('dragover', function(e) {
    preventDefaults(e);
    // Setze dropEffect explizit auf 'copy' (verhindert 'link' oder 'move')
    if (e.dataTransfer) {
      try {
        e.dataTransfer.dropEffect = 'copy';
      } catch (err) {
        // Manche Browser unterstÃ¼tzen dropEffect nicht
        console.log('dropEffect nicht unterstÃ¼tzt:', err);
      }
    }
    dragOverlay.classList.remove('hidden');
    uploadArea.classList.add('border-blue-500');
    uploadArea.classList.add('bg-blue-50');
  }, false);

  uploadArea.addEventListener('dragleave', function(e) {
    preventDefaults(e);
    // Nur verstecken wenn wirklich auÃŸerhalb des Upload-Bereichs
    if (!uploadArea.contains(e.relatedTarget)) {
      dragOverlay.classList.add('hidden');
      uploadArea.classList.remove('border-blue-500');
      uploadArea.classList.remove('bg-blue-50');
    }
  }, false);

  // Hilfsfunktion zum Setzen der Datei ins Input-Feld
  function setFileToInput(file) {
    if (!file) {
      console.error('Keine Datei zum Setzen');
      return false;
    }

    // Methode 1: DataTransfer API (moderne Browser)
    try {
      if (typeof DataTransfer !== 'undefined') {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        console.log('Datei Ã¼ber DataTransfer API gesetzt:', file.name);
        return true;
      }
    } catch (error) {
      console.log('DataTransfer API fehlgeschlagen:', error);
    }

    // Methode 2: FileList direkt setzen (fÃ¼r Ã¤ltere Browser)
    try {
      // Erstelle eine FileList-Ã¤hnliche Struktur
      const fileList = {
        0: file,
        length: 1,
        item: function(index) { return index === 0 ? file : null; },
        namedItem: function(name) { return null; }
      };
      
      // Versuche files direkt zu setzen
      Object.defineProperty(fileInput, 'files', {
        value: fileList,
        writable: false,
        configurable: true
      });
      
      // Oder nutze die native FileList wenn verfÃ¼gbar
      if (fileInput.files && fileInput.files.length > 0) {
        console.log('Datei Ã¼ber FileList gesetzt (Fallback):', file.name);
        return true;
      }
    } catch (error) {
      console.log('FileList Fallback fehlgeschlagen:', error);
    }

    // Methode 3: Trigger change event manuell (letzter Versuch)
    try {
      // Erstelle ein neues File-Input Element
      const newInput = document.createElement('input');
      newInput.type = 'file';
      newInput.files = (function() {
        const dt = new DataTransfer();
        dt.items.add(file);
        return dt.files;
      })();
      
      // Kopiere files zum originalen Input
      fileInput.files = newInput.files;
      console.log('Datei Ã¼ber temporÃ¤res Input gesetzt:', file.name);
      
      // Trigger change event
      const event = new Event('change', { bubbles: true });
      fileInput.dispatchEvent(event);
      
      return true;
    } catch (error) {
      console.error('Alle Methoden fehlgeschlagen:', error);
      return false;
    }
  }

  // Datei-Drop verarbeiten
  uploadArea.addEventListener('drop', function(e) {
    preventDefaults(e);
    
    dragOverlay.classList.add('hidden');
    uploadArea.classList.remove('border-blue-500');
    uploadArea.classList.remove('bg-blue-50');
    
    const dt = e.dataTransfer;
    if (!dt) {
      console.error('DataTransfer nicht verfÃ¼gbar');
      alert('Browser unterstÃ¼tzt Drag & Drop nicht richtig. Bitte nutzen Sie die Dateiauswahl.');
      return;
    }

    let file = null;
    let filesFound = false;

    // Versuch 1: dt.files (Standard)
    const files = dt.files;
    if (files && files.length > 0) {
      file = files[0];
      filesFound = true;
      console.log('Datei Ã¼ber dt.files gefunden:', file.name, file.type, file.size);
    }

    // Versuch 2: dt.items API (Fallback fÃ¼r Ã¤ltere Browser)
    if (!filesFound) {
      const items = dt.items;
      if (items && items.length > 0) {
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.kind === 'file') {
            try {
              file = item.getAsFile();
              if (file) {
                filesFound = true;
                console.log('Datei Ã¼ber dt.items gefunden:', file.name);
                break;
              }
            } catch (error) {
              console.log('getAsFile() fehlgeschlagen:', error);
            }
          }
        }
      }
    }

    if (!file || !filesFound) {
      console.warn('Keine Dateien im DataTransfer gefunden');
      alert('Keine Datei erkannt. Bitte ziehen Sie eine Datei direkt (nicht einen Link) in den Upload-Bereich.');
      return;
    }

    // PrÃ¼fe Dateityp
    const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
    const fileType = file.type || '';
    const fileName = file.name.toLowerCase();
    
    const isValidType = validTypes.includes(fileType) || 
                        fileName.endsWith('.pdf') || 
                        fileName.endsWith('.png') || 
                        fileName.endsWith('.jpg') || 
                        fileName.endsWith('.jpeg');

    if (!isValidType) {
      alert('Bitte nur PDF, PNG oder JPEG Dateien hochladen!');
      return;
    }

    // Setze Datei ins Input-Feld
    const success = setFileToInput(file);
    
    if (success) {
      // Update Anzeige
      updateFileName(fileInput);
    } else {
      alert('Fehler beim Verarbeiten der Datei. Bitte versuchen Sie es erneut oder nutzen Sie die Dateiauswahl.');
    }
  }, false);
});
</script>

<style>
.upload-area:hover {
  background-color: #f8fafc;
}

#upload-area.drag-over {
  border-color: #3b82f6;
  background-color: #eff6ff;
}

#drag-overlay {
  pointer-events: none;
}
</style>

