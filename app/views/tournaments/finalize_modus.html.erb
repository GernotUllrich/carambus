<style>
    body {
        margin: 0;
        padding: 0;
    }

    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
    }

    th, td {
        padding: 8px;
    }
</style>
<%= render :partial => "show", locals: {tournament: @tournament, subtitle: I18n.t("tournaments.finalize_modus.final_modus_selection"), drop_details: true } %>

<div flex flex-wrap>
  <div class="container mx-auto my-8 px-4">
    <div class="max-w-3xl mx-auto">
      <h3><%= I18n.t("tournaments.finalize_modus.teilnehmer", count: @participant_count) %></h3>
      
      <% if @tournament.data['extracted_plan_info'].present? %>
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded">
          <h4 class="font-semibold text-green-900 mb-2">üìÑ Vorgaben aus Einladung:</h4>
          <p class="text-green-900">
            <strong><%= @tournament.data['extracted_plan_info'] %></strong>
          </p>
          <p class="text-xs text-green-700 mt-2">
            Diese Informationen wurden automatisch aus der hochgeladenen Einladung extrahiert.
          </p>
        </div>
      <% end %>
    </div>
  </div>
  <hr/>

  <% if @proposed_discipline_tournament_plan.present? %>
    <div class="container mx-auto my-8 px-4">
      <div class="max-w-3xl mx-auto">
        <div class="col-sm-9" style="margin-bottom: 10px; margin-left: 10px">
          <h4>
            <% if @tournament.data['extracted_plan_info'].present? %>
              <%= I18n.t("tournaments.finalize_modus.proposed_from_invitation") %>
            <% else %>
              <%= I18n.t("tournaments.finalize_modus.proposed_automatic") %>
            <% end %>
          </h4>
          
          <!-- Info: Gruppenbildung-Quelle -->
          <% if @groups_source == :extracted_matches_nbv %>
            <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-green-900 text-sm">
                    <strong>‚úÖ Gruppenbildung aus Einladung √ºbernommen</strong><br>
                    Die Zuordnung wurde automatisch extrahiert und ist <strong>identisch</strong> mit dem NBV-Standard-Algorithmus.
                  </p>
                </div>
                <div class="flex gap-2">
                  <%= button_to 'üîÑ Neu berechnen',
                      recalculate_groups_tournament_path(@tournament),
                      method: :post,
                      class: 'btn btn-sm btn-secondary',
                      data: { confirm: 'Extrahierte Gruppenbildung verwerfen und neu berechnen?' },
                      title: 'Verwirft Einladungs-Zuordnung und berechnet mit NBV-Algorithmus' %>
                </div>
              </div>
            </div>
          <% elsif @groups_source == :extracted_differs_from_nbv %>
            <div class="mb-4 p-4 bg-red-50 border-2 border-red-300 rounded">
              <p class="text-red-900 font-semibold mb-2">
                ‚ö†Ô∏è  WARNUNG: Abweichung vom NBV-Standard erkannt!
              </p>
              <p class="text-red-800 text-sm mb-3 max-w-4xl">
                Die Gruppenbildung in der Einladung <strong>unterscheidet sich</strong> vom berechneten Algorithmus.<br>
                <strong>Grund:</strong> Der NBV-Algorithmus f√ºr <%= @proposed_discipline_tournament_plan.name %> ist m√∂glicherweise noch nicht korrekt implementiert.
              </p>
              
              <div class="flex gap-2 mb-3">
                <%= button_to '‚úÖ Einladung verwenden (empfohlen)',
                    select_modus_tournament_path(@tournament, tournament_plan_id: @proposed_discipline_tournament_plan.id),
                    method: :post,
                    class: 'btn btn-sm btn-success',
                    data: { confirm: 'Gruppenbildung aus Einladung verwenden?\n\nDiese ist vom Landessportwart vorgegeben.' },
                    title: 'Verwendet die offizielle Gruppenbildung aus der Einladung' %>
                
                <%= button_to 'üîÑ Algorithmus verwenden (Risiko)',
                    recalculate_groups_tournament_path(@tournament),
                    method: :post,
                    class: 'btn btn-sm btn-outline-warning',
                    data: { confirm: 'ACHTUNG: Der Algorithmus k√∂nnte falsch sein!\n\nBesser die Einladung verwenden.' },
                    title: 'Verwendet berechneten Algorithmus (k√∂nnte von NBV-Vorgaben abweichen)' %>
              </div>
              
              <!-- Vergleich: Extrahiert vs. Berechnet -->
              <details class="bg-white p-3 rounded border border-red-200">
                <summary class="cursor-pointer font-semibold text-red-900">
                  üîç Vergleich anzeigen
                </summary>
                <div class="mt-3 grid grid-cols-2 gap-4">
                  <div>
                    <h5 class="font-bold text-green-900 mb-2">üìÑ Aus Einladung (NBV-Vorgabe):</h5>
                    <%= render partial: "groups", locals: {tournament_plan: @proposed_discipline_tournament_plan, groups: @extracted_groups} %>
                  </div>
                  <div>
                    <h5 class="font-bold text-orange-900 mb-2">ü§ñ Berechnet (vermutlich falsch):</h5>
                    <%= render partial: "groups", locals: {tournament_plan: @proposed_discipline_tournament_plan, groups: @nbv_groups} %>
                  </div>
                </div>
              </details>
            </div>
          <% elsif @groups_source == :algorithm %>
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-blue-900 text-sm">
                    <strong>ü§ñ Gruppenbildung automatisch berechnet (NBV-konform)</strong><br>
                    Die Zuordnung wurde nach NBV-Standard-Algorithmus berechnet.
                  </p>
                </div>
                <div>
                  <details class="inline-block">
                    <summary class="btn btn-sm btn-outline-secondary cursor-pointer">
                      ‚úèÔ∏è Manuell anpassen
                    </summary>
                    <div class="absolute z-10 mt-2 p-4 bg-white border border-gray-300 rounded shadow-lg" style="min-width: 300px;">
                      <p class="text-sm text-gray-700 mb-3">
                        <strong>"Auch der Landessportwart irrt manchmal" üòä</strong><br>
                        Sie k√∂nnen die Gruppenzuordnung manuell korrigieren.
                      </p>
                      <p class="text-xs text-gray-600 mb-3">
                        <strong>Hinweis:</strong> Diese Funktion ist in Entwicklung.<br>
                        Aktuell: Verwenden Sie 'üîÑ Neu berechnen' oder passen Sie die Setzliste in Schritt 3 an.
                      </p>
                      <button onclick="this.closest('details').open=false" class="btn btn-sm btn-secondary w-full">
                        Schlie√üen
                      </button>
                    </div>
                  </details>
                </div>
              </div>
            </div>
          <% end %>

          <div class="flex-col space-y-5  rounded shadow p-8">
            <h4><%= @proposed_discipline_tournament_plan.name %></h4>
            <div class="flex sm:flex-row flex-col">
              <div class="w-3/4">
                <p class="mb-2">
                  <%= @proposed_discipline_tournament_plan.rulesystem %>
                </p>
                <p class="mb-2">
                  <%= @proposed_discipline_tournament_plan.more_description %>
                </p>
                <p class="mb-2">
                  <%= @proposed_discipline_tournament_plan.even_more_description %>
                </p>
              </div>
              <div class="w-1/4">
                <%= button_to "#{I18n.t("tournaments.finalize_modus.continue_with")} #{@proposed_discipline_tournament_plan.name}", select_modus_tournament_path(@tournament, tournament_plan_id: @proposed_discipline_tournament_plan.id), method: :post, class: "btn btn-flat btn-primary" %>
              </div>
            </div>
            <div class="flex-1">
              <%= render partial: "groups", locals: {tournament_plan: @proposed_discipline_tournament_plan, groups: @groups} if @groups.present?%>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  <hr/>
  <div class="container mx-auto my-8 px-4">
    <div class="max-w-3xl mx-auto">
      <div class="col-sm-9" style="margin-bottom: 10px; margin-left: 10px">
        <h4><%= I18n.t("tournaments.finalize_modus.alternatives_same_discipline") %></h4>
        <% @alternatives_same_discipline.each do |alternative| %>
          <div class="flex-col space-y-5  rounded shadow p-8">
            <h4><%= alternative.name %></h4>
            <div class="flex  sm:flex-row flex-col">
              <div class="w-3/4">
                <%= alternative.rulesystem %><br/>
                <%= alternative.more_description %>
              </div>
              <div class="w-1/4">
                <%= button_to "#{I18n.t("tournaments.finalize_modus.continue_with")} #{alternative.name}", select_modus_tournament_path(@tournament, tournament_plan_id: alternative.id), method: :post, class: "btn btn-flat btn-primary" %>
              </div>
            </div>
            <div class="flex-1">
              <% @alternative_groups = TournamentMonitor.distribute_to_group(@tournament.seedings.where.not(state: "no_show").where(@seeding_scope).order(:position).map(&:player), alternative.ngroups) %>
              <%= render partial: "groups", locals: {tournament_plan: alternative, groups: @alternative_groups} %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <hr/>
  <div class="container mx-auto my-8 px-4">
    <div class="max-w-3xl mx-auto">
      <div class="col-sm-9" style="margin-bottom: 10px; margin-left: 10px">
        <h4><%= I18n.t("tournaments.finalize_modus.alternatives_other_disciplines") %></h4>
        <% @alternatives_other_disciplines.each do |alternative| %>
          <div class="flex-col space-y-5  rounded shadow p-8">
            <h4><%= alternative.name %></h4>
            <div class="flex  sm:flex-row flex-col">
              <div class="w-3/4">
                <%= alternative.rulesystem %><br/>
                <%= alternative.more_description %>
              </div>
              <div class="w-1/4">
                <%= button_to "#{I18n.t("tournaments.finalize_modus.continue_with")} #{alternative.name}", select_modus_tournament_path(@tournament, tournament_plan_id: alternative.id), method: :post, class: "btn btn-flat btn-primary" %>
              </div>
            </div>
            <div class="flex-1">
              <% @alternative_other_groups = TournamentMonitor.distribute_to_group(@tournament.seedings.where.not(state: "no_show").where("seedings.id >= #{Seeding::MIN_ID}").order(:position).map(&:player), alternative.ngroups) %>
              <%= render partial: "groups", locals: {tournament_plan: alternative, groups: @alternative_other_groups} %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%- if User::PRIVILEGED.include?(current_user&.email&.downcase) %>
  <%= button_to I18n.t("tournaments.show.debugging_force_reset_tournament_monitor"), reset_tournament_path(@tournament, force_reset: true), method: :post, class: "btn btn-flat btn-primary", style: "float: left; margin-right: 10px;" %>
<% end %>
