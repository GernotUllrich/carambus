<%# Tournament Status Overview - F√ºr alle sichtbar wenn Turnier l√§uft/abgeschlossen %>
<% tournament ||= @tournament %>
<% if tournament_active_or_finished?(tournament) && tournament.tournament_monitor.present? %>
  <div id="tournament-status-container-<%= tournament.id %>" class="tournament-status-container bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4 text-blue-900">
      üìä Turnier-Status: <%= tournament.title %>
    </h2>

    <% tournament_monitor = tournament.tournament_monitor %>
    
    <!-- Turnier-Phase -->
    <div class="mb-4">
      <h3 class="text-lg font-semibold text-blue-800 mb-2">Aktuelle Phase</h3>
      <div class="flex items-center gap-4">
        <span class="px-4 py-2 bg-blue-200 rounded-lg font-medium" id="tournament-phase-<%= tournament.id %>">
          <%= tournament_monitor.state.gsub("_", " ").humanize %>
        </span>
        <% current_round = tournament_current_round(tournament) %>
        <% if current_round %>
          <span class="text-blue-700" id="tournament-round-<%= tournament.id %>">
            Runde <%= current_round %>
          </span>
        <% end %>
      </div>
    </div>

    <!-- Spiele-Fortschritt -->
    <% games_progress = tournament_games_progress(tournament) %>
    <% if games_progress[:total] > 0 %>
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-blue-800 mb-2">Spiele-Fortschritt</h3>
        <div class="flex items-center gap-4">
          <div class="flex-1 bg-gray-200 rounded-full h-6">
            <div class="bg-blue-600 h-6 rounded-full" 
                 id="tournament-progress-bar-<%= tournament.id %>"
                 style="width: <%= (games_progress[:finished].to_f / games_progress[:total] * 100).round %>%"></div>
          </div>
          <span class="text-blue-700 font-medium" id="tournament-progress-text-<%= tournament.id %>">
            <%= games_progress[:finished] %> / <%= games_progress[:total] %> Spiele
          </span>
        </div>
      </div>
    <% end %>

    <!-- Aktuelle Spiele (vereinfacht) -->
    <% if tournament_monitor.state.in?(%w[playing_groups playing_finals]) %>
      <div class="mb-4" id="tournament-current-games-<%= tournament.id %>">
        <h3 class="text-lg font-semibold text-blue-800 mb-2">Aktuelle Spiele</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% 
            # Lade TableMonitors mit ihren Games und Players
            table_monitors = TableMonitor.includes(:table, :game => :game_participations)
                                         .where(tournament_monitor_id: tournament_monitor.id)
                                         .where.not(game_id: nil)
                                         .order("tables.name asc")
                                         .limit(6)
                                         .to_a  # Force load to ensure data is fresh
          %>
          <% if table_monitors.any? %>
            <% table_monitors.each do |tm| %>
              <% tm.reload if tm.data.blank? %>  <!-- Reload if data is missing -->
              <% if tm.game.present? && tm.data.present? %>
                <% player_a = tm.game.game_participations.where(role: "playera").first&.player %>
                <% player_b = tm.game.game_participations.where(role: "playerb").first&.player %>
                <% 
                  # Berechne aktuellen Stand: result + aktueller Inning-Stand
                  result_a = tm.data["playera"]&.dig("result").to_i || 0
                  result_b = tm.data["playerb"]&.dig("result").to_i || 0
                  current_inning_a = Array(tm.data["playera"]&.dig("innings_redo_list")).last.to_i || 0
                  current_inning_b = Array(tm.data["playerb"]&.dig("innings_redo_list")).last.to_i || 0
                  
                  # Wenn Spiel l√§uft, zeige result + aktueller Inning-Stand
                  if tm.playing?
                    total_a = result_a + current_inning_a
                    total_b = result_b + current_inning_b
                  else
                    total_a = result_a
                    total_b = result_b
                  end
                %>
                <div class="bg-white rounded-lg p-3 border border-blue-300">
                  <div class="text-sm text-blue-600 font-semibold mb-1">
                    <%= tm.display_name %> - <%= tm.game.display_gname %>
                  </div>
                  <div class="text-sm">
                    <div><strong><%= player_a&.fullname %></strong>: <%= total_a %><% if tm.playing? && current_inning_a > 0 %> (+<%= current_inning_a %>)<% end %></div>
                    <div><strong><%= player_b&.fullname %></strong>: <%= total_b %><% if tm.playing? && current_inning_b > 0 %> (+<%= current_inning_b %>)<% end %></div>
                  </div>
                  <% if tm.playing? %>
                    <div class="text-xs text-green-600 mt-1">‚ñ∂Ô∏è L√§uft</div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="col-span-full text-gray-500 text-sm">Keine aktiven Spiele</div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Links zu Tournament Monitor und Scoreboards -->
    <div class="mt-4 pt-4 border-t border-blue-300 flex flex-wrap gap-2">
      <% if defined?(current_user) && tournament_director?(current_user) %>
        <%= link_to 'üéÆ Tournament Monitor √∂ffnen', 
            tournament_monitor_path(tournament_monitor),
            class: 'btn btn-primary btn-lg',
            style: 'font-weight: bold;' %>
        <!-- Test-Button f√ºr Realtime Updates (nur wenn Route verf√ºgbar) -->
        <% begin %>
          <%= button_to 'üîÑ Test Update', 
              test_tournament_status_update_path(tournament),
              method: :post,
              class: 'btn btn-secondary btn-sm',
              remote: true,
              form: { data: { turbo: false } } %>
        <% rescue NoMethodError, ActionController::UrlGenerationError %>
          <!-- Route nicht verf√ºgbar (z.B. nach Deployment, Server muss neu gestartet werden) -->
        <% end %>
      <% end %>
      
      <% if tournament.location.present? %>
        <%= link_to 'üì∫ Scoreboards anzeigen (read-only)', 
            scoreboard_location_path(tournament.location.md5, sb_state: "tournament_scores"),
            data: { turbo: false },
            class: 'btn btn-secondary btn-lg',
            target: '_blank' %>
      <% end %>
    </div>

    <!-- Gruppen (falls vorhanden) -->
    <% groups = tournament_groups_for_status(tournament) %>
    <% if groups.present? && tournament.tournament_plan.present? %>
      <div class="mt-6 pt-4 border-t border-blue-300" id="tournament-groups-<%= tournament.id %>">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">Gruppen</h3>
        <%= render partial: "tournaments/groups", 
            locals: { tournament_plan: tournament.tournament_plan, groups: groups } %>
      </div>
    <% end %>

    <!-- Platzierungen (falls vorhanden) -->
    <% if tournament_monitor.data['rankings'].present? %>
      <div class="mt-6 pt-4 border-t border-blue-300" id="tournament-rankings-<%= tournament.id %>">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">Aktuelle Platzierungen</h3>
        <%= render partial: "tournament_monitors/rankings", 
            locals: { tournament_monitor: tournament_monitor, totals: true } %>
      </div>
    <% end %>

    <!-- Setzliste (read-only) -->
    <% 
      seeding_scope = tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? 
                      "seedings.id >= #{Seeding::MIN_ID}" : 
                      "seedings.id < #{Seeding::MIN_ID}"
    %>
    <div class="mt-6 pt-4 border-t border-blue-300" id="tournament-seedings-<%= tournament.id %>">
      <h3 class="text-lg font-semibold text-blue-800 mb-3">üìã Setzliste</h3>
      <div class="max-h-96 overflow-y-auto">
        <table class="w-full text-sm bg-white rounded-lg">
          <thead class="bg-blue-100 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left">Pos.</th>
              <th class="px-3 py-2 text-left">Spieler</th>
              <th class="px-3 py-2 text-left">Club</th>
              <% if tournament.handicap_tournier? %>
                <th class="px-3 py-2 text-center">Vorgabe (Ballziel)</th>
              <% else %>
                <th class="px-3 py-2 text-center">Ranking</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% tournament.seedings.where(seeding_scope).where.not(state: "no_show").includes(:player => :player_rankings).joins(:player).order("seedings.position").each do |seeding| %>
              <% club = tournament.season.season_participations.where("season_participations.player_id = ?", seeding.player.id).first&.club %>
              <tr class="border-b border-blue-100">
                <td class="px-3 py-2"><%= seeding.position %></td>
                <td class="px-3 py-2"><%= seeding.player.fullname %></td>
                <td class="px-3 py-2"><%= club&.shortname || "-" %></td>
                <td class="px-3 py-2 text-center">
                  <% if tournament.handicap_tournier? %>
                    <%= seeding.balls_goal %>
                  <% else %>
                    <% 
                      # Verwende effective_gd Logic f√ºr Rankings (neueste Saison mit GD > 0)
                      player_rankings = seeding.player.player_rankings.where(discipline_id: tournament.discipline_id)
                      ranking = nil
                      [0, -1, -2].each do |offset|
                        season = Season.find_by(ba_id: Season.current_season.ba_id + offset)
                        next unless season
                        pr = player_rankings.find_by(season_id: season.id)
                        if pr && pr.gd.to_f > 0
                          ranking = pr
                          break
                        end
                      end
                    %>
                    <%= ranking&.rank || "-" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Link zur Ranking-Tabelle -->
      <% if tournament.organizer.is_a?(Region) && tournament.discipline.present? %>
        <div class="mt-3 text-sm text-blue-700">
          üí° Alle Rankings: 
          <%= link_to "#{tournament.organizer.shortname} Rangliste #{tournament.discipline.name}", 
              ranking_path(tournament.organizer) + "#discipline-#{tournament.discipline_id}",
              class: 'text-blue-600 hover:text-blue-800 underline font-semibold',
              target: '_blank' %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  <!-- Platzhalter-Container damit Selector immer existiert -->
  <div id="tournament-status-container-<%= tournament.id %>"></div>
<% end %>
