<%= content_tag "div",
                "data-controller": "tournament",
                "data-tournament-id": @tournament.id,
                id: "tournament_#{@tournament.id}",
                class: "container mx-auto my-2 px-2" do %>
  <!-- Tournament Channel Subscription wird Ã¼ber JavaScript gehandhabt (tournament_channel.js) -->
  
  <!-- Tournament Details (collapsed in card) -->
  <div class="tournament-details-card">
    <%= render :partial => "show", locals: { tournament: @tournament, subtitle: "", show_edit_back: true } %>
  </div>

  <!-- Warnung wenn Turnier ClubCloud-Ergebnisse hat (schreibgeschÃ¼tzt) -->
  <% if @tournament.has_clubcloud_results? %>
    <div class="container mx-auto my-4 px-4">
      <div class="max-w-6xl mx-auto">
        <div class="bg-yellow-50 border border-yellow-400 rounded-lg p-4 mb-4">
          <div class="flex items-start">
            <span class="text-2xl mr-3">ðŸ”’</span>
            <div>
              <h3 class="font-semibold text-yellow-900 mb-1">Turnier ist schreibgeschÃ¼tzt</h3>
              <p class="text-yellow-800">
                Dieses Turnier hat bereits <strong>Ergebnisse aus der ClubCloud</strong> und kann nicht mehr bearbeitet werden. 
                Die ClubCloud ist die fÃ¼hrende Datenquelle fÃ¼r abgeschlossene Turniere.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- New Wizard UI (Version 2 mit Ã¼berarbeiteter Reihenfolge) - Nur fÃ¼r Spielleiter auf lokalen Servern ohne ClubCloud-Ergebnisse -->
  <% if tournament_director?(current_user) && local_server? && !@tournament.has_clubcloud_results? %>
    <%= render 'wizard_steps_v2', tournament: @tournament %>
  <% end %>

  <!-- Tournament Status Overview - FÃ¼r alle sichtbar wenn Turnier lÃ¤uft/abgeschlossen -->
  <!-- EnthÃ¤lt jetzt auch die Setzliste mit Rankings -->
  <%= render 'tournament_status', tournament: @tournament %>

  <% if !@tournament.has_clubcloud_results? %>
    <div class="seedings-table-container">
      <h2>
        <%= t("tournaments.show.clubcloud_registration_list.title") %>
        (<%= @clubcloud_seedings.count %>)
      </h2>
      <p class="text-gray-600 text-sm mb-4 dark:text-gray-300">
        <%= t("tournaments.show.clubcloud_registration_list.description") %>
      </p>
      <% if @tournament.source_url.present? %>
        <p class="text-sm mb-4">
          <%= link_to t("tournaments.show.clubcloud_registration_list.link_label"),
              @tournament.source_url,
              target: "_blank",
              rel: "noopener",
              class: "inline-flex items-center gap-1 text-blue-700 hover:text-blue-900 dark:text-blue-300 dark:hover:text-blue-100" %>
        </p>
      <% end %>

      <% if @clubcloud_seedings.any? %>
        <div class="bg-white/90 rounded shadow overflow-hidden ring-1 ring-slate-200 dark:bg-slate-900/90 dark:ring-slate-800">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100/80 border-b border-slate-200 text-slate-500 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400">
              <tr>
                <th class="p-3 text-left font-semibold"><%= t("tournaments.show.clubcloud_registration_list.table.order") %></th>
                <th class="p-3 text-left font-semibold"><%= t("tournaments.show.clubcloud_registration_list.table.name") %></th>
                <th class="p-3 text-left font-semibold"><%= t("tournaments.show.clubcloud_registration_list.table.club") %></th>
              </tr>
            </thead>
            <tbody>
              <% @clubcloud_seedings.each do |seeding| %>
                <% player = seeding.player %>
                <tr class="border-b border-slate-200 bg-white/80 odd:bg-gray-50 dark:border-slate-700 dark:bg-slate-950/60 dark:odd:bg-slate-900/70">
                  <td class="p-3 text-sm font-medium text-slate-900 dark:text-slate-200"><%= seeding.position.presence || "â€”" %></td>
                  <td class="p-3 text-sm text-slate-900 dark:text-slate-200"><%= player&.fullname.presence || t("tournaments.show.clubcloud_registration_list.unknown_player") %></td>
                  <td class="p-3 text-sm text-slate-900 dark:text-slate-200"><%= player&.club&.shortname.presence || "â€”" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 dark:bg-yellow-900/20 dark:border-yellow-500/70">
          <p class="text-sm text-yellow-800 dark:text-yellow-100">
            <%= t("tournaments.show.clubcloud_registration_list.empty") %>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%- seeding_scope = @tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? "seedings.id >= #{Seeding::MIN_ID}" : "seedings.id < #{Seeding::MIN_ID}" %>
  
  <!-- Rankings Section -->
  <div class="seedings-table-container">
    <h2><%= I18n.t("tournaments.show.rankings") %></h2>
      <div class="flex-1 flex-wrap space-y-5  rounded shadow p-8">
        <%- lists = @tournament.seedings.where(seeding_scope).joins(:player).order("players.lastname, players.firstname").map { |s| s.data["result"].keys rescue [] }.inject([]) { |a, memo| memo |= a; memo } %>
        <%- lists.each do |list| %>
          <div class="flex flex-col">
            <h3><%= list %></h3>
            <table class="flex-1">
              <thead>
              <tr>
                <%- @tournament.seedings.where(seeding_scope).select { |seeding| seeding.data["result"].andand[list].present? }.first.data["result"][list].keys.each do |k| %>
                  <%#- next if k == "Rank" %>
                  <th><%= k %></th>
                <%- end %>
              </tr>
              </thead>
              <tbody>
              <%- @tournament.seedings.where(seeding_scope).select do |seeding|
                seeding.data["result"].andand[list].present?
              end.sort_by do |seeding|
                if seeding.data["result"][list]["Rank"].present?
                  seeding.data["result"][list]["Rank"].to_i
                elsif seeding.data["result"][list]["Rang"].present?
                  seeding.data["result"][list]["Rang"].to_i
                end
              end.each do |seeding| %>
                <tr>
                  <%- seeding.data["result"][list].each do |k, v| %>
                    <%#- next if k == "Rank" %>
                    <td><%= v %></td>
                  <%- end %>
                </tr>
              <%- end %>
              </tbody>
            </table>
          </div>
        <%- end %>
      </div>
  </div>
  
  <!-- Games Section -->
  <%- game_scope = @tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? "games.id >= #{Game::MIN_ID}" : "games.id < #{Game::MIN_ID}" %>
  <div class="seedings-table-container">
    <h2><%= I18n.t("tournaments.show.games") %></h2>
      <div class="flex flex-wrap space-y-5  rounded shadow p-8">
        <%- if @tournament.games.where(game_scope).present? %>
          <table class="flex-1">
            <thead>
            <tr>
              <%- @tournament.games.where(game_scope).first.data.keys.each do |k| %>
                <th><%= k %></th>
              <%- end %>
            </tr>
            </thead>
            <tbody>
            <%- @tournament.games.where(game_scope).sort_by do |game|
              game.data["Partie"].to_i
            end.each do |game| %>
              <tr>
                <%- next unless (game.data["Ergebnis"].present? || game.data["Punkte"].present?) %>
                <%- skip = false %>
                <%- game.data.each do |k, v| %>
                  <%- skip = true if %w{Heim Gast}.include?(k) && v.blank? %>
                  <%- unless skip %>
                    <td><%= v %></td>
                  <%- end %>
                <%- end %>
              </tr>
            <%- end %>
            </tbody>
          </table>
        <%- end %>
      </div>
  </div>
  
  <!-- Admin Actions -->
  <% if local_server? %>
    <div class="admin-actions-container" style="margin-top: 2rem;">
      <%- games = @tournament.games.where(game_scope).order(seqno: :asc) %>
      
      <!-- Regular Admin Actions (only for tournaments without ClubCloud results) -->
      <% if !@tournament.has_clubcloud_results? %>
        <%- if !@tournament.tournament_started %>
          <%= button_to I18n.t("tournaments.show.reset_tournament_monitor"), reset_tournament_path(@tournament), method: :post, class: "btn btn-flat btn-primary", data: { confirm: 'Are you sure?' }, style: "float: left; margin-right: 10px;" %>
        <%- end %>
        <%- if (User::PRIVILEGED + [User.scoreboard.andand.email.andand.downcase]).include? current_user&.email&.downcase %>
          <%= button_to I18n.t("tournaments.show.debugging_force_reset_tournament_monitor"), reset_tournament_path(@tournament, force_reset: true), method: :post, class: "btn btn-flat btn-primary", style: "float: left; margin-right: 10px;" %>
        <% end %>
      <% end %>
      
      <!-- Sysadmin: Force Reload from API Server (for closed tournaments with results) -->
      <% if current_user&.privileged_access? %>
        <%= button_to I18n.t("tournaments.show.force_reload_from_api"), 
            reload_from_cc_tournament_path(@tournament, reload_games: true), 
            method: :post, 
            class: "btn btn-flat btn-warning", 
            data: { confirm: I18n.t("tournaments.show.force_reload_confirm") }, 
            style: "float: left; margin-right: 10px;" %>
      <% end %>
    </div>
  <% end %>
<% end %>
