<div data-controller="tournament" class="container mx-auto my-8 px-4">
  <div class="max-w-3xl mx-auto">
    <div class="flex-col justify-between items-center mb-4">
      <%- if @tournament.team_size > 1 %>
        <h1 class="h3"><%= @tournament.title %> - <%= @tournament.season.name %>
          - <%= @tournament.organizer.shortname %>
          <br/>Teamliste</h1>
        <table>
          <thead>
          <tr>
            <th>Team</th>
            <th>Teilnahme</th>
            <th>Punktziel bzw. Ranking</th>
          </tr>
          </thead>
          <tbody>
          <%= custom_link_to "zurÃ¼ck", @tournament %>
          <%- @tournament.teams.each do |team| %>
            <%- seeding = @tournament.seedings.where(player_id: team.id).first %>
            <tr>
              <td><%= team.fullname %></td>
              <%= content_tag "td", class: "w-1/4", style: "text-align: center" do %>
                <%= check_box_tag "participate-#{team.id}", "1", seeding.present?, data: { reflex: "change->TournamentReflex#change_seeding", id: @tournament.id } %></td>
              <%- end %>
              <%= content_tag "td", id: "balls-wrapper-#{team.id}", class: "w-1/4", style: "text-align: right" do %>
                <%= number_field_tag("balls-#{team.id}", seeding.andand.balls_goal, data: { reflex: "change->TournamentReflex#change_point_goal", id: @tournament.id }, style: "#{seeding.present? ? "" : "display: none"}") %>
              <%- end %>
            </tr>
          <% end %>
          </tbody>
        </table>
        <%= custom_link_to "Neues Team", new_team_tournament_path %>
      <%- else %>
        <%- # Berechne Rankings basierend auf effective_gd (wie in rankings_controller.rb) %>
        <%- current_season = Season.current_season %>
        <%- seasons = Season.where('id <= ?', current_season.id).order(id: :desc).limit(3).reverse %>
        
        <%- # Lade alle Rankings fÃ¼r die Disziplin und Region %>
        <%- if @tournament.organizer.is_a?(Region) %>
          <%- all_rankings = PlayerRanking.joins(:player)
                                          .where(season_id: seasons.pluck(:id), 
                                                 discipline_id: @tournament.discipline_id,
                                                 region_id: @tournament.organizer_id)
                                          .to_a %>
          <%- # Gruppiere nach Spieler %>
          <%- rankings_by_player = all_rankings.group_by(&:player_id) %>
          
          <%- # Berechne effective_gd fÃ¼r jeden Spieler (neueste Saison zuerst) %>
          <%- player_effective_gd = {} %>
          <%- rankings_by_player.each do |player_id, rankings| %>
            <%- gd_values = seasons.map do |season| %>
              <%- ranking = rankings.find { |r| r.season_id == season.id } %>
              <%- ranking&.gd %>
            <%- end %>
            <%- # effective_gd = aktuellste Saison || Saison davor || Saison davor-1 %>
            <%- effective_gd = gd_values[2] || gd_values[1] || gd_values[0] %>
            <%- player_effective_gd[player_id] = effective_gd if effective_gd.present? %>
          <%- end %>
          
          <%- # Sortiere Spieler nach effective_gd (absteigend) und ermittle Rang %>
          <%- sorted_players = player_effective_gd.sort_by { |player_id, gd| -gd } %>
          <%- player_rank = {} %>
          <%- sorted_players.each_with_index do |(player_id, gd), index| %>
            <%- player_rank[player_id] = index + 1 %>
          <%- end %>
        <%- else %>
          <%- player_rank = {} %>
        <%- end %>
        
        <div class="flex items-center justify-between mb-4">
          <h1 class="h3"><%= @tournament.title %> - <%= @tournament.season.name %>
            - <%= @tournament.organizer.shortname %>
            - Teilnehmerliste</h1>
          <%= custom_link_to "zurÃ¼ck", @tournament %>
        </div>
        
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded">
          <h4 class="font-semibold text-green-900 mb-2">ğŸ“ Teilnehmerliste bearbeiten</h4>
          <ul class="list-disc list-inside text-green-800 text-sm space-y-1">
            <li>âœ“ Haken setzen/entfernen = Spieler als Teilnehmer markieren/streichen</li>
            <li><% if @tournament.handicap_tournier %>âœ“ Vorgaben (Punktziel) anpassen falls nÃ¶tig<% else %>âœ“ Ã„nderungen werden sofort gespeichert<% end %></li>
            <li>ğŸ”¢ <strong>Setzreihenfolge Ã¤ndern:</strong> Neue Position direkt eingeben ODER Pfeile â¬†ï¸â¬‡ï¸ klicken</li>
            <li>ğŸ“Š <strong>Ranking-Spalte:</strong> Zeigt aktuelles Carambus-Ranking fÃ¼r <%= @tournament.discipline.name %> (letzten 2-3 Saisons), klickbar zur Rangliste</li>
            <li>â• Kurzfristig nachmelden? Checkbox aktivieren!</li>
          </ul>
        </div>
        
        <table class="w-full">
          <thead>
          <tr>
            <th class="w-16">Pos.</th>
            <th class="w-20">Neue Pos.</th>
            <th class="w-24">Reihenfolge</th>
            <th>Name</th>
            <th class="w-20 text-center">Ranking</th>
            <th class="w-32 text-center">Teilnehmer</th>
            <th class="w-32 text-right"><% if @tournament.handicap_tournier %>Vorgabe (Pkt)<% else %>Punktziel<% end %></th>
          </tr>
          </thead>
          <tbody>
          <%- seeding_scope = @tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? "seedings.id >= #{Seeding::MIN_ID}" : "seedings.id < #{Seeding::MIN_ID}" %>
          <%- active_seedings = @tournament.seedings.where(seeding_scope).to_a %>
          
          <%# Sortiere und aktualisiere Positionen NUR wenn keine Einladung hochgeladen wurde %>
          <%- if @tournament.data['invitation_filename'].blank? %>
            <%# Sortiere Seedings nach berechnetem Ranking (falls vorhanden), sonst 999 %>
            <%- active_seedings.sort_by! do |seeding| %>
              <%- rank = player_rank[seeding.player_id] %>
              <%- rank.present? ? rank : 999 %>
            <%- end %>
            
            <%# Aktualisiere Positionen basierend auf Ranking-Sortierung %>
            <%- active_seedings.each_with_index do |seeding, index| %>
              <%- if seeding.position != (index + 1) %>
                <%- seeding.update_column(:position, index + 1) %>
              <%- end %>
            <%- end %>
          <%- else %>
            <%# Mit Einladung: Sortiere nach Position aus der Einladung %>
            <%- active_seedings.sort_by! { |s| s.position || 999 } %>
          <%- end %>
          
          <%# Zeige aktive Seedings (sortiert nach position) %>
          <%- active_seedings.each_with_index do |seeding, index| %>
            <%- player = seeding.player %>
            <%- prev_seeding = index > 0 ? active_seedings[index - 1] : nil %>
            <%- next_seeding = index < active_seedings.length - 1 ? active_seedings[index + 1] : nil %>
            <%- rank = player_rank[player.id] %>
            <%- player_region = @tournament.organizer.is_a?(Region) ? @tournament.organizer : player.player_rankings.where(discipline_id: @tournament.discipline_id, season_id: seasons.pluck(:id)).first&.region %>
            <tr data-seeding-id="<%= seeding.id %>" class="<%= seeding.state == 'no_show' ? 'opacity-50' : '' %>">
              <td class="text-center font-semibold"><%= seeding.position || (index + 1) %></td>
              <td class="text-center">
                <%= number_field_tag "new_position-#{player.id}", nil, 
                    placeholder: seeding.position,
                    style: "width:60px", 
                    min: 1,
                    max: active_seedings.length,
                    class: "text-center",
                    data: { reflex: "change->TournamentReflex#change_position", id: @tournament.id } %>
              </td>
              <td class="text-center">
                <div class="flex flex-col gap-1">
                  <% if prev_seeding.present? %>
                    <button class="btn btn-xs btn-outline-secondary" 
                            title="Nach oben"
                            data-reflex="click->TournamentReflex#move_up"
                            data-tournament-id="<%= @tournament.id %>"
                            data-seeding-id="<%= seeding.id %>">
                      â†‘
                    </button>
                  <% else %>
                    <span class="btn btn-xs btn-disabled opacity-50 cursor-not-allowed" title="Bereits oben">â†‘</span>
                  <% end %>
                  <% if next_seeding.present? %>
                    <button class="btn btn-xs btn-outline-secondary" 
                            title="Nach unten"
                            data-reflex="click->TournamentReflex#move_down"
                            data-tournament-id="<%= @tournament.id %>"
                            data-seeding-id="<%= seeding.id %>">
                      â†“
                    </button>
                  <% else %>
                    <span class="btn btn-xs btn-disabled opacity-50 cursor-not-allowed" title="Bereits unten">â†“</span>
                  <% end %>
                </div>
              </td>
              <td><%= player.fullname %></td>
              <td class="text-center">
                <% if rank.present? && player_region.present? %>
                  <%= link_to rank, 
                      ranking_path(player_region) + "#discipline-#{@tournament.discipline_id}",
                      class: 'text-blue-600 hover:text-blue-800 underline',
                      title: "Rang #{rank} in #{@tournament.discipline.name} (#{player_region.shortname})",
                      target: '_blank' %>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="text-center">
                <%= check_box_tag "participate-#{player.id}", "1", seeding.present? && seeding.state != 'no_show', 
                    data: { reflex: "change->TournamentReflex#change_seeding", id: @tournament.id } %>
              </td>
              <td class="text-right" id="balls-wrapper-<%= player.id %>">
                <%= number_field_tag("balls-#{player.id}", seeding.balls_goal, 
                    data: { reflex: "change->TournamentReflex#change_point_goal", id: @tournament.id }, 
                    style: seeding.present? && seeding.state != 'no_show' ? "" : "display: none",
                    class: "w-20 text-right") %>
              </td>
            </tr>
          <% end %>
          
          <%# Zeige Spieler ohne Seeding (falls vorhanden) %>
          <%- seeding_scope = @tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? "seedings.id >= #{Seeding::MIN_ID}" : "seedings.id < #{Seeding::MIN_ID}" %>
          <%- players_with_seedings = active_seedings.map(&:player_id).to_set %>
          <%- players = @tournament.organizer.is_a?(Region) ? Player.all.joins(:seedings).where(seedings: { tournament_id: @tournament.id }).where(seeding_scope) : @tournament.organizer.season_participations.where(season: Season.current_season).map(&:player).compact %>
          <%- club_players = players.uniq.reject { |p| players_with_seedings.include?(p.id) }.sort_by { |player| player.fl_name }.to_a %>
          <%- guest_players = @tournament.organizer.is_a?(Region) ? [] : @tournament.organizer.players.where(guest: true).order(:lastname).to_a.reject { |p| players_with_seedings.include?(p.id) } %>
          
          <%- (club_players + guest_players).each do |player| %>
            <%- rank = player_rank[player.id] %>
            <%- player_region = @tournament.organizer.is_a?(Region) ? @tournament.organizer : player.player_rankings.where(discipline_id: @tournament.discipline_id, season_id: seasons.pluck(:id)).first&.region %>
            <tr>
              <td class="text-center text-gray-400">-</td>
              <td></td>
              <td></td>
              <td class="text-gray-500"><%= player.fullname %></td>
              <td class="text-center">
                <% if rank.present? && player_region.present? %>
                  <%= link_to rank, 
                      ranking_path(player_region) + "#discipline-#{@tournament.discipline_id}",
                      class: 'text-blue-600 hover:text-blue-800 underline text-sm',
                      title: "Rang #{rank} in #{@tournament.discipline.name} (#{player_region.shortname})",
                      target: '_blank' %>
                <% else %>
                  <span class="text-gray-400 text-sm">-</span>
                <% end %>
              </td>
              <td class="text-center">
                <%= check_box_tag "participate-#{player.id}", "1", false, 
                    data: { reflex: "change->TournamentReflex#change_seeding", id: @tournament.id } %>
              </td>
              <td class="text-right" id="balls-wrapper-<%= player.id %>">
                <%= number_field_tag("balls-#{player.id}", nil, 
                    data: { reflex: "change->TournamentReflex#change_point_goal", id: @tournament.id }, 
                    style: "display: none",
                    class: "w-20 text-right") %>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
        
        <!-- TurnierplÃ¤ne und Gruppenzuordnungen Vorschau -->
        <% if @participant_count > 0 && @proposed_discipline_tournament_plan.present? %>
          <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded">
            <h4 class="font-semibold text-blue-900 mb-3">
              ğŸ“Š MÃ¶gliche TurnierplÃ¤ne fÃ¼r <%= @participant_count %> Teilnehmer
            </h4>
            
            <!-- Vorgeschlagener Plan (aus Einladung oder automatisch) -->
            <div class="mb-4 p-3 bg-white border border-blue-300 rounded">
              <div class="flex items-center justify-between mb-2">
                <div class="flex-1">
                  <% if @tournament.data['extracted_plan_info'].present? %>
                    <span class="text-sm font-semibold text-green-700">ğŸ“„ Aus Einladung:</span>
                  <% else %>
                    <span class="text-sm font-semibold text-blue-700">ğŸ¤– Automatisch vorgeschlagen:</span>
                  <% end %>
                  <span class="text-sm font-bold ml-2"><%= @proposed_discipline_tournament_plan.name %></span>
                  <% if @groups_source == :extracted_differs_from_nbv %>
                    <span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded">âš ï¸ Weicht von NBV ab</span>
                  <% elsif @groups_source == :extracted_matches_nbv %>
                    <span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded">âœ“ NBV-konform</span>
                  <% end %>
                </div>
                <% rounds = @proposed_discipline_tournament_plan.rounds_count %>
                <% if rounds.present? %>
                  <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded ml-2">
                    <%= rounds %> Runde<%= rounds > 1 ? 'n' : '' %>
                  </span>
                <% end %>
              </div>
              <p class="text-xs text-gray-600 mb-2"><%= @proposed_discipline_tournament_plan.rulesystem %></p>
              <%= render partial: "groups_compact", locals: { tournament_plan: @proposed_discipline_tournament_plan, groups: @groups } %>
            </div>
            
            <!-- Alternative PlÃ¤ne (gleiche Disziplin) -->
            <% if @alternatives_same_discipline.any? %>
              <details class="text-sm mb-3">
                <summary class="cursor-pointer text-blue-800 hover:text-blue-900 font-semibold">
                  ğŸ”„ <%= @alternatives_same_discipline.count %> Alternative Plan<%= @alternatives_same_discipline.count > 1 ? 'e' : '' %> (<%= @tournament.discipline.name %>) anzeigen
                </summary>
                <div class="mt-3 space-y-2">
                  <% @alternatives_same_discipline.each do |alternative| %>
                    <div class="p-3 bg-white border border-gray-300 rounded">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex-1">
                          <span class="text-sm font-bold"><%= alternative.name %></span>
                          <span class="text-xs text-gray-500 ml-2"><%= alternative.rulesystem %></span>
                        </div>
                        <% rounds = alternative.rounds_count %>
                        <% if rounds.present? %>
                          <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded ml-2">
                            <%= rounds %> Runde<%= rounds > 1 ? 'n' : '' %>
                          </span>
                        <% end %>
                      </div>
                      <% alternative_groups = TournamentMonitor.distribute_to_group(
                           @tournament.seedings.where.not(state: "no_show").where(@seeding_scope).order(:position).map(&:player), 
                           alternative.ngroups, 
                           alternative.group_sizes) %>
                      <%= render partial: "groups_compact", locals: { tournament_plan: alternative, groups: alternative_groups } %>
                    </div>
                  <% end %>
                </div>
              </details>
            <% end %>
            
            <!-- Weitere PlÃ¤ne (andere Disziplinen, Jeder-gegen-Jeden, KO) -->
            <% if @alternatives_other_disciplines.any? %>
              <details class="text-sm">
                <summary class="cursor-pointer text-gray-700 hover:text-gray-900 font-semibold">
                  âš™ï¸ <%= @alternatives_other_disciplines.count %> Weitere Plan<%= @alternatives_other_disciplines.count > 1 ? 'e' : '' %> anzeigen
                  <% if @participant_count <= 6 %>
                    <span class="ml-1 text-green-700">(inkl. "Jeder gegen Jeden")</span>
                  <% end %>
                </summary>
                <div class="mt-3 space-y-2">
                  <% @alternatives_other_disciplines.each do |alternative| %>
                    <% is_round_robin = alternative.name =~ /jeder.*gegen.*jeden/i || alternative.name =~ /round.*robin/i || alternative.name == "Jgj#{@participant_count}" %>
                    <div class="p-3 bg-white border <%= is_round_robin ? 'border-green-300 bg-green-50' : 'border-gray-300' %> rounded">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex-1">
                          <% if is_round_robin %>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded mr-2">ğŸ¯ Jeder gegen Jeden</span>
                          <% end %>
                          <span class="text-sm font-bold"><%= alternative.name %></span>
                          <span class="text-xs text-gray-500 ml-2"><%= alternative.rulesystem %></span>
                        </div>
                        <% rounds = alternative.rounds_count %>
                        <% if rounds.present? %>
                          <span class="text-xs <%= is_round_robin ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700' %> px-2 py-1 rounded ml-2">
                            <%= rounds %> Runde<%= rounds > 1 ? 'n' : '' %>
                          </span>
                        <% end %>
                      </div>
                      <% alternative_groups = TournamentMonitor.distribute_to_group(
                           @tournament.seedings.where.not(state: "no_show").where(@seeding_scope).order(:position).map(&:player), 
                           alternative.ngroups, 
                           alternative.group_sizes) %>
                      <%= render partial: "groups_compact", locals: { tournament_plan: alternative, groups: alternative_groups } %>
                    </div>
                  <% end %>
                </div>
              </details>
            <% end %>
            
            <div class="text-xs text-blue-700 mt-3 space-y-1">
              <p>ğŸ’¡ Die Gruppenzuordnungen Ã¤ndern sich automatisch, wenn Sie die Teilnehmerliste bearbeiten.</p>
              <% if @alternatives_other_disciplines.any? %>
                <p class="text-gray-600">
                  â„¹ï¸ Alternative PlÃ¤ne kÃ¶nnen ggf. mit reduziertem Ausspielziel arbeiten (z.B. 25% weniger Aufnahmen/Punkte), 
                  um die Gesamtdauer zu verkÃ¼rzen. Rundenzahl und durchschnittliche Spieldauer beachten.
                </p>
              <% end %>
            </div>
          </div>
        <% elsif @participant_count > 0 %>
          <div class="mt-6 p-4 bg-gray-50 border border-gray-300 rounded">
            <p class="text-sm text-gray-700">
              â„¹ï¸  FÃ¼r <%= @participant_count %> Teilnehmer ist aktuell kein Turnierplan fÃ¼r <%= @tournament.discipline.name %> hinterlegt.
            </p>
          </div>
        <% end %>
        
        <!-- Spieler hinzufÃ¼gen (kurzfristige Nachmeldung) -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
          <h4 class="font-semibold text-yellow-900 mb-2">â• Kurzfristiger Nachmelder?</h4>
          <p class="text-sm text-yellow-800 mb-3">
            Spieler mit <strong>DBU-Nummer</strong> hinzufÃ¼gen (wird automatisch zur Liste hinzugefÃ¼gt):
          </p>
          
          <%= form_with url: add_player_by_dbu_tournament_path(@tournament), method: :post, local: true, class: 'flex gap-2 items-start' do |f| %>
            <div class="flex-1">
              <%= text_field_tag :dbu_nr, nil, 
                  placeholder: "DBU-Nummer eingeben (z.B. 12345)",
                  class: 'form-control',
                  pattern: '\d+',
                  required: true %>
              <p class="text-xs text-yellow-700 mt-1">
                ğŸ’¡ Mit DBU-Nummer: Spieler eindeutig identifiziert (empfohlen)
              </p>
            </div>
            <%= f.submit 'Spieler hinzufÃ¼gen', 
                class: 'btn btn-sm btn-warning',
                data: { disable_with: 'Wird gesucht...' } %>
          <% end %>
          
          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-yellow-800 font-semibold">
              âš ï¸ Spieler ohne DBU-Nummer? (Klicken fÃ¼r Info)
            </summary>
            <div class="mt-2 p-3 bg-yellow-100 rounded text-sm text-yellow-900">
              <p class="font-semibold mb-2">Spieler ohne DBU-Nummer kÃ¶nnen nicht nachgemeldet werden.</p>
              <p>
                <strong>Grund:</strong> In der ClubCloud kÃ¶nnen nur Spieler mit DBU-Nummer eingetragen werden.
              </p>
              <p class="mt-2">
                <strong>LÃ¶sung:</strong> 
                <ol class="list-decimal list-inside ml-2 mt-1">
                  <li>Spieler muss DBU-Nummer beantragen</li>
                  <li>Oder: Turnierleiter trÃ¤gt Spieler als Gast ein (kontaktieren Sie den Landessportwart)</li>
                </ol>
              </p>
            </div>
          </details>
        </div>
      <%- end %>
      
      <!-- Info-Box und Navigation -->
      <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-semibold text-blue-900">ğŸ’¡ Wichtig</h4>
            <p class="text-sm text-blue-800">
              âœ“ Alle Ã„nderungen (Checkboxen, Vorgaben) werden <strong>sofort gespeichert</strong><br>
              âœ“ Sie kÃ¶nnen jederzeit hierher zurÃ¼ckkehren um weitere Anpassungen vorzunehmen
            </p>
            <p class="text-sm text-blue-900 mt-3 font-semibold bg-blue-100 p-2 rounded">
              â­ï¸ Wenn Sie fertig sind: Gehen Sie zurÃ¼ck zum Wizard und klicken Sie <strong>Schritt 4: Teilnehmerliste finalisieren</strong>
            </p>
          </div>
          <%= link_to 'â† ZurÃ¼ck zum Wizard', tournament_path(@tournament), 
              class: 'btn btn-secondary' %>
        </div>
      </div>
    </div>
  </div>
</div>
