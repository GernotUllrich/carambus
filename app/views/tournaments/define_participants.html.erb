<div data-controller="tournament" class="container mx-auto my-8 px-4">
  <div class="max-w-3xl mx-auto">
    <div class="flex-col justify-between items-center mb-4">
      <%- if @tournament.team_size > 1 %>
        <h1 class="h3"><%= @tournament.title %> - <%= @tournament.season.name %>
          - <%= @tournament.organizer.shortname %>
          <br/>Teamliste</h1>
        <table>
          <thead>
          <tr>
            <th>Team</th>
            <th>Teilnahme</th>
            <th>Punktziel bzw. Ranking</th>
          </tr>
          </thead>
          <tbody>
          <%= custom_link_to "zurÃ¼ck", @tournament %>
          <%- @tournament.teams.each do |team| %>
            <%- seeding = @tournament.seedings.where(player_id: team.id).first %>
            <tr>
              <td><%= team.fullname %></td>
              <%= content_tag "td", class: "w-1/4", style: "text-align: center" do %>
                <%= check_box_tag "participate-#{team.id}", "1", seeding.present?, data: { reflex: "change->TournamentReflex#change_seeding", id: @tournament.id } %></td>
              <%- end %>
              <%= content_tag "td", id: "balls-wrapper-#{team.id}", class: "w-1/4", style: "text-align: right" do %>
                <%= number_field_tag("balls-#{team.id}", seeding.andand.balls_goal, data: { reflex: "change->TournamentReflex#change_point_goal", id: @tournament.id }, style: "#{seeding.present? ? "" : "display: none"}") %>
              <%- end %>
            </tr>
          <% end %>
          </tbody>
        </table>
        <%= custom_link_to "Neues Team", new_team_tournament_path %>
      <%- else %>
        <div class="flex items-center justify-between mb-4">
          <h1 class="h3"><%= @tournament.title %> - <%= @tournament.season.name %>
            - <%= @tournament.organizer.shortname %>
            - Teilnehmerliste</h1>
          <%= custom_link_to "zurÃ¼ck", @tournament %>
        </div>
        
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded">
          <h4 class="font-semibold text-green-900 mb-2">ğŸ“ Teilnehmerliste bearbeiten</h4>
          <ul class="list-disc list-inside text-green-800 text-sm space-y-1">
            <li>âœ“ Haken setzen/entfernen = Spieler als Teilnehmer markieren/streichen</li>
            <li><% if @tournament.handicap_tournier %>âœ“ Vorgaben (Punktziel) anpassen falls nÃ¶tig<% else %>âœ“ Ã„nderungen werden sofort gespeichert<% end %></li>
            <li>â• Kurzfristig nachmelden? Checkbox aktivieren!</li>
          </ul>
        </div>
        
        <table>
          <thead>
          <tr>
            <th>Name</th>
            <th>Teilnehmer</th>
            <th><% if @tournament.handicap_tournier %>Vorgabe (Pkt)<% else %>Punktziel<% end %></th>
          </tr>
          </thead>
          <tbody>
          <%- seeding_scope = @tournament.seedings.where("seedings.id >= #{Seeding::MIN_ID}").count > 0 ? "seedings.id >= #{Seeding::MIN_ID}" : "seedings.id < #{Seeding::MIN_ID}" %>
          <%- players = @tournament.organizer.is_a?(Region) ? Player.all.joins(:seedings).where(seedings: { tournament_id: @tournament.id }).where(seeding_scope) : @tournament.organizer.season_participations.where(season: Season.current_season).map(&:player).compact %>
          <%- club_players = players.uniq.sort_by { |player| player.fl_name }.to_a %>
          <%- guest_players = @tournament.organizer.is_a?(Region) ? [] : @tournament.organizer.players.where(guest: true).order(:lastname).to_a %>
          <%# TODO - seedings on club tournaments not finalized !!%>
          <%- (club_players + guest_players).each do |player| %>
            <%- seeding = @tournament.seedings.where(seeding_scope).where(player_id: player.id).first %>
            <tr>
              <td><%= player.fullname %></td>
              <%= content_tag "td", class: "w-1/4", style: "text-align: center" do %>
                <%= check_box_tag "participate-#{player.id}", "1", seeding.present?, data: { reflex: "change->TournamentReflex#change_seeding", id: @tournament.id } %></td>
              <%- end %>
              <%= content_tag "td", id: "balls-wrapper-#{player.id}", class: "w-1/4", style: "text-align: right" do %>
                <%= number_field_tag("balls-#{player.id}", seeding.andand.balls_goal, data: { reflex: "change->TournamentReflex#change_point_goal", id: @tournament.id }, style: "#{seeding.present? ? "" : "display: none"}") %>
              <%- end %>
            </tr>
          <% end %>
          </tbody>
        </table>
        
        <!-- Spieler hinzufÃ¼gen (kurzfristige Nachmeldung) -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
          <h4 class="font-semibold text-yellow-900 mb-2">â• Kurzfristiger Nachmelder?</h4>
          <p class="text-sm text-yellow-800 mb-3">
            Wenn ein Spieler nicht in der Liste ist, kÃ¶nnen Sie ihn manuell hinzufÃ¼gen:
          </p>
          <div class="flex gap-2 items-center">
            <input type="text" 
                   id="player-search" 
                   placeholder="Spielername suchen..."
                   class="form-control flex-1"
                   data-controller="player-search"
                   data-action="input->player-search#search">
            <button type="button" class="btn btn-sm btn-secondary" onclick="showPlayerAddHelp()">
              ğŸ’¡ Hilfe
            </button>
          </div>
          <div id="player-search-results" class="mt-2 hidden">
            <!-- Ajax results will appear here -->
          </div>
          <div id="player-add-help" class="mt-3 text-sm text-yellow-700 hidden">
            <strong>So geht's:</strong>
            <ol class="list-decimal list-inside mt-1">
              <li>Name eingeben â†’ Spieler wird gesucht</li>
              <li>Spieler auswÃ¤hlen â†’ Wird zur Liste hinzugefÃ¼gt</li>
              <li>Checkbox aktivieren â†’ Als Teilnehmer markieren</li>
              <li><% if @tournament.handicap_tournier %>Vorgabe eintragen<% else %>Punktziel setzen (falls benÃ¶tigt)<% end %></li>
            </ol>
            <p class="mt-2 italic">
              Hinweis: Kurzfristige Nachmelder werden automatisch <strong>ans Ende der Setzliste</strong> angehÃ¤ngt.
            </p>
          </div>
        </div>
        
        <script>
        function showPlayerAddHelp() {
          const help = document.getElementById('player-add-help');
          help.classList.toggle('hidden');
        }
        
        // TODO: Implement player search with Stimulus
        // For now, show info that feature is in development
        document.getElementById('player-search')?.addEventListener('focus', function() {
          alert('Spieler-Suche: In Entwicklung\n\nAktuell: Nur Spieler aus der Meldeliste kÃ¶nnen aktiviert/deaktiviert werden.\n\nFÃ¼r neue Spieler: Bitte zunÃ¤chst in Schritt 1 die Meldeliste aktualisieren.');
        });
        </script>
      <%- end %>
      
      <!-- Info-Box und Navigation -->
      <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-semibold text-blue-900">ğŸ’¡ Wichtig</h4>
            <p class="text-sm text-blue-800">
              âœ“ Alle Ã„nderungen (Checkboxen, Vorgaben) werden <strong>sofort gespeichert</strong><br>
              âœ“ Sie kÃ¶nnen jederzeit hierher zurÃ¼ckkehren um weitere Anpassungen vorzunehmen
            </p>
            <p class="text-sm text-blue-900 mt-3 font-semibold bg-blue-100 p-2 rounded">
              â­ï¸ Wenn Sie fertig sind: Gehen Sie zurÃ¼ck zum Wizard und klicken Sie <strong>Schritt 4: Teilnehmerliste finalisieren</strong>
            </p>
          </div>
          <%= link_to 'â† ZurÃ¼ck zum Wizard', tournament_path(@tournament), 
              class: 'btn btn-secondary' %>
        </div>
      </div>
    </div>
  </div>
</div>
