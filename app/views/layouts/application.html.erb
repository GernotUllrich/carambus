<!DOCTYPE html>
<!--TODO JS current_user-->
<html lang="en" class="<%= current_user&.prefers_dark_mode? ? 'dark' : 'light' %>">
<head>
  <title>
    <% if content_for?(:title) %>
      <%= yield :title %> |
    <% end %>
    <%= Carambus.config.application_name %>
  </title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= viewport_meta_tag %>
  <% if current_user&.system_theme? %>
    <script>document.documentElement.classList.toggle("dark", window.matchMedia('(prefers-color-scheme: dark)').matches)</script>
  <% end %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  <%= stylesheet_link_tag "application", media: "all", "data-turbo-track": "reload" %>
  <%# Be sure to add your own custom favicons %>
  <%= render "favicons" %>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <%= yield :head %>
  <% if Rails.env.production? %>
    <style nonce="<%= content_security_policy_nonce %>">
        /* Production styles */
    </style>
  <% else %>
    <style>
        /* Development styles without nonce */
    </style>
  <% end %>
  <script>
    (function () {
      const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const isMobile = window.innerWidth < 768;

      if (isMobile || isSidebarCollapsed) {
        document.documentElement.classList.add('sidebar-collapsed');
      }

      // Add resize listener to handle mobile transitions
      window.addEventListener('resize', function() {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          document.documentElement.classList.add('sidebar-collapsed');
        } else if (!localStorage.getItem('sidebarCollapsed')) {
          document.documentElement.classList.remove('sidebar-collapsed');
        }
      });
    })();
  </script>

  <style>
      /* Initial states */
      .nav-target {
          transform: translateX(0);
          transition: transform 0.3s ease-in-out;
      }

      .show-button-target {
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease-in-out;
      }

      .content-wrapper {
          margin-left: 16rem; /* ml-64 equivalent */
          transition: margin-left 0.3s ease-in-out;
      }

      /* Collapsed states */
      .sidebar-collapsed .nav-target {
          transform: translateX(-100%);
      }

      .sidebar-collapsed .show-button-target {
          opacity: 1;
          pointer-events: auto;
      }

      .sidebar-collapsed .content-wrapper {
          margin-left: 0;
      }

      @media (max-width: 768px) {
          .content-wrapper {
              margin-left: 0;
          }
      }
  </style>
</head>
<body class="h-full font-sans antialiased font-normal leading-normal dark:text-gray-50" data-controller="application theme" data-theme-preference-value="<%= current_user&.theme %>">
<div class="flex flex-col min-h-screen <%= "no-navbar" unless @navbar %>" data-controller="sidebar">
  <header>
    <%= render "flash" %>
    <%= render "navbar" %>
  </header>
  <!-- Main Content -->
  <main class="flex-1 bg-gray-200 dark:bg-gray-900 transition-all duration-300 content-wrapper" data-sidebar-target="content">
    <%= yield %>
  </main>
  <%= render partial: "footer" if !turbo_native_app? && @footer %>
</div>
<ninja-keys data-controller="command-palette" hideBreadcrumbs></ninja-keys>
<%= yield :javascript %>
</body>
</html>
