<!DOCTYPE html>
<!--TODO JS current_user-->
<% 
  html_classes = []
  html_classes << (current_user&.prefers_dark_mode? ? 'dark' : 'light')
  # Only force collapsed for scoreboard users when sb_state parameter is present (direct scoreboard URL)
  # Check both current_user (Devise) and Current.user (could be set even if current_user is not yet available)
  is_scoreboard_user = (current_user&.email == 'scoreboard@carambus.de') || (Current.user&.email == 'scoreboard@carambus.de')
  is_scoreboard_url = is_scoreboard_user && params[:sb_state].present?
  html_classes << 'sidebar-collapsed' if is_scoreboard_url
  # Debug logging
  Rails.logger.info "ðŸ”§ HTML class setup: current_user=#{current_user&.email}, Current.user=#{Current.user&.email}, sb_state=#{params[:sb_state]}, is_scoreboard_url=#{is_scoreboard_url}, classes=#{html_classes.inspect}"
%>
<html lang="en" class="<%= html_classes.join(' ') %>" data-scoreboard-url="<%= is_scoreboard_url %>">
<head>
  <title>
    <% if content_for?(:title) %>
      <%= yield :title %> |
    <% end %>
    <%= Carambus.config.application_name %>
  </title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= viewport_meta_tag %>
  <% if current_user&.system_theme? %>
    <script>document.documentElement.classList.toggle("dark", window.matchMedia('(prefers-color-scheme: dark)').matches)</script>
  <% end %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  <%= stylesheet_link_tag "application", media: "all", "data-turbo-track": "reload" %>
  <!-- Font Awesome (local) for icon rendering in development/testing -->
  <link rel="stylesheet" href="/vendor/fontawesome/all.min.css" />
  <%# Be sure to add your own custom favicons %>
  <%= render "favicons" %>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <%= yield :head %>
  <% if Rails.env.production? %>
    <style nonce="<%= content_security_policy_nonce %>">
        /* Production styles */
    </style>
  <% else %>
    <style>
        /* Development styles without nonce */
    </style>
  <% end %>
  <!-- Note: Sidebar state management is now handled entirely by sidebar_controller.js -->
  <!-- This ensures consistent behavior during Turbo navigation -->

  <style>
      /* Initial states */
      .nav-target {
          transform: translateX(0) !important;
          transition: transform 0.3s ease-in-out !important;
      }

      .show-button-target {
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease-in-out;
      }

      .content-wrapper {
          margin-left: 16rem !important; /* ml-64 equivalent */
          transition: margin-left 0.3s ease-in-out !important;
      }

      /* Collapsed states */
      .sidebar-collapsed .nav-target {
          transform: translateX(-100%) !important;
      }

      .sidebar-collapsed .show-button-target {
          opacity: 1;
          pointer-events: auto;
      }

      .sidebar-collapsed .content-wrapper {
          margin-left: 0 !important;
      }

      @media (max-width: 768px) {
          .content-wrapper {
              margin-left: 0;
          }
      }
  </style>
</head>
<body class="h-full font-sans antialiased font-normal leading-normal dark:text-gray-50" data-controller="theme" data-theme-preference-value="<%= current_user&.theme %>" data-user-email="<%= current_user&.email %>">
<div class="flex flex-col min-h-screen <%= "no-navbar" unless @navbar %>" data-controller="sidebar">
  <header>
    <%= render "flash" %>
    <%= render "navbar" %>
  </header>
  <!-- Main Content -->
  <main class="flex-1 bg-gray-200 dark:bg-gray-900 transition-all duration-300 content-wrapper" data-sidebar-target="content">
    <%= yield %>
  </main>
  <%= render partial: "footer" if !turbo_native_app? && @footer %>
</div>
<ninja-keys data-controller="command-palette" hideBreadcrumbs></ninja-keys>
<%= yield :javascript %>
</body>
</html>
