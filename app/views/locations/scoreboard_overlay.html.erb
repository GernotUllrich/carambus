<% 
  # Check if we have options from TableMonitorJob (real-time updates)
  # or need to get them fresh from the database (polling mode)
  if local_assigns[:options].present?
    options = local_assigns[:options]
  elsif @table_monitor.present?
    @table_monitor.get_options!(I18n.locale)
    options = @table_monitor.options
  else
    options = nil
  end
%>

<% if @game.present? && options.present? %>
  <% 
    # Use the same logic as teaser - get player orientation based on current_left_player
    left_player = options[:current_left_player] == "playera" ? options[:player_a] : options[:player_b]
    right_player = options[:current_left_player] == "playera" ? options[:player_b] : options[:player_a]
    left_player_id = options[:current_left_player] == "playera" ? "playera" : "playerb"
    right_player_id = options[:current_left_player] == "playera" ? "playerb" : "playera"
    left_player_active = options[:current_left_player] == "playera" ? options[:player_a_active] : options[:player_b_active]
    right_player_active = options[:current_left_player] == "playera" ? options[:player_b_active] : options[:player_a_active]
    
    # Get current scores (result + current innings)
    left_score = left_player[:result].to_i + (@table_monitor.data[left_player_id].andand["innings_redo_list"].andand[-1].to_i || 0)
    right_score = right_player[:result].to_i + (@table_monitor.data[right_player_id].andand["innings_redo_list"].andand[-1].to_i || 0)
  %>
  
  <div class="overlay-container" data-controller="streaming-overlay" data-streaming-overlay-table-id-value="<%= @table&.id %>">
    <!-- Header -->
    <div class="overlay-header">
      <div class="table-number">
        T<%= @table&.number || "?" %>
      </div>
      <div class="live-badge">
        <span class="live-indicator"></span>
        LIVE
      </div>
    </div>
    
    <!-- Left Player -->
    <div class="player-row <%= 'active' if left_player_active %>">
      <div class="player-name">
        <%= (left_player[:firstname].presence || left_player[:lastname]).gsub("Dr. ", "") %>
      </div>
      <div class="player-score" data-streaming-overlay-target="scoreA">
        <%= left_score %>
      </div>
    </div>
    
    <!-- Right Player -->
    <div class="player-row <%= 'active' if right_player_active %>">
      <div class="player-name">
        <%= (right_player[:firstname].presence || right_player[:lastname]).gsub("Dr. ", "") %>
      </div>
      <div class="player-score" data-streaming-overlay-target="scoreB">
        <%= right_score %>
      </div>
    </div>
    
    <!-- Tournament Info Footer -->
    <% if @tournament.present? %>
      <div class="tournament-info">
        <%= @tournament.try(:title) || @tournament.try(:name) || "Turnier" %>
      </div>
    <% end %>
  </div>
<% else %>
  <!-- No active game -->
  <div class="no-game">
    <div class="no-game-title">
      <%= @location&.name || "Carambus" %>
    </div>
    <div class="no-game-subtitle">
      Tisch <%= @table&.number || "?" %> â€¢ Kein Spiel
    </div>
  </div>
<% end %>
