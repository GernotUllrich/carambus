<% 
  # Check if we have options from TableMonitorJob (real-time updates)
  # or need to get them fresh from the database (polling mode)
  if local_assigns[:options].present?
    options = local_assigns[:options]
  elsif @table_monitor.present?
    @table_monitor.get_options!(I18n.locale)
    options = @table_monitor.options
  else
    options = nil
  end
%>

<% if @game.present? && options.present? %>
  <% 
    # Use the same logic as teaser - get player orientation based on current_left_player
    left_player = options[:current_left_player] == "playera" ? options[:player_a] : options[:player_b]
    right_player = options[:current_left_player] == "playera" ? options[:player_b] : options[:player_a]
    left_player_id = options[:current_left_player] == "playera" ? "playera" : "playerb"
    right_player_id = options[:current_left_player] == "playera" ? "playerb" : "playera"
    left_player_active = options[:current_left_player] == "playera" ? options[:player_a_active] : options[:player_b_active]
    right_player_active = options[:current_left_player] == "playera" ? options[:player_b_active] : options[:player_a_active]
    
    # Get current scores (result + current innings)
    left_score = left_player[:result].to_i + (@table_monitor.data[left_player_id].andand["innings_redo_list"].andand[-1].to_i || 0)
    right_score = right_player[:result].to_i + (@table_monitor.data[right_player_id].andand["innings_redo_list"].andand[-1].to_i || 0)
  %>
  
  <div class="w-full px-2 py-1 flex flex-col gap-1 bg-black/80"
       data-controller="streaming-overlay" 
       data-streaming-overlay-table-id-value="<%= @table&.id %>">
    
    <!-- Header -->
    <div class="flex justify-between items-center pb-1 border-b border-white/20">
      <div class="text-xs font-bold text-white drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)]">
        T<%= @table&.number || "?" %>
      </div>
      <div class="flex items-center gap-1 bg-red-600/90 px-1.5 py-0.5 rounded-lg text-[8px] font-bold uppercase">
        <span class="live-indicator inline-block w-1 h-1 bg-white rounded-full"></span>
        LIVE
      </div>
    </div>
    
    <!-- Left Player -->
    <div class="flex items-center gap-1.5 bg-black/40 rounded px-1.5 py-1 border-l-2 <%= left_player_active ? 'border-yellow-400 bg-yellow-400/15' : 'border-transparent' %>">
      <div class="flex-1 text-[11px] font-bold text-white drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)] whitespace-nowrap overflow-hidden text-ellipsis">
        <%= (left_player[:firstname].presence || left_player[:lastname]).gsub("Dr. ", "") %>
      </div>
      <div class="text-base font-bold text-green-500 drop-shadow-[2px_2px_4px_rgba(0,0,0,0.9)] min-w-[30px] text-right" 
           data-streaming-overlay-target="scoreA">
        <%= left_score %>
      </div>
    </div>
    
    <!-- Right Player -->
    <div class="flex items-center gap-1.5 bg-black/40 rounded px-1.5 py-1 border-l-2 <%= right_player_active ? 'border-yellow-400 bg-yellow-400/15' : 'border-transparent' %>">
      <div class="flex-1 text-[11px] font-bold text-white drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)] whitespace-nowrap overflow-hidden text-ellipsis">
        <%= (right_player[:firstname].presence || right_player[:lastname]).gsub("Dr. ", "") %>
      </div>
      <div class="text-base font-bold text-green-500 drop-shadow-[2px_2px_4px_rgba(0,0,0,0.9)] min-w-[30px] text-right" 
           data-streaming-overlay-target="scoreB">
        <%= right_score %>
      </div>
    </div>
    
    <!-- Tournament Info Footer -->
    <% if @tournament.present? %>
      <div class="text-[9px] text-white/80 drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)] text-center pt-0.5 border-t border-white/10 whitespace-nowrap overflow-hidden text-ellipsis">
        <%= @tournament.try(:title) || @tournament.try(:name) || "Turnier" %>
      </div>
    <% end %>
  </div>
<% else %>
  <!-- No active game -->
  <div class="w-full p-2 text-center flex flex-col justify-center items-center bg-black/80">
      <div class="text-sm font-bold drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)] text-white mb-1">
        <%= @location&.name || "Carambus" %>
      </div>
      <div class="text-[10px] text-white/80 drop-shadow-[1px_1px_2px_rgba(0,0,0,0.8)]">
        Tisch <%= @table&.number || "?" %> â€¢ Kein Spiel
      </div>
  </div>
<% end %>
