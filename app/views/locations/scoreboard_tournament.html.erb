<!--suppress RubyScope, RubyScope, RubyScope -->
<%= stylesheet_link_tag "scoreboard_tournament", "data-turbo-track": "reload" %>

<div data-controller="tournament-hotkeys">
  <div class="nav-icons">
    <%= custom_link_to scoreboard_location_path(@location.md5, sb_state: "tournament_scores", :"data-turbo" => false) do %>
      <%= render_svg "icons/information-outline", class: "nav-icon", title: "home" %>
    <% end %>
    <%= custom_link_to toggle_dark_mode_location_path(@location), :"data-turbo" => false do %>
      <%= render_svg "icons/adjust", class: "nav-icon", title: "toggle dark mode" %>
    <% end %>
    <%= custom_link_to scoreboard_location_path(@location.md5, sb_state: "welcome", :"data-turbo" => false) do %>
      <%= render_svg "icons/home", class: "nav-icon", title: "home" %>
    <% end %>
  </div>

  <div class="tournament-container" data-background-image="<%= @location.background_image %>">
    <h1 class="tournament-title"><%= t('select_tournament') %></h1>
    <h2 class="tournament-subtitle"><%= @table.andand.name %></h2>
    <%- found = false %>
    <%- if @location.parties.present? %>
      <%- @location.parties.joins(:party_monitor).order("party_monitors.updated_at desc").each do |party| %>
        <%- found = true %>
        <h1 class="tournament-section"><%= party.league.name %> - <%= party.league.season.name %></h1>
        <%- if party.party_monitor.present? %>
          <%= custom_link_to "Tischauswahl", location_path(@location, sb_state: "tables"), 
              data: { turbo: false }, 
              class: "tournament-button", 
              id: "training", 
              tabindex: 1 %>
        <%- end %>
      <%- end %>
    <%- end %>
    <%- if @tournaments.present? %>
      <%- @tournaments.each do |tournament| %>
        <h1 class="tournament-section"><%= tournament.title %></h1>
        <%= custom_link_to t('home.index.results_so_far'), 
            game_results_location_path(@location, tournament_id: tournament.id), 
            data: { turbo: false }, 
            class: "tournament-button", 
            id: "game_results_#{tournament.id}", 
            tabindex: 1 %>
        <div class="tournament-grid">
          <%- if tournament.manual_assignment? %>
            <%- if @table.present? %>
              <%- found = true %>
              <%= custom_link_to t('continue'), 
                  placement_location_path(@location, tournament_id: tournament.id, table_id: @table.id), 
                  method: :post, 
                  data: { turbo: false }, 
                  class: "tournament-button tournament-button-large", 
                  id: "table_monitor_#{@table.id}", 
                  tabindex: 1 %>
            <%- else %>
              <%- tournament.location.tables.select { |table| table.table_kind.disciplines.include?(tournament.discipline) }.sort_by(&:name).reverse.each do |table| %>
                <%- found = true %>
                <div class="tournament-table">
                  <%= custom_link_to table.name, 
                      placement_location_path(@location, tournament_id: tournament.id, table_id: table.id), 
                      method: :post, 
                      data: { turbo: false }, 
                      class: "tournament-button tournament-button-large", 
                      id: "table_monitor_#{table.id}", 
                      tabindex: 1 %>
                  <%- if table.table_monitor&.game.present? %>
                    <%- gps = table.table_monitor.game.game_participations.sort_by(&:role) %>
                    <%- if gps[0]&.player.present? && gps[1]&.player.present? %>
                      <p class="tournament-table-name"><%= "#{gps[0].player.shortname} - #{gps[1].player.shortname}" %></p>
                    <%- end %>
                  <%- end %>
                </div>
              <%- end %>
            <%- end %>
          <%- else %>
            <div class="tournament-grid">
              <%- tournament.tournament_monitor.table_monitors.joins(:table).order("tables.name desc").each do |table_monitor| %>
                <%- found = true %>
                <div class="tournament-table">
                  <%= custom_link_to table_monitor.display_name, 
                      table_monitor_path(table_monitor), 
                      data: { turbo: false }, 
                      class: "tournament-button tournament-button-large", 
                      id: "table_monitor_#{table_monitor.id}", 
                      tabindex: 1 %>
                  <%- if table_monitor.game.present? %>
                    <%- gps = table_monitor.game.andand.game_participations.andand.order(:role).to_a %>
                    <p class="tournament-table-name"><%= "#{gps[0].andand.player.andand.shortname} - #{gps[1].andand.player.andand.shortname}" %></p>
                    <p class="tournament-table-status"><%= t("table_monitor.status.#{table_monitor.state}") %></p>
                  <%- end %>
                </div>
              <%- end %>
            </div>
          <%- end %>
        </div>
      <%- end %>
    <%- end %>
    <%- unless found %>
      <h2 class="tournament-error"><%= "Derzeit ist kein Turnier registriert." %></h2>
      <%= custom_link_to t('back'), 
          :back, 
          data: { turbo: false }, 
          class: "tournament-button tournament-button-large", 
          id: "back", 
          tabindex: 1 %>
    <%- end %>
  </div>
</div>

<script nonce="<%= content_security_policy_nonce %>" type="text/javascript">
  document.addEventListener('turbo:load', function() {
    // Set the background image via CSS variable
    const container = document.querySelector('.tournament-container');
    if (container) {
      const bgImage = container.dataset.backgroundImage;
      if (bgImage) {
        container.style.setProperty('--bg-image', `url('${bgImage}')`);
        container.style.backgroundImage = 'var(--bg-image)';
      }
    }
  });
</script>
