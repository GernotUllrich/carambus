<!--suppress RubyScope, RubyScope, RubyScope -->
<script defer src="/alpine.min.js"></script>
<style>
    .responsive-svg {
        width: 100%;
        height: auto;
    }

</style>
<!--<script src="hotkeys.js"></script>-->
<script type="text/javascript">
  document.addEventListener('turbo:load', function() {
    console.log('Window.hotkeys in view:', window.hotkeys); // Check availability
    if (!window.hotkeys) {
      console.error('Hotkeys not available!');
      return;
    }
    var current_element = document.activeElement.getAttribute("id")
    console.log("active: " + current_element);
    if (current_element == null) {
      current_element = "start";
    }
    console.log("active now: " + current_element);
    const elementToFocus = document.getElementById(current_element);
    if (elementToFocus) {
      elementToFocus.focus();
    }

    // backspace, tab, clear, enter, return, esc, escape, space, up, down, left, right, home, end, pageup, pagedown, del, delete and f1 through f19
    window.hotkeys('*', function (event, handler) {
      // Prevent the default refresh event under WINDOWS system

      //console.log(hotkeys.getPressedKeyCodes());
      //alert('you pressed ' + hotkeys.getPressedKeyCodes());
      var keyMap = {
        33: "key_a",
        37: "key_a",
        34: "key_b",
        39: "key_b",
        66: "key_c",
        38: "key_c",
        116: "key_d",
        27: "key_d",
        40: "key_d",
        13: "key_d",
      }
      var tabbed_elements = {
        "start": "intro",
        "intro": "language",
        "language": "start"
      }

      if (event.keyCode in keyMap) {
        var key = keyMap[event.keyCode];
        if (key == "key_c") {
          window.history.back();
        }
        if (key == "key_b") {
          var current_element = document.activeElement.getAttribute("id")
          console.log("active becomes (b): " + tabbed_elements[current_element]);
          document.getElementById(tabbed_elements[current_element]).focus();
        }
        if (key == "key_a") {
          var current_element = document.activeElement.getAttribute("id");
          for (k in tabbed_elements) {
            if (tabbed_elements[k] == current_element) {
              console.log("active becomes (a): " + k);
              document.getElementById(k).focus();
              break;
            }
          }
        }
        if (key == "key_d") {
          console.log("activate: " + document.activeElement.getAttribute("id"));
          document.activeElement.click();
        }
      } else {
        alert("Unhandled Keycode: " + event.keyCode)
      }
      event.preventDefault();
      return true
    });

    function toggleFullScreen(elem) {
      if ((document.fullScreenElement !== undefined && document.fullScreenElement === null) || (document.msFullscreenElement !== undefined && document.msFullscreenElement === null) || (document.mozFullScreen !== undefined && !document.mozFullScreen) || (document.webkitIsFullScreen !== undefined && !document.webkitIsFullScreen)) {
        if (elem.requestFullScreen) {
          elem.requestFullScreen();
        } else if (elem.mozRequestFullScreen) {
          elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullScreen) {
          elem.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      } else {
        if (document.cancelFullScreen) {
          document.cancelFullScreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.webkitCancelFullScreen) {
          document.webkitCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }


    function simulateKey(keyCode, type, modifiers) {
      var evtName = (typeof (type) === "string") ? "key" + type : "keydown";
      var modifier = (typeof (modifiers) === "object") ? modifier : {};

      var event = document.createEvent("HTMLEvents");
      event.initEvent(evtName, true, false);
      event.keyCode = keyCode;

      for (var i in modifiers) {
        event[i] = modifiers[i];
      }

      document.dispatchEvent(event);
    }


  });
</script>
<style>
    #info {
        height: 40px;
        position: fixed;
        bottom: 0;
        width: 300px;
        color: white;
        opacity: 1;
    }
</style>
<div id="info" class="mb-5 ml-5">Version: <%= Rails.env == "production" ? "#{File.read("#{Rails.root}/REVISION").truncate(11)}<br />#{File.ctime("#{Rails.root}/REVISION")}".html_safe : `git show --pretty=%H -q`.truncate(11) %></div>

<!-- Scoreboard Menu -->
<div class="inline-flex items-center justify-end space-x-[1.5vw] mr-4 fixed text-gray-300 hover:text-black text-2vw font-bold" style="right: 10px; top: 10px;">
  <%= custom_link_to scoreboard_location_path(@location.md5, sb_state: "table_scores", :"data-turbo" => false) do %>
    <%= fa_icon "circle-info", weight: "fa-solid", class: "responsive-svg fill-current icon-lg m-0 text-white inline-block", title: "tables overview" %>
  <% end %>
</div>

<script>
  (function() {
    function updateFullscreenIconBottom() {
      var icon = document.getElementById('fullscreen-toggle-bottom');
      if (!icon) return;
      var isFull = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
      icon.classList.toggle('fa-expand', !isFull);
      icon.classList.toggle('fa-compress', isFull);
    }

    document.addEventListener('fullscreenchange', updateFullscreenIconBottom);
    document.addEventListener('webkitfullscreenchange', updateFullscreenIconBottom);
    document.addEventListener('mozfullscreenchange', updateFullscreenIconBottom);
    document.addEventListener('MSFullscreenChange', updateFullscreenIconBottom);
    document.addEventListener('DOMContentLoaded', updateFullscreenIconBottom);
    updateFullscreenIconBottom();
  })();
  </script>

<!-- Language Switcher Bottom Right (+ fullscreen toggle left) -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1001;" class="flex items-center space-x-4">
  <%= custom_link_to "javascript:tryResizeWindow()", :"data-turbo" => false do %>
    <%= fa_icon "expand", weight: "fa-solid", id: "fullscreen-toggle-bottom", class: "responsive-svg fill-current icon-lg text-white inline-block", title: "toggle fullscreen / resize window" %>
  <% end %>
  <div x-data="{ open: false }" @click.outside="open = false" class="relative inline-block text-left">
    <button type="button" @click="open = !open" class="inline-flex items-center justify-center text-white hover:text-gray-300 focus:outline-none" style="height: 40px;">
      <%= image_tag "flag_#{I18n.locale}.png", style: "width: 40px; height: 28px;", alt: I18n.locale.to_s.upcase %>
      <svg class="ml-1 transform rotate-180" style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
    </button>
    <div x-show="open" class="absolute right-0 bottom-full mb-2 origin-bottom-right bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5" style="min-width: 100px;">
      <div class="py-1" role="menu" aria-orientation="vertical">
        <% I18n.available_locales.each do |locale| %>
          <% next if locale == I18n.locale %>
          <%= link_to({ locale: locale }, class: "flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700", role: "menuitem", data: { turbo: false }, tabindex: 0) do %>
            <%= image_tag "flag_#{locale}.png", style: "width: 40px; height: 28px;", alt: locale.to_s.upcase %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="p-14 w-full m-auto flex items-end flex-col bg-cover h-screen bg-center bg-no-repeat" style="background-image: url('<%= @location.background_image %>')">
  <h1 style="text-shadow: 2px 2px #000000" class="text-4vw flex mb-2 text-gray-200 "><%= t('welcome') + " - #{@location.name}" %></h1>
  <p style="text-shadow: 2px 2px #000000" class="mb-6 text-gray-200 leading-normal text-3vw"><%= t('carambus_manages') %></p>
  <span>
    <%= custom_link_to "Start", location_path(sb_state: "start"), class: "dark:text-white focus:outline-none focus:ring-8 focus:ring-green-500 focus:ring-opacity-90 border-0 btn btn-primary p-5 lg:p-10 text-3vw lg:mr-10 mr-4 lg:mt-4 mt-2", id: "start", data: { turbo: false }, tabindex: 1 %>
    <%= custom_link_to "Intro", intro_path, class: "dark:text-white focus:outline-none focus:ring-8 focus:ring-green-500 focus:ring-opacity-90 border-0 btn btn-primary p-5 lg:p-10 text-3vw lg:mr-10 mr-4 lg:mt-4 mt-2", id: "intro", data: { turbo: false }, tabindex: 2 %>
  </span>
  <span class="flex items-center flex-row h-1/4 space-x-20">
    <%= custom_link_to t('home.index.reservation'), location_path(@location, sb_state: "reservations"), data: { turbo: false }, class: "dark:text-white focus:outline-none focus:ring-8 focus:ring-green-500 focus:ring-opacity-90 border-0 btn btn-primary text-3vw lg:mr-10 mr-4 lg:mt-4 mt-2", id: "reservations", tabindex: 1 %>
  </span>

</div>
