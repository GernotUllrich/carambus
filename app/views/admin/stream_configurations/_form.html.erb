<%= form_with(model: [:admin, stream_configuration], local: true, class: "space-y-6", data: { controller: "stream-destination" }) do |form| %>
  <% if stream_configuration.errors.any? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
      <h2 class="font-bold mb-2"><%= pluralize(stream_configuration.errors.count, "Fehler") %> beim Speichern:</h2>
      <ul class="list-disc list-inside">
        <% stream_configuration.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <!-- Table Selection (Location wird daraus abgeleitet) -->
    <%= form.label :table_id, "Tisch", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.select :table_id,
        grouped_options_for_select(
          @locations.map { |loc| [loc.name, loc.tables.map { |t| [t.name, t.id] }] },
          stream_configuration.table_id
        ),
        { include_blank: "Bitte Location und Tisch wÃ¤hlen..." },
        { class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
    <p class="mt-1 text-sm text-gray-500">Location wird automatisch vom gewÃ¤hlten Tisch Ã¼bernommen</p>
  </div>

  <!-- Stream Destination Selection -->
  <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-800">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ¯ Stream-Ziel</h3>
    
    <%= form.label :stream_destination, "Wohin soll gestreamt werden?", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.select :stream_destination,
        [
          ['YouTube Live', 'youtube'],
          ['Lokaler RTMP Server (Mac/OBS)', 'local'],
          ['Eigener RTMP Server', 'custom']
        ],
        {},
        {
          class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
          data: {
            action: "change->stream-destination#toggle"
          }
        } %>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
      <strong>YouTube:</strong> Direkt zu YouTube Live streamen<br>
      <strong>Lokal:</strong> Zu Mac/Laptop mit OBS streamen (fÃ¼r Multi-Kamera-Setups)<br>
      <strong>Eigener Server:</strong> Zu beliebigem RTMP-Server streamen
    </p>
  </div>

  <!-- YouTube Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg" 
       data-stream-destination-target="youtubeFields"
       style="<%= 'display: none;' unless stream_configuration.stream_destination == 'youtube' %>">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ¬ YouTube-Konfiguration</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group md:col-span-2">
        <%= form.label :youtube_stream_key, "Stream-Key", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :youtube_stream_key,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "xxxx-yyyy-zzzz-aaaa-bbbb" %>
        <p class="mt-1 text-sm text-gray-500">Aus YouTube Studio â†’ Live-Streaming â†’ Stream-Key kopieren</p>
      </div>

      <div class="form-group md:col-span-2">
        <%= form.label :youtube_channel_id, "Channel-ID (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :youtube_channel_id,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "UCxxxxxxxxxxxxxxxxxxxxxxxxx" %>
        <p class="mt-1 text-sm text-gray-500">FÃ¼r direkten Link zum Live-Stream</p>
      </div>
    </div>
  </div>

  <!-- Local RTMP Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg"
       data-stream-destination-target="localFields"
       style="<%= 'display: none;' unless stream_configuration.stream_destination == 'local' %>">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ–¥ï¸ Lokaler RTMP Server</h3>
    
    <div class="form-group">
      <%= form.label :local_rtmp_server_ip, "RTMP Server IP-Adresse", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.text_field :local_rtmp_server_ip,
          class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
          placeholder: "192.168.1.105" %>
      <p class="mt-1 text-sm text-gray-500">
        IP-Adresse des Mac mini oder Laptops, auf dem Docker RTMP Server lÃ¤uft
      </p>
    </div>

    <% if stream_configuration.table_id.present? %>
      <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800">
        <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“¡ RTMP Stream-URL (fÃ¼r OBS):</p>
        <code class="text-xs bg-white dark:bg-gray-900 px-2 py-1 rounded">
          rtmp://<%= stream_configuration.local_rtmp_server_ip || '[SERVER-IP]' %>:1935/live/table<%= stream_configuration.table_id %>
        </code>
        <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
          Diese URL in OBS als "Media Source" einbinden
        </p>
      </div>
    <% end %>
  </div>

  <!-- Custom RTMP Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg"
       data-stream-destination-target="customFields"
       style="<%= 'display: none;' unless stream_configuration.stream_destination == 'custom' %>">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ”§ Eigener RTMP Server</h3>
    
    <div class="grid grid-cols-1 gap-4">
      <div class="form-group">
        <%= form.label :custom_rtmp_url, "RTMP Server URL", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :custom_rtmp_url,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "rtmp://example.com:1935/live" %>
        <p class="mt-1 text-sm text-gray-500">
          Basis-URL ohne Stream-Key (z.B. rtmp://server.com:1935/live)
        </p>
      </div>

      <div class="form-group">
        <%= form.label :custom_rtmp_key, "Stream-Key (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :custom_rtmp_key,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "optional-stream-key" %>
        <p class="mt-1 text-sm text-gray-500">
          Falls der Server einen Stream-Key benÃ¶tigt
        </p>
      </div>

      <% if stream_configuration.custom_rtmp_url.present? %>
        <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“¡ Finale RTMP URL:</p>
          <code class="text-xs bg-white dark:bg-gray-900 px-2 py-1 rounded break-all">
            <%= stream_configuration.custom_rtmp_url %><%= "/#{stream_configuration.custom_rtmp_key}" if stream_configuration.custom_rtmp_key.present? %>
          </code>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Camera Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ“· Kamera-Einstellungen</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <%= form.label :camera_device, "GerÃ¤t", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :camera_device,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "/dev/video0" %>
      </div>

      <div class="form-group">
        <%= form.label :camera_fps, "Framerate (FPS)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.select :camera_fps,
            options_for_select([30, 60], stream_configuration.camera_fps || 60),
            {},
            { class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div class="form-group">
        <%= form.label :camera_width, "Breite", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :camera_width,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div class="form-group">
        <%= form.label :camera_height, "HÃ¶he", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :camera_height,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
    </div>
  </div>

  <!-- Camera Manual Settings (Focus/Exposure) -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ”§ Manuelle Kameraeinstellungen</h3>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
      Deaktiviert Auto-Fokus und Auto-Belichtung, damit die Einstellungen konstant bleiben, auch wenn jemand durch das Bild lÃ¤uft.
    </p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <%= form.label :focus_auto, "Auto-Fokus", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.select :focus_auto,
            options_for_select([['Manuell (empfohlen)', 0], ['Automatisch', 1]], stream_configuration.focus_auto || 0),
            {},
            { class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
        <p class="mt-1 text-sm text-gray-500">Manuell = konstanter Fokus, auch bei Bewegung</p>
      </div>

      <div class="form-group">
        <%= form.label :exposure_auto, "Auto-Belichtung", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.select :exposure_auto,
            options_for_select([['Manuell (empfohlen)', 1], ['Automatisch', 3]], stream_configuration.exposure_auto || 1),
            {},
            { class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
        <p class="mt-1 text-sm text-gray-500">Manuell = konstante Belichtung, auch bei Bewegung</p>
      </div>

      <div class="form-group">
        <%= form.label :focus_absolute, "Fokus-Wert (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :focus_absolute,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            min: 0, max: 250, step: 5, placeholder: "Leer = aktueller Wert beibehalten" %>
        <p class="mt-1 text-sm text-gray-500">0-250 (Schritt: 5). Nur wenn Auto-Fokus = Manuell</p>
      </div>

      <div class="form-group">
        <%= form.label :exposure_absolute, "Belichtungs-Wert (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :exposure_absolute,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            min: 3, max: 2047, placeholder: "Leer = aktueller Wert beibehalten" %>
        <p class="mt-1 text-sm text-gray-500">3-2047 (Standard: 250). Nur wenn Auto-Belichtung = Manuell</p>
      </div>

      <div class="form-group">
        <%= form.label :brightness, "Helligkeit (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :brightness,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            min: 0, max: 255, placeholder: "Leer = Standard (128)" %>
        <p class="mt-1 text-sm text-gray-500">0-255 (Standard: 128)</p>
      </div>

      <div class="form-group">
        <%= form.label :contrast, "Kontrast (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :contrast,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            min: 0, max: 255, placeholder: "Leer = Standard (128)" %>
        <p class="mt-1 text-sm text-gray-500">0-255 (Standard: 128)</p>
      </div>

      <div class="form-group">
        <%= form.label :saturation, "SÃ¤ttigung (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :saturation,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            min: 0, max: 255, placeholder: "Leer = Standard (128)" %>
        <p class="mt-1 text-sm text-gray-500">0-255 (Standard: 128)</p>
      </div>
    </div>
    
    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800">
      <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ’¡ Tipp:</p>
      <p class="text-xs text-gray-600 dark:text-gray-400">
        <strong>Standard-Einstellungen:</strong> Auto-Fokus = Manuell, Auto-Belichtung = Manuell<br>
        Diese Einstellungen verhindern, dass die Kamera sich automatisch anpasst, wenn jemand durch das Bild lÃ¤uft.<br>
        Optional kÃ¶nnen Sie manuelle Werte fÃ¼r Fokus und Belichtung setzen, um die beste QualitÃ¤t zu erzielen.
      </p>
    </div>
  </div>

  <!-- Overlay Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ¨ Overlay-Einstellungen</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="form-group">
        <label class="flex items-center">
          <%= form.check_box :overlay_enabled,
              class: "form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" %>
          <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Overlay aktiviert</span>
        </label>
      </div>

      <div class="form-group">
        <%= form.label :overlay_position, "Position", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.select :overlay_position,
            options_for_select([['Unten', 'bottom'], ['Oben', 'top']], stream_configuration.overlay_position || 'bottom'),
            {},
            { class: "form-select w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
      </div>

      <div class="form-group">
        <%= form.label :overlay_height, "HÃ¶he (px)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :overlay_height,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
    </div>
  </div>

  <!-- Perspective Correction (Trapezkorrektur) -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸ“ Trapezkorrektur</h3>
    
    <div class="form-group mb-4">
      <label class="flex items-center">
        <%= form.check_box :perspective_enabled,
            class: "form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500",
            data: { 
              action: "change->stream-destination#togglePerspective",
              stream_destination_target: "perspectiveCheckbox"
            } %>
        <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Trapezkorrektur aktivieren</span>
      </label>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Korrigiert Verzerrungen, wenn die Kamera schrÃ¤g auf das Spielfeld gerichtet ist
      </p>
    </div>

    <div class="form-group" data-stream-destination-target="perspectiveFields" style="<%= 'display: none;' unless stream_configuration.perspective_enabled %>">
      <%= form.label :perspective_coords, "Koordinaten", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.text_field :perspective_coords,
          class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm",
          placeholder: "0:0:W:0:W:H:0:H" %>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Format: <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">x0:y0:x1:y1:x2:y2:x3:y3</code><br>
        <strong>Ecken:</strong> oben-links, oben-rechts, unten-rechts, unten-links<br>
        <strong>Beispiele:</strong><br>
        â€¢ Keine Korrektur: <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">0:0:W:0:W:H:0:H</code><br>
        â€¢ Leichte Korrektur: <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">50:20:W-50:20:W-30:H-30:30:H-30</code><br>
        â€¢ Pixel-Werte (fÃ¼r 1280x720): <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">0:0:1280:0:1280:720:0:720</code><br>
        <strong>Hinweis:</strong> <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">W</code> und <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">H</code> werden automatisch durch Breite/HÃ¶he ersetzt
      </p>
      
      <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800">
        <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ğŸ’¡ Tipp:</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">
          Die Koordinaten definieren, welche Bereiche des Quellbildes auf die 4 Ecken des Ausgabebildes gemappt werden.
          Experimentieren Sie mit verschiedenen Werten, um die beste Korrektur zu finden.
        </p>
      </div>
    </div>
  </div>

  <!-- Stream Quality -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">âš™ï¸ Stream-QualitÃ¤t</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <%= form.label :video_bitrate, "Video-Bitrate (kbit/s)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :video_bitrate,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            step: 100 %>
        <p class="mt-1 text-sm text-gray-500">Empfohlen: 2000-2500 fÃ¼r 720p60</p>
      </div>

      <div class="form-group">
        <%= form.label :audio_bitrate, "Audio-Bitrate (kbit/s)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :audio_bitrate,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            step: 32 %>
      </div>
    </div>
  </div>

  <!-- Network Configuration -->
  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-100">ğŸŒ Netzwerk</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <%= form.label :raspi_ip, "Raspberry Pi IP-Adresse", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :raspi_ip,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
            placeholder: "192.168.1.100" %>
        <p class="mt-1 text-sm text-gray-500">Wird automatisch vom Tisch Ã¼bernommen, falls vorhanden</p>
      </div>

      <div class="form-group">
        <%= form.label :raspi_ssh_user, "SSH-User", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.text_field :raspi_ssh_user,
            placeholder: "pi oder www-data",
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Standard: pi (Produktion) oder www-data (Development)</p>
      </div>

      <div class="form-group">
        <%= form.label :raspi_ssh_port, "SSH-Port", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
        <%= form.number_field :raspi_ssh_port,
            class: "form-input w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Standard: 22 (Produktion) oder 8910 (Development)</p>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex justify-end gap-3">
    <%= link_to "Abbrechen", admin_stream_configurations_path, class: "btn btn-secondary" %>
    <%= form.submit "Speichern", class: "btn btn-primary" %>
  </div>
<% end %>

