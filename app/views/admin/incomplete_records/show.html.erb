<div class="container py-4">
  <h1 class="mb-4">Fix Incomplete Record</h1>
  
  <div class="row">
    <div class="col-md-8">
      <!-- Tournament Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Tournament Information</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3">ID</dt>
            <dd class="col-sm-9"><%= @tournament.id %></dd>
            
            <dt class="col-sm-3">Title</dt>
            <dd class="col-sm-9"><%= @tournament.title %></dd>
            
            <dt class="col-sm-3">Date</dt>
            <dd class="col-sm-9"><%= @tournament.date_range %></dd>
            
            <dt class="col-sm-3">Location Text</dt>
            <dd class="col-sm-9"><%= @tournament.location_text %></dd>
            
            <dt class="col-sm-3">Source</dt>
            <dd class="col-sm-9">
              <% if @tournament.international_source %>
                <%= @tournament.international_source.name %>
                <small class="text-muted">(<%= @tournament.external_id %>)</small>
              <% end %>
            </dd>
            
            <dt class="col-sm-3">Source URL</dt>
            <dd class="col-sm-9">
              <% if @tournament.source_url.present? %>
                <%= link_to "View on UMB", @tournament.source_url, target: "_blank", class: "btn btn-sm btn-outline-primary" %>
              <% end %>
            </dd>
          </dl>
        </div>
      </div>
      
      <!-- Fix Form -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Fix References</h5>
        </div>
        <div class="card-body">
          <%= form_with model: [:admin, @tournament], url: admin_incomplete_record_path(@tournament), method: :patch, local: true, scope: :tournament do |f| %>
            
            <!-- Discipline -->
            <div class="form-group">
              <label>
                Discipline
                <% if @tournament.is_placeholder_field?(:discipline_id) %>
                  <span class="badge badge-warning ml-2">Unknown</span>
                <% end %>
              </label>
              <%= f.select :discipline_id, 
                          options_from_collection_for_select(@disciplines, :id, :name, @tournament.discipline_id),
                          { include_blank: "Select Discipline" },
                          class: "form-control #{'is-invalid' if @tournament.is_placeholder_field?(:discipline_id)}" %>
              <small class="form-text text-muted">
                Current: <%= @tournament.discipline&.name %>
              </small>
            </div>
            
            <!-- Season -->
            <div class="form-group">
              <label>
                Season
                <% if @tournament.is_placeholder_field?(:season_id) %>
                  <span class="badge badge-warning ml-2">Unknown</span>
                <% end %>
              </label>
              <%= f.select :season_id, 
                          options_from_collection_for_select(@seasons, :id, :name, @tournament.season_id),
                          { include_blank: "Select Season" },
                          class: "form-control #{'is-invalid' if @tournament.is_placeholder_field?(:season_id)}" %>
              <small class="form-text text-muted">
                Current: <%= @tournament.season&.name %>
              </small>
            </div>
            
            <!-- Location -->
            <div class="form-group">
              <label>
                Location
                <% if @tournament.is_placeholder_field?(:location_id) %>
                  <span class="badge badge-warning ml-2">Unknown</span>
                <% end %>
              </label>
              <%= f.select :location_id, 
                          options_from_collection_for_select(@locations, :id, :name, @tournament.location_id),
                          { include_blank: "Select Location" },
                          class: "form-control #{'is-invalid' if @tournament.is_placeholder_field?(:location_id)}" %>
              <small class="form-text text-muted">
                Current: <%= Location.find_by(id: @tournament.location_id)&.name || 'None' %>
                <% if @tournament.location_text.present? %>
                  | Text: <strong><%= @tournament.location_text %></strong>
                  <%= link_to "Create Location from Text", 
                              "#create-location-modal", 
                              class: "btn btn-sm btn-warning ml-2",
                              data: { toggle: "modal" },
                              style: "font-size: 12px; padding: 4px 8px;" %>
                <% end %>
              </small>
            </div>
            
            <!-- Organizer -->
            <div class="form-group">
              <label>
                Organizer
                <% if @tournament.is_placeholder_field?(:organizer_id) %>
                  <span class="badge badge-warning ml-2">Unknown</span>
                <% end %>
              </label>
              <%= f.select :organizer_id, 
                          options_from_collection_for_select(@organizers, :id, :name, @tournament.organizer_id),
                          { include_blank: "Select Organizer" },
                          class: "form-control #{'is-invalid' if @tournament.is_placeholder_field?(:organizer_id)}" %>
              <%= f.hidden_field :organizer_type, value: 'Region' %>
              <small class="form-text text-muted">
                Current: <%= (@tournament.organizer_type.constantize.find_by(id: @tournament.organizer_id)&.name rescue 'N/A') if @tournament.organizer_id %>
              </small>
            </div>
            
            <div class="form-group mt-4">
              <%= f.submit "Update Tournament", class: "btn btn-primary" %>
              <%= link_to "Cancel", admin_incomplete_records_path, class: "btn btn-secondary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <!-- Issues Summary -->
      <div class="card mb-4">
        <div class="card-header bg-warning">
          <h5 class="mb-0">Issues</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled">
            <% if @tournament.is_placeholder_field?(:discipline_id) %>
              <li class="mb-2">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Discipline is unknown
              </li>
            <% end %>
            <% if @tournament.is_placeholder_field?(:season_id) %>
              <li class="mb-2">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Season is unknown
              </li>
            <% end %>
            <% if @tournament.is_placeholder_field?(:location_id) %>
              <li class="mb-2">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Location is unknown
              </li>
            <% end %>
            <% if @tournament.is_placeholder_field?(:organizer_id) %>
              <li class="mb-2">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                Organizer is unknown
              </li>
            <% end %>
            
            <% unless @tournament.has_placeholders? %>
              <li class="text-success">
                <i class="fas fa-check-circle"></i>
                All fields are complete!
              </li>
            <% end %>
          </ul>
        </div>
      </div>
      
      <!-- Suggestions -->
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Suggestions</h5>
        </div>
        <div class="card-body">
          <% if @tournament.title.present? %>
            <h6>Based on Title:</h6>
            <p class="small"><%= @tournament.title %></p>
            
            <% if @tournament.title.match?(/3[\s\-]*cushion/i) %>
              <div class="alert alert-info py-2 small">
                Title contains "3 Cushion" → Suggest: <strong>Dreiband halb</strong>
              </div>
            <% elsif @tournament.title.match?(/cadre/i) %>
              <div class="alert alert-info py-2 small">
                Title contains "Cadre" → Check specific Cadre variant
              </div>
            <% end %>
          <% end %>
          
          <% if @tournament.date.present? %>
            <h6 class="mt-3">Based on Date:</h6>
            <div class="alert alert-info py-2 small">
              Date: <%= @tournament.date.strftime('%Y-%m-%d') %><br>
              Suggested Season: <strong><%= Season.season_from_date(@tournament.date)&.name || 'N/A' %></strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for creating location from text -->
<% if @tournament.location_text.present? %>
  <div id="create-location-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 30px; width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <h3 style="margin-top: 0;">Create Location: <%= @tournament.location_text %></h3>
      
      <%= form_with url: create_location_from_text_admin_incomplete_record_path(@tournament), method: :post do |f| %>
        <div class="form-group">
          <label>Location Name</label>
          <%= f.text_field :name, value: @tournament.location_text, class: "form-control", readonly: true, 
                          style: "background-color: #f0f0f0;" %>
        </div>
        
        <div class="form-group">
          <label>Country Code (ISO 2-letter)</label>
          <%= f.text_field :country_code, value: 'FR', class: "form-control", 
                          placeholder: "e.g., FR, DE, BE, NL" %>
          <small class="form-text text-muted">
            Common: FR (France), DE (Germany), BE (Belgium), NL (Netherlands), ES (Spain), IT (Italy)
          </small>
        </div>
        
        <div class="form-group">
          <label>Address (optional)</label>
          <%= f.text_field :address, value: @tournament.location_text, class: "form-control" %>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <%= f.submit "Create Location", class: "btn btn-warning" %>
          <button type="button" class="btn" onclick="document.getElementById('create-location-modal').style.display='none'">
            Cancel
          </button>
        </div>
      <% end %>
    </div>
  </div>
  
  <script>
    // Simple modal handling
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('create-location-modal');
      const trigger = document.querySelector('[data-toggle="modal"]');
      
      if (trigger) {
        trigger.addEventListener('click', function(e) {
          e.preventDefault();
          modal.style.display = 'block';
        });
      }
      
      // Close on outside click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
  </script>
<% end %>
