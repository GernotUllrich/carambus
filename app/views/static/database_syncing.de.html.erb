<!-----
---
title: Datenbank-Partitionierung und Synchronisierung
summary: 'Das System implementiert eine regionsbasierte Datenbank-Partitionierungsstrategie
  zur Optimierung der Datensynchronisierung zwischen lokalen Servern und dem zentralen
  API-Server. Dieser Ansatz stellt sicher, dass jeder lokale Server nur die für seine
  Region relevanten Daten verwaltet und gleichzeitig Zugriff auf notwendige globale
  Ereignisse hat. Zusätzlich werden regionsunabhängige Daten an alle lokalen Server
  synchronisiert.

  '
version:
published_at: !ruby/object:ActiveSupport::TimeWithZone
  utc: 2025-04-29 21:19:03.426133000 Z
  zone: !ruby/object:ActiveSupport::TimeZone
    name: Europe/Berlin
  time: 2025-04-29 23:19:03.426133000 Z
tags: []
metadata: {}
position: 0
id: 10
---

-->
<div class="py-10 max-w-2xl m-auto  flex flex-col">
<h1 class='font-bold mt-4'>Datenbank-Partitionierung und Synchronisierung</h1>
<h2 class='font-bold mt-4'>Übersicht</h2>
<p class='text-base text-gray-700  dark:text-gray-200 leading-relaxed my-4'>
Das System implementiert eine regionsbasierte Datenbank-Partitionierungsstrategie zur Optimierung der Datensynchronisierung zwischen lokalen Servern und dem zentralen API-Server. Dieser Ansatz stellt sicher, dass jeder lokale Server nur die für seine Region relevanten Daten verwaltet und gleichzeitig Zugriff auf notwendige globale Ereignisse hat. Zusätzlich werden regionsunabhängige Daten an alle lokalen Server synchronisiert.</p>
<h2 class='font-bold mt-4'>Hauptkomponenten</h2>
<h3 class='font-bold mt-4'>1. Regions-Tagging (RegionTaggable)</h3>

<ul>
<li>Datensätze werden mit einem <code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">region_ids</code>-Array markiert, um ihre regionalen Zuordnungen zu verfolgen</li>
<li>Umfasst sowohl die lokale Region als auch die DBU-Region (Deutsche Billard-Union) wenn zutreffend</li>
<li>Datensätze ohne regionale Abhängigkeiten (region_ids ist NULL oder leeres Array) werden an alle Server synchronisiert</li>
<li>Implementiert als Concern in <code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">app/models/concerns/region_taggable.rb</code></li>
</ul>
<h3 class='font-bold mt-4'>2. Versionsverwaltung</h3>

<ul>
<li>Nutzt PaperTrail für die Versionsverfolgung</li>
<li>Versionen werden mit <code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">region_ids</code> markiert, um die regionale Relevanz zu verfolgen</li>
<li>Versionen mit NULL oder leerem region_ids werden als global betrachtet und an alle Server gesendet</li>
<li>Enthält Scopes und Methoden zum Filtern von Versionen nach Region</li>
</ul>
<h3 class='font-bold mt-4'>3. Synchronisierungsprozess</h3>

<ul>
<li>Lokale Server holen Updates über <code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">Version.update_from_carambus_api</code></li>
<li>API-Server filtert Versionen basierend auf regionaler Relevanz</li>
<li>Nur für die anfragende Region relevante Versionen werden übertragen</li>
<li>Globale Versionen (ohne regionale Abhängigkeiten) werden an alle Server übertragen</li>
</ul>
<h3 class='font-bold mt-4'>4. Datenbereinigung</h3>

<ul>
<li>Einmalige Bereinigungsaufgabe zum Entfernen von Daten fremder Regionen</li>
<li>Behält:

<ul>
<li>Daten der lokalen Region</li>
<li>DBU-Regionsdaten</li>
<li>Daten von Regionen mit Vereinen/Spielern in globalen Ereignissen</li>
<li>Alle regionsunabhängigen Daten</li>
</ul></li>
</ul>
<h2 class='font-bold mt-4'>Implementierungsdetails</h2>
<h3 class='font-bold mt-4'>Versionsmodell</h3>
<pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto"><code class="language-ruby">scope :for_region, ->(region_id) {
  where("region_ids IS NULL OR region_ids = '{}' OR region_ids @> ARRAY[?]::integer[]", region_id)
}

def self.relevant_for_region?(region_id)
  return true if region_ids.nil? || region_ids.empty?
  region_ids.include?(region_id)
end
</code></pre><h3 class='font-bold mt-4'>API-Endpunkt</h3>
<pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto"><code class="language-ruby">def get_updates
  # ... existierender Code ...
  if params[:region_id].present?
    version_query = version_query.for_region(params[:region_id])
  end
  # ... restlicher Code ...
end
</code></pre><h3 class='font-bold mt-4'>Bereinigungsaufgabe</h3>
<p class='text-base text-gray-700  dark:text-gray-200 leading-relaxed my-4'>
Die Bereinigungsaufgabe stellt sicher, dass jeder lokale Server nur mit relevanten Daten startet durch:
1. Identifizierung der zu behaltenden Regionen (lokal, DBU und Regionen mit globaler Ereignisbeteiligung)
2. Entfernen von Datensätzen, die nicht mit diesen Regionen verbunden sind
3. Aufrechterhaltung der Datenintegrität für globale Ereignisse
4. Beibehaltung aller regionsunabhängigen Daten</p>
<h2 class='font-bold mt-4'>Verwendung</h2>

<ol>
<li>Führen Sie die Bereinigungsaufgabe auf jedem lokalen Server aus:
<code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">bash
rake cleanup:remove_non_region_records
</code></li>
<li>Konfigurieren Sie den lokalen Server mit seiner Regions-ID</li>
<li>Das System verwaltet die Datenrelevanz automatisch durch den Synchronisierungsprozess</li>
</ol>
</div>
