<div class="container mx-auto mt-8 max-w-3xl ">
  <h1><%= t("home.index.version") %></h1>

  <%- if Rails.env == 'development' %>
    <%- branch = `git status`.split("\n")[0].match(/On branch (.*)/)[1] %>
    <%- version = `git log -1`.split("\n")[0] %>
    <%- repo_version = version.match(/commit (.*)/)[1] %>
  <%- else %>
    <%- version_str = Rails.env == 'development' ? `git log -1`.split("\n")[0] : `tail -1 #{Rails.root.to_s.split("releases")[0]}revisions.log` %>
    <%- m = version_str.match(/Branch (.*) \(at (.*)\) deployed as release (.*) by (.*)/) %>
    <%- branch = m[1]; repo_version = m[2]; release = m[3]; by = m[4] %>
    <%- version = "repo-version: #{repo_version[0..8]}, released: #{release} by: #{by}" %>
  <%- end %>
  <%- if local_server? %>
    <%- url = URI("#{Carambus.config.carambus_api_url}/versions/current_revision") -%>
    <%- Rails.logger.info ">>>>>>>>>>>>>>>> GET #{url} <<<<<<<<<<<<<<<<" -%>
    <%- uri = URI(url) -%>

    <%- json_io = Rails.env == 'development' ?  Version.http_get_with_ssl_bypass(uri) : Net::HTTP.get(uri) -%>
    <%- vers = JSON.parse(json_io) -%>
    <%- revision = vers["current_revision"] -%>
  <%- end %>
  <pre>
    Rails:    <%= Rails.version %>
    Environment: <%= Rails.env %>
    <%= "API Server: #{Carambus.config.carambus_api_url}" if local_server? %>
    Carambus Sync Status: <%= "local: #{Setting.key_get_value("last_version_id")} - " if local_server? %>API Server: <%= Version.last_version %>
    Repo-Branch: <%= branch %>
    Last: <%= version %>
    <%- if local_server? && revision != repo_version -%>
      <div class="text-red-700 mb-4">
        <%= "Version is out-of-date (api.carambus.de has version #{revision[0..8]})" %>
      </div>

      <%- 
        # Debug output
        Rails.logger.info "=== git_changelog debug ==="
        Rails.logger.info "  repo_version: #{repo_version.inspect} (length: #{repo_version&.length})"
        Rails.logger.info "  revision: #{revision.inspect} (length: #{revision&.length})"
        
        # Test the exact command that would run
        test_cmd = "cd #{Rails.root} && git log --oneline #{repo_version}..#{revision}"
        Rails.logger.info "  Test command: #{test_cmd}"
        test_output = `#{test_cmd} 2>&1`
        Rails.logger.info "  Direct command output: #{test_output.inspect}"
        Rails.logger.info "  Direct command exit: #{$?.success?}"
        
        changelog = git_changelog(repo_version, revision)
        Rails.logger.info "  changelog result: #{changelog.inspect}"
      -%>
      <%- if changelog&.any? -%>
        <div class="mt-4 mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded">
          <h3 class="font-bold mb-2 text-gray-900 dark:text-gray-100">ğŸ“ Changes in latest version:</h3>
          <div class="font-mono text-sm leading-none text-gray-800 dark:text-gray-200">
            <%- changelog.each do |commit_line| -%>
              <div class="py-0.5 border-b border-gray-300 dark:border-gray-600 last:border-0">
                <%= commit_line %>
              </div>
            <%- end -%>
          </div>
        </div>
      <%- end -%>

      <div class="mt-4">
        <%= button_to "Update to latest version",
                      update_version_path,
                      method: :post,
                      data: {
                        turbo_confirm: "This will update the application to the latest version. The server will restart. Continue?"
                      },
                      class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    <%- end -%>
    <!--    Carambus: <%#= Rails.env == 'development' ? `git log -10` : `#{"tail -1 #{Rails.root}/../../revisions.log"}` %>-->

  </pre>
</div>

