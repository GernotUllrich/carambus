<div class="container mx-auto mt-8 max-w-3xl ">
  <h1><%= t("home.index.version") %></h1>

  <%- if Rails.env == 'development' %>
    <%- branch = `git status`.split("\n")[0].match(/On branch (.*)/)[1] %>
    <%- version = `git log -1`.split("\n")[0] %>
    <%- repo_version = version.match(/commit (.*)/)[1] %>
  <%- else %>
    <%- version_str = Rails.env == 'development' ? `git log -1`.split("\n")[0] : `tail -1 #{Rails.root.to_s.split("releases")[0]}revisions.log` %>
    <%- m = version_str.match(/Branch (.*) \(at (.*)\) deployed as release (.*) by (.*)/) %>
    <%- branch = m[1]; repo_version = m[2]; release = m[3]; by = m[4] %>
    <%- version = "repo-version: #{repo_version[0..8]}, released: #{release} by: #{by}" %>
  <%- end %>
  <%- if local_server? %>
    <%- url = URI("#{Carambus.config.carambus_api_url}/versions/current_revision") -%>
    <%- Rails.logger.info ">>>>>>>>>>>>>>>> GET #{url} <<<<<<<<<<<<<<<<" -%>
    <%- uri = URI(url) -%>

    <%- json_io = Version.http_get_with_ssl_bypass(uri) -%>
    <%- vers = JSON.parse(json_io) -%>
    <%- revision = vers["current_revision"] -%>
  <%- end %>
  <pre>
    Rails:    <%= Rails.version %>
    Environment: <%= Rails.env %>
    <%= "API Server: #{Carambus.config.carambus_api_url}" if local_server? %>
    Carambus Sync Status: <%= "local: #{Setting.key_get_value("last_version_id")} - " if local_server? %>API Server: <%= Version.last_version %>
    Repo-Branch: <%= branch %>
    Last: <%= version %>
  </pre>

  <%- if local_server? && revision != repo_version -%>
    <%- # Check if API server version is newer using git merge-base -%>
    <%- begin -%>
      <%- if Rails.env.development? -%>
        <%- # In development, check if local commit is ancestor of API commit -%>
        <%- api_is_newer = system("cd #{Rails.root} && git merge-base --is-ancestor #{repo_version} #{revision} 2>/dev/null") -%>
      <%- else -%>
        <%- repo_path = get_repo_path -%>
        <%- if repo_path && File.directory?(repo_path) -%>
          <%- # Fetch latest commits from origin to ensure we have the API commit -%>
          <%- `git --git-dir=#{repo_path} fetch origin 2>/dev/null` -%>
          <%- # Check if local commit is ancestor of API commit (means API is ahead) -%>
          <%- api_is_newer = system("git --git-dir=#{repo_path} merge-base --is-ancestor #{repo_version} #{revision} 2>/dev/null") -%>
        <%- else -%>
          <%- api_is_newer = false -%>
        <%- end -%>
      <%- end -%>
    <%- rescue => e -%>
      <%- Rails.logger.error "Error comparing versions: #{e.message}" -%>
      <%- api_is_newer = false -%>
    <%- end -%>

    <%- if api_is_newer -%>
      <div class="text-red-700 mb-4 font-bold">
        ‚ö†Ô∏è Version is out-of-date (api.carambus.de has version <%= revision[0..8] %>)
      </div>
    <%- else -%>
      <div class="text-green-700 mb-4">
        ‚úì Version differs from API server (local: <%= repo_version[0..8] %>, API: <%= revision[0..8] %>)
      </div>
    <%- end -%>

    <%- if api_is_newer -%>
      <%- changelog = git_changelog(repo_version, revision) -%>
      <%- if changelog&.any? -%>
        <div class="mb-4 p-4 bg-gray-100 dark:bg-gray-800 rounded">
          <h3 class="font-bold mb-2 text-gray-900 dark:text-gray-100">üìù Changes in latest version:</h3>
          <div class="font-mono text-sm text-gray-800 dark:text-gray-200 space-y-1">
            <%- changelog.each do |commit_line| -%>
              <div class="py-1 border-b border-gray-300 dark:border-gray-600 last:border-0">
                <%= commit_line %>
              </div>
            <%- end -%>
          </div>
        </div>
      <%- end -%>

      <div class="mb-4">
        <%= button_to "Update to latest version",
                      update_version_path,
                      method: :post,
                      data: {
                        turbo_confirm: "This will update the application to the latest version. The server will restart. Continue?"
                      },
                      class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
      </div>
    <%- end -%>
  <%- end -%>
  
  <!--    Carambus: <%#= Rails.env == 'development' ? `git log -10` : `#{"tail -1 #{Rails.root}/../../revisions.log"}` %>-->
</div>

