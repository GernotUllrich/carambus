<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">üîç Scraping Monitor Dashboard</h1>
  
  <!-- Time Range Filter -->
  <div class="mb-6 flex gap-2">
    <%= link_to "24 Hours", scraping_monitor_path(days: 1), 
        class: "px-4 py-2 rounded #{@time_range == 1 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" %>
    <%= link_to "7 Days", scraping_monitor_path(days: 7), 
        class: "px-4 py-2 rounded #{@time_range == 7 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" %>
    <%= link_to "30 Days", scraping_monitor_path(days: 30), 
        class: "px-4 py-2 rounded #{@time_range == 30 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" %>
    <%= link_to "90 Days", scraping_monitor_path(days: 90), 
        class: "px-4 py-2 rounded #{@time_range == 90 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" %>
  </div>
  
  <!-- Anomalies Alert -->
  <% if @anomalies.any? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
      <strong class="font-bold">‚ö†Ô∏è Anomalies Detected!</strong>
      <ul class="mt-2">
        <% @anomalies.each do |anomaly| %>
          <li><%= anomaly[:operation] %>: <%= anomaly[:issue] %></li>
        <% end %>
      </ul>
    </div>
  <% else %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
      <strong class="font-bold">‚úÖ All Systems Operational</strong>
    </div>
  <% end %>
  
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <% total_created = @operations_stats.sum { |s| s[:total_created] } %>
    <% total_updated = @operations_stats.sum { |s| s[:total_updated] } %>
    <% total_deleted = @operations_stats.sum { |s| s[:total_deleted] } %>
    <% total_errors = @operations_stats.sum { |s| s[:total_errors] } %>
    
    <div class="bg-green-100 border-l-4 border-green-500 p-4">
      <div class="text-sm text-green-800">Created</div>
      <div class="text-3xl font-bold text-green-900"><%= total_created %></div>
    </div>
    
    <div class="bg-blue-100 border-l-4 border-blue-500 p-4">
      <div class="text-sm text-blue-800">Updated</div>
      <div class="text-3xl font-bold text-blue-900"><%= total_updated %></div>
    </div>
    
    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4">
      <div class="text-sm text-yellow-800">Deleted</div>
      <div class="text-3xl font-bold text-yellow-900"><%= total_deleted %></div>
    </div>
    
    <div class="bg-red-100 border-l-4 border-red-500 p-4">
      <div class="text-sm text-red-800">Errors</div>
      <div class="text-3xl font-bold text-red-900"><%= total_errors %></div>
    </div>
  </div>
  
  <!-- Operations Table -->
  <div class="bg-white shadow rounded-lg mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold">üìä Operations (Last <%= @time_range %> Days)</h2>
    </div>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operation</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Runs</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Duration</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Errors</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Success Rate</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Run</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @operations_stats.each do |stats| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <%= link_to stats[:operation], scraping_monitor_operation_path(stats[:operation], days: @time_range), 
                  class: "text-blue-600 hover:text-blue-800 font-medium" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap"><%= stats[:total_runs] %></td>
            <td class="px-6 py-4 whitespace-nowrap"><%= "#{stats[:avg_duration]}s" %></td>
            <td class="px-6 py-4 whitespace-nowrap text-green-600"><%= stats[:total_created] %></td>
            <td class="px-6 py-4 whitespace-nowrap text-blue-600"><%= stats[:total_updated] %></td>
            <td class="px-6 py-4 whitespace-nowrap <%= stats[:total_errors] > 0 ? 'text-red-600 font-bold' : 'text-gray-600' %>">
              <%= stats[:total_errors] %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded <%= stats[:success_rate] >= 95 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                <%= "#{stats[:success_rate]}%" %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= stats[:last_run]&.strftime('%Y-%m-%d %H:%M') || 'N/A' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <!-- Recent Logs -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold">üìù Recent Logs (Last 50)</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operation</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C/U/D</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Errors</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @recent_logs.each do |log| %>
            <tr class="<%= log.error_count > 0 ? 'bg-red-50' : 'hover:bg-gray-50' %>">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= log.executed_at.strftime('%Y-%m-%d %H:%M:%S') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <div class="font-medium text-gray-900"><%= log.operation %></div>
                <% if log.context.present? %>
                  <div class="text-xs text-gray-500"><%= log.context %></div>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= "#{log.duration&.round(2)}s" %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="text-green-600"><%= log.created_count %></span> /
                <span class="text-blue-600"><%= log.updated_count %></span> /
                <span class="text-yellow-600"><%= log.deleted_count %></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <% if log.error_count > 0 %>
                  <span class="px-2 py-1 text-xs font-bold bg-red-100 text-red-800 rounded">
                    <%= log.error_count %> errors
                  </span>
                <% else %>
                  <span class="text-green-600">‚úì</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Auto-refresh every 30 seconds
setTimeout(() => location.reload(), 30000);
</script>
