# frozen_string_literal: true

require "#{Rails.root}/app/helpers/application_helper"
require "aasm-diagram" if Rails.env == "development"

namespace :adhoc do
  desc "Find club_ids from season_participations that don't exist in clubs table"
  task find_orphaned_club_ids: :environment do
    # Get all club_ids from season_participations
    participation_club_ids = SeasonParticipation.distinct.pluck(:club_id).compact

    # Get all club_ids that exist in clubs table
    existing_club_ids = Club.pluck(:id)

    # Find orphaned club_ids (in season_participations but not in clubs)
    orphaned_club_ids = participation_club_ids - existing_club_ids

    puts "Total club_ids in season_participations: #{participation_club_ids.count}"
    puts "Total club_ids in clubs table: #{existing_club_ids.count}"
    puts "Orphaned club_ids: #{orphaned_club_ids.count}"

    if orphaned_club_ids.any?
      puts "\nOrphaned club_ids: #{orphaned_club_ids.sort}"

      # Show some details about the orphaned records
      orphaned_participations = SeasonParticipation.where(club_id: orphaned_club_ids)
      puts "\nSample orphaned season_participations:"
      orphaned_participations.limit(10).each do |sp|
        puts "  ID: #{sp.id}, Club ID: #{sp.club_id}, Player: #{sp.player&.name}, Season: #{sp.season&.name}"
      end
    else
      puts "\nNo orphaned club_ids found!"
    end
  end

  desc "Translate page content"
  task translate_page_content: :environment do
    page = Page[4]
    translated_content = DeeplTranslationService.translate(page.content, 'de', 'en')
    # page.update(content: translated_content)
    puts translated_content
  end
  desc "Current Test old"
  task test_old: :environment do
    Region.find_by_shortname("NBV").scrape_clubs_old(player_details: true)
  end

  desc "Current Test"
  task test: :environment do
    # Region.scrape_regions_cc
    # Region.find_by_shortname("DBU").scrape_clubs_cc
    # Club.find_duplicates
    # Season.find_by_name("2022/2023").scrape_single_tournaments_public_cc
    # Region.find_by_shortname("NBV").scrape_clubs(player_details: true)
    # Club.scrape_clubs(player_details: true, restrict_to_club_shortname: "BC Aalen")
    # Club[458].merge_clubs(2305)
    # Player.merge_players(Player[102], Player[8875])
    # Player.update_teams_fl_names
    # Player.merge_duplicates
    # Club.merge_duplicates
    # League.scrape_leagues_from_cc(Region.find_by_shortname("DBU"), Season.current_season, league_details: false)
    # Season.current_season.scrape_single_tournaments_public_cc
    # t = Tournament.last
    # tm = t.create_tournament_monitor!
    # puts tm.andand.attributes
    # Region.find_by_shortname("DBU").scrape_locations
    # Player.cross_domain_player_search("Gerd Schmitz")
    # Player.cross_domain_player_search("Arik Reiter")
    # Player.cross_domain_player_search("Rudolf Held")
    # Player.cross_domain_player_search("Andreas Fischer")
    # Player.cross_domain_player_search("JÃ¼rgen Adam")
    # Player.cross_domain_player_search("Alexander Koch")
    # Player.cross_domain_player_search("Klaus Schneider")
    # Player.cross_domain_player_search("Kevin Becker")
    # Player.analyse_duplicates(only_shortnames: "DBU", partial_recalc: true)
    # Player.analyse_duplicates
    # Player.merge_players_when_matching_club_and_dbu_nr
    # Club.merge_duplicates
    # Club.merge_duplicates_method_two
    # Player.merge_duplicates
    # Player.merge_duplicates_when_uniq_in_cc
    # Region.where(shortname: %w{BVRP BVNRW BVW BVS SBV TBV}).each {|r| r.scrape_clubs(player_details: true)}
    # Region.find_by_shortname("BVBW").scrape_locations
    # Location.scrape_locations
    # pm = PartyMonitor.last
    # res = pm.party.intermediate_result
    # puts "RESULT #{res.join(":")}"
    # Club.scrape_clubs(from_background: true, player_details: true)
    # Location.scrape_locations
    # tm = TableMonitor.new
    # AASMDiagram::Diagram.new(tm, 'doc/doc-local/table_monitor.png')
    # pm = PartyMonitor.new AASMDiagram::Diagram.new(pm, 'doc/doc-local/party_monitor.png')
    # League.scrape_leagues_from_cc(Region.find_by_shortname("BVBW"), Season.current_season, league_details: true,  first_five_parties_only: true, optimize_api_access: false)
    # Version.update_from_carambus_api
    # location = Tournament[242].match_location_from_location_text
    # Tournament[13215].scrape_single_tournament_public(reload_game_results: false)
    # Region[1].scrape_single_tournament_public(Season.current_season, optimize_api_access: true)
    # Location.scrape_locations
    # Region.where(cc_id:18).first.scrape_locations
    # Season.current_season.scrape_single_tournaments_public_cc(optimize_api_access: true)
    # @location = Location[1]
    # @tables = @location.tables.includes(:table_monitor)
    # @tables.map { |t| t.table_monitor.tournament_monitor_id }
    # tm = Tournament[15743].tournament_monitor
    # tm.update_ranking
    # season = Season.current_season
    # League.scrape_leagues_from_cc(Region.find_by_shortname("BVBW"), season, league_details: true, optimize_api_access: false)
    # league = League[8695]
    # league.scrape_single_league_from_cc(league_details: true)
    # League[8891].scrape_single_league_from_cc(league_details: true)
    # Player.find_duplicates_by_dbu_nr_simple.each do |dbu_nr, count|
    #   ids = Player.where(dbu_nr: dbu_nr).ids
    #   master_id = ids.pop
    #   Player.merge_players(Player[master_id], Player.where(id: ids).to_a)
    # end

    # ids = [37830, 37836, 37836, 37845, 37845, 37851, 37866, 39857, 39871, 39871, 39874, 39879, 92111, 64071, 74115, 80001, 106322, 91816, 91816, 105746, 94655, 114641, 31790, 112602, 112613, 112637, 112637, 112642, 112642, 118888, 118381, 118388, 118394, 118402, 118402, 118404, 118404, 123518, 118425, 118421, 118425, 118431, 118431, 152376, 123417, 123892, 123892, 20828, 129242, 129255, 135311, 135348, 20622, 135829, 135829, 135833, 135834, 135834, 136498, 151941, 151941, 151958, 151958, 151975, 151985, 151985, 152483, 152626, 152483, 153270, 153270, 153276, 153276, 159444, 153344, 159450, 170936, 164868, 164889, 164934, 24822, 164395, 170949, 170952, 170968, 27401, 171584, 171615, 171615, 172188, 171646, 19299, 19302, 171677, 172630, 172630, 172630, 172630, 189428, 179696, 27201, 27207, 190748, 189780, 189948, 190789, 190907, 190907, 190912, 192526, 193636, 193644, 193661, 193661, 193756, 193768, 193777, 189449, 193627, 193627, 197575, 197571, 197575, 193666, 193666, 199006, 193105, 194378, 194403, 197578, 192717, 199786, 199786, 199794, 199794, 210218, 190831, 201955, 201955, 190259, 192741, 217978, 197316, 218074, 203980, 210241, 210273, 204003, 190434, 197551, 204082, 217974, 218398, 218344, 204040, 203998, 218133, 217815, 190837, 218306, 218353, 204005, 197542, 204034, 218062, 197545, 220352, 218140, 204034, 204058, 218124, 203994, 202102, 202102, 202103, 217788, 218134, 204043, 197536, 210237, 210290, 204082, 218360, 218152, 197561, 203994, 218298, 210391, 210264, 217976, 217968, 218394, 204017, 210001, 204040, 204079, 218149, 210170, 217976, 197487, 218153, 210186, 218128, 218128, 204101, 197447, 204081, 190281, 218402, 193693, 193693, 218150, 218150, 197532, 210403, 217969, 218139, 218097, 199808, 217951, 210186, 218289, 203679, 203679, 203679, 203679, 203679, 217783, 220353, 203924, 218361, 204034, 218394, 197509, 197548, 218305, 204069, 197422, 218309, 210409, 197547, 204001, 204005, 218116, 218313, 203963, 218008, 204555, 204555, 218077, 204014, 210416, 197548, 204342, 204342, 218119, 228898, 218308, 218351, 204480, 204480, 210206, 218266, 197532, 204046, 205262, 205266, 205266, 204062, 203928, 204011, 204056, 218153, 197472, 218195, 218140, 218394, 197504, 204358, 204041, 210108, 210088, 197362, 218153, 218360, 205115, 218066, 204592, 204592, 205123, 204049, 197458, 217951, 197497, 218118, 204075, 204349, 204349, 204101, 218394, 197378, 218074, 217952, 197433, 203692, 203692, 203692, 203694, 218295, 203692, 203692, 197357, 218433, 210384, 218124, 218439, 203944, 204109, 197524, 204023, 220333, 210273, 197549, 218138, 220351, 218016, 217799, 218323, 218153, 197542, 203710, 218016, 203704, 203710, 203704, 203710, 203704, 220354, 218130, 203704, 203707, 218318, 197555, 203723, 203723, 203723, 203723, 203723, 203724, 203724, 218066, 218285, 218320, 210366, 204445, 204449, 218148, 197503, 218116, 197530, 218297, 197486, 204037, 210264, 218017, 197551, 217963, 218149, 218148, 204056, 218150, 218116, 218140, 218097, 197351, 228909, 197538, 218085, 218126, 210416, 218405, 218148, 204032, 204043, 197541, 218085, 218117, 217799, 218296, 218257, 218119, 220352, 218439, 197472, 218321, 210399, 218149, 220353, 204010, 218299, 218286, 203931, 221199, 218318, 218145, 210402, 218141, 218308, 218387, 218153, 218300, 217959, 197458, 204043, 218178, 218151, 204037, 218287, 218389, 228905, 218150, 218389, 204040, 220352, 218124, 218442, 218128, 210290, 197308, 210170, 218133, 204075, 218155, 204109, 218118, 218149, 210276, 217974, 197498, 204062, 218119, 210223, 210223, 218150, 228905, 197332, 218123, 218399, 228896, 218145, 220352, 210384, 197529, 218397, 218319, 197538, 210343, 202272, 202272, 204008, 210253, 218261, 218153, 217957, 217975, 218389, 217893, 217914, 197464, 218132, 220353, 197434, 218077, 207808, 207808, 207816, 207816, 207825, 207825, 207827, 207834, 207834, 197390, 208417, 218130, 197403, 208432, 218117, 218124, 197554, 217815, 204017, 217980, 204082, 228896, 218116, 197436, 218128, 197453, 217980, 208237, 204081, 218133, 208477, 208477, 218351, 218349, 204027, 197423, 218185, 197573, 210088, 208043, 218387, 218134, 217963, 218130, 203955, 218356, 217815, 204017, 217815, 218291, 218200, 218344, 218433, 218300, 218298, 218011, 218126, 218145, 218150, 218133, 197554, 218123, 218290, 217959, 218149, 204056, 218151, 197556, 215837, 205280, 205280, 218118, 218152, 210366, 197580, 228906, 204066, 218140, 219468, 218387, 218126, 218399, 218299, 197412, 197466, 218130, 217953, 203980, 218140, 218442, 218118, 216011, 216542, 204334, 219459, 216467, 216440, 209137, 209145, 209150, 209403, 220813, 209414, 209414, 209439, 209194, 216714, 213974, 190248, 203506, 219707, 219716, 216283, 209494, 216458, 209494, 209494, 216455, 209866, 209866, 209868, 209868, 209871, 209868, 209871, 209871, 209877, 209510, 215719, 215846, 209540, 209540, 209545, 209545, 209552, 219465, 216714, 209887, 209887, 209877, 209877, 209877, 209877, 209881, 209881, 209887, 209881, 216440, 216721, 219689, 190287, 190670, 190337, 216730, 216449, 209595, 209595, 209595, 216730, 209603, 209603, 209603, 209603, 219875, 219465, 209612, 215743, 219879, 216542, 216295, 220745, 219499, 215827, 215739, 216006, 209623, 209623, 209628, 209628, 209630, 209630, 209630, 209634, 209634, 209638, 209638, 209638, 209644, 190317, 219707, 207887, 190248, 210391, 210389, 216544, 219893, 216352, 216467, 219549, 216006, 216717, 219884, 219695, 190337, 219689, 190297, 216458, 216455, 215827, 219888, 215568, 190297, 219875, 215846, 216458, 219698, 219870, 207887, 216476, 216027, 203335, 204424, 216744, 203506, 215739, 213978, 216542, 190307, 219499, 219698, 216721, 219549, 220813, 216283, 216544, 190327, 216717, 215719, 197180, 190317, 190327, 220742, 203335, 190693, 216744, 204334, 204423, 216027, 219884, 219870, 190287, 205271, 220772, 207843, 207851, 203728, 203728, 203728, 203728, 203729, 203728, 203728, 208433, 202280, 72338, 209199, 209518, 209518, 209653, 209653, 209653, 209653, 209651, 209653, 204066, 204064, 204066, 204066, 209416, 209573, 204105, 204113, 202280, 202850, 205194, 204646, 204646, 212746, 197324, 203043, 203745, 203745, 203745, 203742, 203742, 203745, 203745, 203043, 209528, 209523, 209523, 209528, 209662, 209662, 209668, 209668, 209668, 209668, 197392, 209893, 209890, 209893, 209893, 209893, 204011, 208446, 208446, 208479, 208479, 202301, 202301, 203053, 204650, 204650, 204650, 208457, 207865, 207865, 205257, 203747, 208452, 208452, 209188, 209584, 209584, 209671, 209671, 209671, 209663, 209663, 209663, 209663, 209675, 209675, 209895, 209895, 209895, 209679, 202875, 209533, 209533, 207876, 207876, 209679, 209679, 209680, 209678, 209677, 209899, 209899, 209899, 209899, 209899, 202790, 209436, 209436, 209436, 209436, 203061, 203061, 205259, 194099, 204083, 203970, 213966, 209923, 194110, 217696, 209788, 203974, 209924, 209944, 194188, 217641, 210237, 209882, 209722, 209898, 209891, 193910, 209799, 193917, 204424, 204423, 209911, 209725, 217544, 209870, 217431, 217596, 209911, 217528, 209888, 209896, 194221, 217587, 217652, 217588, 217641, 209788, 209917, 217482, 217586, 217711, 217708, 217655, 209885, 217641, 217478, 194096, 194059, 209823, 217435, 209910, 217532, 209937, 209950, 209774, 209743, 194197, 209924, 209918, 217438, 193898, 209901, 217548, 217425, 217641, 209859, 209767, 209862, 194186, 217653, 193910, 193930, 194164, 217438, 209907, 217590, 209914, 217606, 217588, 217752, 217643, 217660, 217585, 209839, 194026, 209823, 221174, 194207, 194150, 209870, 209939, 209729, 194220, 209823, 209878, 194184, 222521, 209920, 217425, 217599, 217536, 194180, 209918, 194188, 221174, 217547, 194184, 209857, 217495, 209729, 221177, 209894, 194072, 209879, 194221, 221177, 194090, 209829, 209931, 194180, 194087, 209925, 217544, 209915, 217603, 209852, 217698, 193937, 209825, 217593, 194221, 217544, 217528, 217585, 209898, 209756, 217596, 217537, 209878, 209841, 209949, 194014, 209761, 217754, 194026, 217640, 209951, 209713, 194165, 209902, 209906, 209713, 209778, 217548, 209935, 217596, 194150, 217478, 194220, 217550, 209901, 221174, 194200, 209915, 209884, 209867, 209894, 221177, 217475, 209924, 217438, 217478, 194037, 217708, 217655, 209733, 209925, 209891, 222521, 209799, 217438, 209833, 209914, 209775, 209847, 217644, 217495, 209767, 209737, 209745, 209928, 217652, 209788, 194200, 209902, 209923, 209795, 217653, 209925, 217652, 209885, 209817, 194198, 217707, 217585, 194189, 209935, 217656, 217752, 209911, 217593, 217752, 217643, 209911, 194070, 209733, 193934, 194154, 209721, 217532, 217648, 194186, 217705, 194212, 209902, 209722, 217588, 217652, 194044, 217586, 209828, 217705, 217662, 217708, 209925, 209774, 209941, 209808, 193930, 209918, 194118, 217537, 217536, 194224, 193934, 209813, 217654, 209950, 209935, 217754, 209949, 217478, 209930, 193924, 217587, 194031, 217662, 209928, 194093, 217601, 217696, 209882, 209756, 209924, 209711, 194037, 194176, 209944, 217663, 209874, 217661, 217705, 209909, 209921, 217596, 217739, 217645, 209844, 217659, 209867, 194118, 217531, 217548, 209949, 209737, 217603, 217595, 209926, 217708, 217662, 209930, 221176, 209864, 217550, 209932, 209789, 222524, 209721, 217640, 209749, 209924, 217656, 209951, 217711, 209879, 209874, 209884, 222524, 209922, 217603, 209844, 194005, 209932, 209901, 209914, 217536, 217420, 194207, 217601, 209862, 217543, 209725, 209935, 217586, 217711, 217660, 194088, 193898, 221174, 209917, 209812, 209841, 194176, 209864, 194031, 194110, 222524, 222524, 209813, 217543, 217649, 220410, 194174, 217659, 217419, 194132, 209880, 209841, 209745, 209898, 193917, 209737, 209939, 209713, 217752, 209894, 222521, 221176, 209880, 209812, 209770, 226596, 194018, 209929, 217709, 194212, 222522, 209852, 209845, 217659, 222521, 209735, 194165, 209852, 193899, 209894, 209920, 217599, 217531, 209920, 209933, 209902, 209775, 217751, 209733, 194188, 193899, 194197, 219957, 193994, 209928, 194206, 209901, 194189, 209910, 209761, 217435, 194197, 221176, 209938, 194207, 209851, 209929, 194052, 209795, 217594, 217439, 217653, 209920, 209929, 217588, 193994, 217158, 217645, 209949, 209729, 217701, 209795, 209882, 194014, 217603, 209888, 209867, 221177, 217544, 209745, 209938, 209920, 209775, 217585, 222526, 209914, 194198, 209775, 217601, 209923, 194212, 209923, 194072, 194154, 221176, 209924, 209914, 222526, 220412, 221496, 214037, 229643, 220384, 214002, 214017, 217742, 217585, 209894, 217536, 194212, 194133, 194194, 217696, 217596, 209894, 209713, 194142, 209938, 194196, 209869, 209929, 194221, 209898, 226596, 194164, 209926, 221174, 217751, 209854, 221177, 217648, 209949, 209937, 217739, 217420, 209829, 209817, 220384, 217548, 209733, 217596, 217649, 217439, 217475, 209857, 217606, 209845, 209902, 209914, 197740, 212746, 197783, 214031, 209746, 217644, 214034, 220402, 209749, 217659, 221174, 220807, 220807, 193918, 194142, 209855, 217696, 209857, 193914, 229643, 214012, 214001, 209933, 209937, 194000, 222522, 218623, 221639, 221199, 218399, 229654, 218295, 212771, 229638, 212743, 222608, 217595, 209896, 209788, 209906, 209847, 209937, 209770, 194196, 194133, 209901, 194197, 217644, 217641, 217547, 209828, 193904, 217531, 217606, 209901, 194166, 209922, 217593, 222526, 217653, 214029, 194000, 194210, 220394, 220397, 214017, 222608, 209949, 209953, 217754, 217606, 209933, 194044, 194194, 209795, 220304, 209920, 194132, 217431, 217659, 217711, 194210, 209922, 217754, 209902, 209857, 214029, 220381, 220412, 212771, 214031, 220394, 218622, 214027, 220365, 220395, 212756, 212721, 220370, 214008, 214001, 229633, 220412, 222608, 212752, 229643, 219976, 214027, 212730, 214001, 220371, 212703, 229636, 220816, 221627, 229636, 219976, 221627, 220398, 212743, 220371, 214012, 212771, 214031, 220412, 229655, 220379, 220395, 218297, 220722, 214008, 216849, 214000, 220402, 212768, 214008, 221639, 212768, 220381, 214034, 197783, 197783, 220410, 220379, 214019, 218622, 214031, 214029, 218577, 218623, 197740, 220365, 214002, 220412, 208594, 208575, 190792, 208590, 208520, 208553, 208587, 208572, 208575, 190851, 208572, 214029, 214001, 214019, 220371, 220397, 218626, 229638, 220412, 217745, 208557, 208508, 208571, 208529, 208511, 208534, 190850, 208547, 208571, 220214, 190810, 208535, 208482, 208577, 208547, 208563, 190859, 208500, 217425, 217328, 190753, 208545, 217745, 217746, 217746, 217704, 190857, 190793, 208557, 208482, 208493, 220398, 208489, 208557, 208569, 208576, 208542, 208573, 208588, 208497, 220370, 220370, 208497, 190857, 208592, 208581, 208575, 190851, 208573, 208562, 190792, 208542, 208592, 190804, 208579, 208581, 208538, 190851, 208512, 208545, 208592, 208562, 208493, 208553, 208538, 208575, 208550, 190796, 190749, 220825, 208593, 190804, 208508, 208562, 208511, 208579, 208517, 208582, 208557, 208582, 190859, 217170, 208593, 208587, 220374, 208544, 220374, 208577, 190855, 217543, 217543, 208521, 190798, 208567, 208561, 208593, 208555, 190753, 208593, 217705, 208547, 208576, 208520, 208556, 209405, 190846, 208555, 190847, 208550, 208482, 208595, 190850, 208590, 221655, 220372, 220372, 208532, 190850, 217038, 193641, 208109, 220287, 190796, 208587, 208529, 208547, 208534, 208595, 208587, 208538, 208556, 190846, 208563, 208562, 208550, 208550, 190851, 218546, 209421, 218530, 218306, 197538, 208096, 221977, 221977, 221977, 221664, 221977, 221977, 220743, 209405, 209649, 217173, 217173, 220834, 220834, 209677, 218480, 193649, 221973, 218480, 209616, 209606, 218626, 220361, 221884, 221884, 218626, 218626, 221205, 220401, 220401, 220401, 193659, 220401, 208085, 221973, 218549, 205096, 209424, 209649, 205110, 220843, 220843, 209633, 221973, 218480, 208122, 209428, 219992, 193690, 193671, 217345, 217345, 217345, 208085, 209649, 218607, 202189, 218607, 218577, 218607, 218607, 209428, 208137, 220361, 209596, 208109, 221131, 208096, 205123, 221135, 209641, 222526, 205105, 193659, 209424, 209411, 205115, 221205, 193682, 218530, 218520, 209424, 209606, 220310, 220310, 193682, 208123, 218520, 208137, 209616, 193665, 209626, 205110, 209633, 216878, 220301, 193641, 193671, 221205, 221205, 218549, 220313, 199769, 220361, 218630, 218630, 218630, 205105, 218546, 205115, 221205, 209411, 221977, 209641, 220315, 220315, 222545, 221980, 221980, 221694, 218323, 221980, 221980, 221980, 221980, 221980, 197570, 197571, 222545, 193632, 227137, 227137, 209596, 197560, 205115, 192576, 217345, 217154, 209496, 221205, 208122, 209660, 221973, 208123, 217181, 209233, 193334, 209169, 217181, 218530, 208104, 218521, 221973, 217712, 218521, 217754, 217754, 221177, 217663, 202189, 193690, 193653, 228817, 221907, 228823, 217223, 209626, 217551, 228707, 220311, 217342, 217028, 208937, 217322, 217551, 217551, 205096, 218546, 221973, 199769, 217127, 217318, 220963, 209656, 217032, 217122, 208933, 217334, 217103, 213114, 217364, 193703, 209339, 209656, 221912, 217370, 217279, 217320, 209651, 217326, 221121, 209579, 217330, 209512, 217040, 193361, 209591, 193065, 210373, 193856, 209591, 228828, 193638, 208924, 217036, 217341, 199787, 220245, 217332, 228786, 228901, 209057, 193648, 208930, 209277, 209636, 228714, 209302, 217279, 199856, 217320, 193688, 210364, 209607, 193786, 194378, 204067, 194403, 209629, 217026, 217261, 217027, 217338, 217336, 217103, 209591, 193459, 209617, 217332, 217336, 217328, 209512, 209643, 220233, 209207, 193483, 217358, 217106, 217331, 217320, 213110, 209067, 213118, 193455, 217320, 209646, 209674, 209500, 217277, 209505, 221907, 193490, 217127, 209669, 217221, 217364, 193819, 217336, 217364, 209607, 217168, 217268, 209678, 217328, 228823, 209669, 209318, 217255, 217328, 217165, 221683, 217230, 209678, 209674, 217336, 217319, 193819, 217230, 201362, 217364, 217255, 209579, 209337, 217365, 209548, 209119, 221660, 209607, 221664, 217256, 217332, 204061, 209570, 209288, 192685, 217122, 217046, 220295, 193097, 228817, 220289, 220311, 209658, 217268, 220233, 221074, 221668, 221912, 209669, 201381, 216890, 217230, 217106, 217157, 209466, 217165, 209548, 228835, 221127, 221668, 209064, 209617, 221128, 209617, 221912, 217112, 212940, 220311, 217162, 221148, 209529, 220265, 217370, 218400, 209005, 220984, 217342, 217365, 217168, 209111, 209349, 217157, 217035, 190434, 217336, 189467, 193732, 218322, 217223, 218404, 202715, 217126, 213117, 209667, 190210, 203053, 204054, 192544, 217212, 217334, 209215, 193658, 209466, 209257, 209656, 209318, 207843, 207851, 193727, 220996, 192693, 209651, 228710, 213095, 193113, 220311, 220203, 221123, 217332, 217370, 221113, 217315, 193840, 217364, 217325, 221117, 218177, 220743, 221129, 209557, 193357, 217332, 192592, 209015, 218357, 209294, 217369, 217216, 221075, 225863, 209123, 228902, 217271, 213113, 217358, 193840, 217322, 220234, 217336, 217154, 217263, 193449, 193337, 220305, 216830, 193443, 217263, 209658, 209643, 220311, 201372, 217358, 209275, 193741, 217178, 193453, 221132, 217358, 193073, 228714, 220311, 193359, 209012, 209473, 193678, 217358, 228892, 217330, 221148, 217220, 209656, 221148, 217326, 209051, 212950, 201354, 217038, 193698, 217026, 209656, 209500, 209893, 209868, 209868, 209877, 209890, 209899, 208459, 205189, 203755, 208459, 184197, 184197, 204442, 203711, 184240, 207982, 208434, 204568, 203722, 203765, 204902, 205081, 203689, 203760, 203644, 203652, 179696, 179706, 25034, 24795, 25252, 113602, 129996, 203620, 203691, 190831, 208024, 24886, 203761, 203755, 221451, 208479, 165859, 219976, 190888, 208009, 204425, 219966, 208455, 203617, 190887, 204562, 207980, 219993, 203696, 219994, 219963, 207978, 219957, 209626, 221409, 219994, 219999, 204954, 218521, 220001, 219963, 203699, 190875, 203718, 219969, 203644, 221451, 203699, 203738, 204567, 192526, 208442, 199808, 219972, 207980, 208414, 221409, 203698, 204916, 209653, 209671, 209679, 219973, 221437, 205177, 204930, 203722, 221450, 208428, 216860, 204442, 220002, 204553, 203711, 219976, 204948, 221451, 190875, 221450, 219970, 204553, 203761, 203738, 205040, 203684, 203735, 208434, 204557, 203617, 203696, 219991, 217370, 217369, 208013, 219986, 208013, 129238, 203760, 204567, 209403, 221308, 219979, 204449, 209510, 221451, 209494, 209528, 209552, 209575, 209603, 209630, 203689, 20421, 20421, 118388, 118421, 118888, 135831, 135833, 190888, 219969, 219999, 220304, 220313, 220004, 207996, 203718, 190889, 205189, 203684, 190898, 204968, 219969, 204982, 20835, 112602, 204568, 152626, 219973, 208024, 221437, 204944, 204930, 203685, 207975, 203704, 203704, 203694, 203679, 203707, 221437, 219964, 208428, 203683, 221450, 221496, 208442, 203710, 203723, 204562, 203710, 219999, 203644, 203684, 207996, 204954, 204982, 220004, 205081, 221308, 205194, 203765, 220002, 190887, 219993, 221450, 219969, 203762, 207975, 219992, 203736, 203684, 204916, 203701, 203733, 190889, 208470, 217953, 38661, 38661, 38666, 38666, 38672, 38705, 38705, 31800, 31800, 36479, 36488, 36488, 36504, 114423, 33449, 126005, 126005, 126011, 126021, 126021, 131792, 131792, 131807, 131818, 131818, 131827, 114641, 38672, 38685, 38685, 114423, 36467, 36467, 36479, 36504, 126011, 131807, 125986, 209772, 209772, 209921, 209906, 209906, 179209, 101627, 101645, 101650, 101650, 101676, 165581, 165581, 165591, 165591, 179219, 179235, 179248, 179257, 179268, 179272, 179285, 101645, 179285, 101676, 209912, 209930, 209939, 209918, 209789, 207941, 207941, 193741, 193732, 193720, 193741, 193741, 193704, 193704, 55444, 55458, 60256, 60284, 60284, 60293, 68623, 68623, 68629, 68629, 68635, 68635, 68639, 68639, 208477, 208483, 208470, 208470, 208483, 209638, 209595, 209405, 209424, 209644, 221717, 221599, 208927, 221601, 221711, 208483, 221912, 219970, 209607, 217158, 217170, 228828, 220245, 209678, 209662, 217742, 209911, 209953, 210407, 210415, 210383, 218364, 210396, 209939, 209922, 209917, 214002, 214037, 214000, 218347, 217607, 209887, 209944, 209887, 209881, 220772, 68653, 68653, 68659, 68659, 176406, 68586, 68586, 68595, 68614, 68614, 176396, 187387, 60293, 55458, 176386, 176386, 176396, 176406, 187387, 187397, 187397, 55444, 218292, 204050, 197553, 204036, 218392, 218303, 203898, 203925, 203937, 204073, 23786, 23806, 23815, 113418, 113418, 219716, 207827, 207845, 207836, 207836, 207845, 202292, 202292, 202296, 202296, 208529, 208588, 208586, 208586, 204646, 218148, 218601, 212752, 212756, 218601, 113426, 113426, 113458, 113458, 113481, 113492, 113492, 129514, 129549, 129549, 136278, 136283, 136283, 136296, 136296, 136297, 136297, 136302, 136302, 136309, 23815, 136278, 23778, 23796, 129523, 113481, 202705, 189439, 202715, 202725, 202729, 202741, 215837, 202790, 202779, 202779, 202705, 202725, 202729, 202741, 208592, 214029, 212703, 221627, 212730, 212721, 204403, 204403, 218520, 214001, 214008, 228703, 228709, 221688, 215729, 215729, 202860, 202860, 202875, 221437, 218320, 197173, 190544, 190553, 190562, 24807, 25118, 25132, 25180, 25250, 130003, 136485, 136498, 24892, 25295, 25034, 124623, 25116, 25116, 25116, 25118, 25118, 25124, 25124, 25132, 25172, 25172, 25180, 25184, 25184, 25250, 25252, 24898, 24898, 24959, 124623, 136485, 129996, 130003, 172608, 24886, 24892, 159444, 159450, 165859, 165864, 165867, 165867, 190793, 190805, 190810, 190798, 208561, 208565, 190805, 208569, 197180, 197185, 197185, 220816, 220825, 209743, 209746, 209711, 209735, 217318, 217256, 217261, 216352, 217050, 220353, 217645, 218549, 218549, 216295, 217053, 217046, 217032, 228710, 220251, 228834, 113679, 113679, 113679, 113681, 113681, 113681, 113681, 219893, 220370, 218011, 127802, 127802, 127812, 127812, 127821, 127831, 127831, 133619, 133642, 209871, 209895, 204557, 204445, 135557, 2917, 123513, 123513, 123518, 123533, 135557, 135831, 208009, 20978, 123533, 20621, 207982, 20814, 20814, 20826, 20828, 20831, 217602, 190192, 190192, 190201, 190201, 190210, 190228, 190228, 190259, 190270, 190270, 190281, 219879, 219888, 207854, 207854, 199075, 189948, 199075, 133642, 133656, 133656, 133619, 127821, 35712, 20373, 152382, 152382, 152398, 152402, 152398, 20379, 20379, 20628, 129238, 129242, 152407, 152407, 20075, 20369, 20373, 20397, 20835, 216011, 209854, 203506, 217711, 217708, 209890, 209866, 209887, 209917, 209911, 209893, 114044, 114044, 114048, 114048, 114052, 114059, 114059, 114069, 114069, 114035, 114052, 114056, 184239, 184239, 184239, 184240, 184240, 27207, 27207, 1659, 113599, 113599, 113602, 1641, 1641, 27708, 153329, 153332, 153344, 27608, 27615, 159501, 159501, 159509, 159517, 159517, 159521, 27514, 165915, 165915, 165919, 165919, 165936, 27412, 179692, 179692, 179706, 179706, 184197, 184200, 184200, 184200, 184200, 184203, 184203, 153329, 27195, 27502, 27608, 27708, 153332, 27409, 159509, 159521, 27401, 179706, 184197, 184203, 27143, 27143, 27195, 27195, 27195, 27201, 27201, 27201, 27398, 27712, 27514, 27522, 27522, 27398, 27401, 27409, 27409, 27409, 218062, 135729, 146480, 164859, 152145, 152145, 152176, 152178, 164889, 146480, 135729, 135736, 135736, 135765, 135765, 171624, 171637, 146488, 146488, 152151, 152151, 152176, 152178, 164840, 164840, 164847, 164847, 164859, 164868, 164872, 164872, 164876, 164876, 164903, 171619, 171619, 171624, 171629, 171629, 171637, 171646, 210206, 210108, 210218, 204902, 203661, 203661, 203652, 207978, 19296, 123358, 118381, 118394, 123380, 123397, 128880, 146065, 128916, 152605, 135301, 135348, 170949, 170952, 170970, 178391, 164357, 164397, 164402, 164402, 164404, 164404, 178397, 112629, 19302, 112607, 112607, 112613, 123358, 123364, 123364, 123367, 123367, 123373, 123373, 123380, 123397, 123406, 123406, 123411, 123411, 123417, 128880, 128883, 128883, 128887, 128887, 128894, 128894, 128899, 128899, 128901, 128901, 128916, 178391, 135301, 135311, 135330, 135330, 146065, 146101, 146101, 151975, 152585, 152585, 152591, 152591, 152597, 152597, 152599, 152599, 152605, 152611, 152611, 170936, 170968, 170970, 164357, 164362, 164362, 164372, 164372, 164395, 164397, 178397, 41689, 39630, 41698, 41725, 156861, 144569, 144573, 46025, 46032, 46041, 144558, 156878, 156882, 156918, 209678, 209617, 221973, 209678, 209646, 190789, 208521, 208517, 208500, 190837, 199856, 210375, 197446, 205255, 205255, 205259, 205257, 216476, 216458, 217358, 221148, 209596, 207449, 207449, 209596, 43748, 43768, 43781, 150390, 150415, 150429, 210409, 197484, 218356, 210399, 41734, 43756, 210412, 229655, 229654, 208567, 72325, 72334, 81010, 72338, 75449, 78342, 78353, 88943, 83044, 83054, 85294, 85301, 85301, 85303, 100016, 100041, 100048, 72325, 107093, 107104, 72334, 72344, 72344, 72346, 72346, 72350, 72350, 88937, 81004, 81004, 81005, 81005, 81010, 83038, 83038, 83044, 83054, 75423, 75429, 75433, 75444, 75444, 75449, 78342, 78345, 78353, 78355, 78355, 85294, 85303, 85306, 85306, 88943, 88945, 90779, 90779, 106514, 92646, 99997, 106546, 99997, 100001, 100001, 100005, 100005, 100016, 100036, 100041, 100048, 75433, 106539, 106546, 106554, 106554, 75423, 106502, 106502, 106522, 106522, 218141, 218180, 171580, 164969, 171598, 152485, 152485, 164925, 164925, 164934, 164948, 164948, 164964, 164964, 164969, 171580, 171584, 171586, 171588, 171598, 171602, 171602, 218387, 197578, 202103, 204088, 20841, 171677, 171682, 171685, 171685, 20423, 20425, 20155, 20847, 20847, 20425, 129359, 106534, 106534, 106539, 107084, 107084, 107093, 107104, 107109, 107109, 107117, 107117, 107125, 107125, 107127, 107127, 217425, 129359, 129365, 129365, 19633, 152554, 152554, 152630, 152630, 171682, 189790, 189740, 189740, 189750, 189750, 189759, 189759, 189768, 189768, 189801, 189801, 189780, 189790, 190912, 216542, 193756, 193768, 193777, 209662, 193636, 193644, 209416, 198943, 198956, 198966, 198992, 199006, 202809, 202809, 202874, 202874, 209737, 56002, 97374, 52175, 52179, 52200, 180699, 180707, 180716, 180720, 180728, 180732, 180747, 88442, 215568, 220136, 225794, 221046, 228790, 228779, 220221, 193468, 193474, 221667, 228719, 228713, 228702, 193339, 192560, 192584, 199787, 193678, 193698, 193638, 209439, 193688, 193648, 193658, 193715, 193744, 209514, 193727, 209505, 217178, 193703, 209496, 22108, 22112, 22112, 22125, 22125, 22131, 22131, 22141, 22141, 178853, 165432, 165432, 165442, 165442, 165452, 165462, 165472, 178872, 178884, 178884, 172140, 172140, 172149, 172149, 172157, 172157, 172165, 172165, 172173, 172173, 172180, 172180, 92100, 94652, 180741, 56025, 90175, 88436, 88436, 88442, 88444, 88444, 88454, 90175, 92100, 92111, 92129, 92129, 94649, 94649, 94652, 94655, 97373, 97374, 190417, 190379, 190417, 37830, 37851, 37866, 67467, 67467, 67471, 67471, 67475, 67475, 67479, 67479, 113845, 113845, 113853, 113856, 113853, 31048, 31048, 39857, 39874, 39879, 41960, 104037, 172205, 172205, 178853, 178863, 178863, 165422, 22108, 165422, 165452, 178872, 172188, 193416, 222557, 220978, 220998, 194093, 194079, 217707, 194087, 194079, 217698, 217707, 194228, 194228, 193914, 193904, 193937, 193924, 221176, 217908, 194023, 35468, 35479, 35491, 35505, 104043, 104411, 35468, 35479, 35491, 35505, 104416, 105370, 104013, 106349, 106355, 106803, 105802, 104013, 104019, 104019, 104032, 104032, 104037, 104043, 104746, 104749, 105350, 104403, 104403, 104407, 104407, 104411, 104944, 104944, 104950, 104950, 104959, 104959, 104967, 104967, 105350, 105358, 105370, 106767, 105716, 105716, 105722, 105722, 105736, 105746, 105772, 105772, 105787, 105787, 105802, 106322, 106331, 106331, 106349, 106355, 106767, 106770, 106770, 106780, 106780, 106785, 106785, 106794, 106803, 107171, 107171, 107183, 107183, 217593, 194186, 194173, 194212, 194173, 194162, 194194, 208532, 203992, 209020, 209152, 209009, 193121, 209001, 208997, 193089, 219972, 219999, 219979, 219964, 219979, 209876, 209876, 208529, 208544, 194194, 194212, 208535, 208043, 219957, 219986, 220001, 203692, 203747, 203745, 189357, 189357, 209808, 194090, 194099, 217419, 220410, 219986, 219986, 203729, 209867, 209868, 209871, 209871, 217585, 209933, 194224, 193918, 106821, 6225, 6213, 6213, 6213, 6225, 6225, 6237, 6237, 21337, 21343, 21343, 64902, 64902, 106378, 106821, 101022, 101076, 101076, 101078, 101078, 101022, 106366, 106366, 209866, 106370, 219993, 219994, 205262, 205264, 205264, 205268, 205268, 205271, 205277, 205277, 219994, 219972, 203754, 203691, 219972, 219979, 203735, 203736, 208417, 208432, 208433, 219964, 208452, 208457, 208414, 208455, 63661, 63665, 63677, 63682, 63682, 63682, 63685, 63685, 63701, 63701, 63705, 63705, 64071, 67407, 67407, 67425, 67425, 219957, 208237, 219966, 106370, 106378, 106382, 106382, 106827, 106827, 194231, 220412, 229622, 229621, 229621, 229633, 208489, 190832, 190752, 190752, 218546, 218549, 218549, 221977, 228867, 213099, 193495, 228869, 221122, 209283, 209326, 13756, 1172, 17999, 14830, 18044, 17019, 18050, 145774, 15891, 15985, 128560, 145832, 145833, 134971, 151571, 1202, 1210, 14886, 1126, 2737, 2743, 2758, 2764, 13834, 13836, 13845, 13846, 14889, 14896, 14902, 14903, 15957, 15968, 15976, 17024, 17036, 17040, 17056, 17060, 15896, 15927, 110527, 18005, 18024, 18030, 18900, 18914, 18922, 110529, 108587, 108596, 108604, 108607, 108514, 108520, 110548, 110549, 111559, 111583, 111585, 111603, 111605, 128554, 128579, 134966, 134974, 135037, 135044, 135052, 135061, 151578, 145771, 145776, 145838, 145843, 145845, 151656, 151660, 151676, 151591, 209060, 217306, 217322, 217338, 217313, 209680, 225865, 228822, 209065, 209069, 209573, 209575, 217220, 217230, 217212, 221081, 217042, 217126, 197551, 197532, 228894, 197542, 218119, 203949, 197509, 190307, 209528, 204075, 218299, 209231, 210193, 220970, 222637, 217370, 192701, 192725, 192733, 159332, 153198, 159357, 159381, 146442, 159381, 22197, 159316, 159316, 159332, 159348, 159348, 159357, 172263, 172268, 22197, 153198, 193649, 193632, 212949, 209264, 217325, 209659, 209629, 220742, 190898, 114175, 114175, 204948, 205177, 203721, 203762, 190888, 203721, 219991, 190888, 203733, 203754, 209890, 221176, 89788, 74076, 74110, 74121, 74129, 77216, 77235, 77265, 89796, 89796, 203685, 91804, 91807, 94178, 94179, 77235, 34234, 70779, 70779, 70791, 70791, 70794, 70794, 70800, 70800, 70803, 70803, 70813, 70813, 70818, 70818, 70821, 70821, 74070, 74070, 74076, 74082, 74082, 74110, 74115, 74121, 74129, 77250, 77250, 77256, 77259, 77259, 77265, 89788, 79965, 79965, 79987, 79987, 80001, 80013, 80013, 34234, 91788, 91788, 91804, 91807, 94178, 94179, 203998, 218304, 219964, 203701, 203683, 217978, 218389, 197484, 210377, 210001, 204056, 204088, 218302, 203922, 210375, 218126, 218141, 218134, 228901, 218141, 218145, 218017, 220722, 216739, 219468, 217645, 190693, 208538, 208594, 208565, 208512, 217277, 209421, 209660, 209606, 208104, 193665, 209649, 209529, 218546, 193653, 217033, 209473, 217216, 217320, 193720, 220279, 209669, 209591, 209222, 193446, 209120, 217049, 217322, 221075, 193856, 220234, 217313, 225865, 216837, 209636, 217162, 193486, 209651, 217221, 219993, 203644, 203698, 204944, 204968, 203620, 19296, 1659, 19633, 1176, 1193, 2917, 2927, 19299, 20810, 20369, 20397, 20423, 20075, 20155, 20978, 20621, 20628, 20817, 20817, 20826, 20827, 20827, 20831, 20830, 20841, 25254, 21337, 24807, 23778, 24880, 24880, 24950, 24950, 25254, 33449, 27401, 27412, 27412, 31779, 31779, 31790]
    # League.joins(:parties).where(parties: {id:ids}).find_each do |league|
    #   league.scrape_single_league_from_cc(league_details: true)
    # end
    # Club[363].merge_clubs([1184,1465], force_merge: true)
    # League.where("source_url ilike 'https://westfalenbillard.net/sb_spielplan.php?p=12--2024/2025-200%'").all.each do |league|
    #   league.scrape_single_league_from_cc(league_details: true)
    # end
    # League[8682].scrape_single_league_from_cc(league_details: true)
    # Club[3013].update(region_id: 2)
    Tournament[15799].scrape_single_tournament_public(reload_game_results: true)
  end

  desc "Sequence Reset"
  task sequence_reset: :environment do
    Version.sequence_reset
  end

  desc "fix source_urls"
  task fix_source_urls: :environment do
    Rails.application.eager_load!

    ActiveRecord::Base.descendants.each do |model|
      # Skip abstract models
      next if model.abstract_class?

      if model.column_names.include?('source_url')
        # this model has 'source_url' as a field
        model.where("source_url ilike '%ndbv.club-cloud.de%'").all.each do |m|
          m.source_url = m.source_url.gsub("ndbv.club-cloud.de", "ndbv.de")
          m.save
        end
        model.where("source_url ilike '%saar.club-cloud.de%'").all.each do |m|
          m.source_url = m.source_url.gsub("saar.club-cloud.de", "billard-ergebnisse.de")
          m.save
        end
        model.where("source_url ilike '%billard-union.net%'").all.each do |m|
          m.source_url = m.source_url.gsub("billard-union.net", "billard-ergebnisse.de")
          m.save
        end
        model.where("source_url ilike '%bvw.club-cloud.de%'").all.each do |m|
          m.source_url = m.source_url.gsub("bvw.club-cloud.de", "westfalenbillard.net")
          m.save
        end
        model.where("source_url ilike '%bbbv.club-cloud.de%'").all.each do |m|
          m.source_url = m.source_url.gsub("bbbv.club-cloud.de", "billard-brandenburg.net")
          m.save
        end
      end
    end
  end

  desc "fix season participations"
  task fix_season_participations: :environment do
    {
      "BC" => /(Billard-Club|Billardclub)/,
      "BSV" => nil,
      "BV" => /(Billard-Verein|Billardverein)/,
      "BV Pool" => nil,
      "LSV" => nil,
      "MSV" => nil,
      "PBC" => nil,
      "PC" => nil,
      "Pool" => nil,
      "SC" => nil,
      "SF" => nil,
      "SG" => nil,
      "SV" => nil,
      "TSG" => nil,
      "TSV" => nil,
      "TV" => nil,
      "VfB" => nil,
      "XXX" => nil,
      "XXXX" => nil
    }.each do |k, v|
      Club.where(name: k).each do |c|
        c.season_participations.each do |sp0|
          player = sp0.player
          clubs = sp0.player.season_participations.order(season_id: :desc).map { |spx|
            spx.club
          }.uniq
          club = clubs.select { |c| v.present? && c.name =~ v }.first
          club ||= clubs.select { |c| c.name != k }.first
          other_clubs = clubs.select { |c| (v.blank? || c.name !~ v) && c.name != k }
          if club.present?
            player.season_participations.each do |sp|
              spp = SeasonParticipation.where(club_id: club.id, player_id: player.id, season_id: sp.season_id).first
              if sp.club.name == k
                if spp.blank?
                  sp.club_id = club.id
                  sp.save
                else
                  sp.destroy
                end
              end
            end
          else
            sp0.destroy
          end
          if other_clubs.blank?
            sp0.destroy
          end
        end
        c.destroy
      end
    end
  end

  desc "Scrape NDBV Website"
  task scrape_ndbv_de: :environment do
    IonContent.scrape_website
  end

  desc "List module_type frequencies"
  task list_module_types: :environment do
    IonModule.list_module_types
  end

  desc "Scrape NDBV Website Images"
  task scrape_ndbv_de_images: :environment do
    IonContent.scrape_images
  end

  desc "Scrape NDBV Down loads"
  task scrape_downloads: :environment do
    IonContent.scrape_downloads
  end

  desc "populate_tables"
  task populate_tables: :environment do
    tm = TournamentMonitor[50000002]
    tm.populate_tables
  end

  desc "Melde Tournament"
  task test_add_tournament: :environment do
    url = "https://e12112e2454d41f1824088919da39bc0.club-cloud.de/admin/announcement/tournament/editTournamentSave.php"
    uri = URI(url)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    req = Net::HTTP::Post.new(uri.request_uri)
    req["cookie"] = "PHPSESSID=9310db9a9970e8a02ed95ed8cd8e4309"
    req["Content-Type"] = "application/x-www-form-urlencoded"
    req.set_form_data(fedId: 20,
                      branchId: 10,
                      subBranchId: 3,
                      sportDistrictId: 7,
                      clubId: 1010,
                      stateId: "new",
                      tournamentId: 2,
                      title: "5. NordCup Dreiband",
                      dateFrom: "01.05.2022",
                      participants: 0,
                      description: "",
                      startgeld: 0,
                      preisgeld: 0,
                      infoLink: nil,
                      deadline: "08.04.2022",
                      selectedBranchId: 10,
                      selectedFrequenceId: 1,
                      selectedDisciplinId: 6,
                      selectedCategory: 1)
    res = http.request(req)
    res
  end

  desc "Spielerabgleich mit CC"
  task player_cc_matching: :environment do
    lines = []
    season = Season[2]
    Player
      .joins(club: :region)
      .joins(party_a_games: { party: { league: :season } })
      .joins(party_b_games: { party: { league: :season } })
      .where(seasons: { id: season.id })
      .where(regions: { id: 1 })
      .where("players.ba_id < 900000000")
      .order(:lastname).uniq.each do |p|
      next if p.firstname.blank?
      party_game_a_ids =
        p.party_a_games
         .joins(party: :league)
         .where(leagues: { season_id: season.id }).ids
      party_game_b_ids =
        p.party_b_games
         .joins(party: :league)
         .where(leagues: { season_id: season.id }).ids
      party_a_ids = Party.joins(:party_games).where(party_games: { id: party_game_a_ids }).map(&:id)
      party_b_ids = Party.joins(:party_games).where(party_games: { id: party_game_b_ids }).map(&:id)
      party_ids = Party.where(id: (party_a_ids + party_b_ids).uniq).ids
      league_team_a_ids = LeagueTeam.joins(:parties_a).where(parties: { id: party_a_ids }).ids
      league_team_b_ids = LeagueTeam.joins(:parties_b).where(parties: { id: party_b_ids }).ids
      league_teams = LeagueTeam.where(id: (league_team_a_ids + league_team_b_ids).uniq)
      league_teams.each do |league_team|
        lines.push([p.cc_id, p.lastname, p.firstname, league_team.league.discipline.andand.name, league_team.league.name, league_team.name, p.ba_id].join(";"))
      end
      f = lines.join("\n")
      f = "#{%w[PASS-NR NACHNAME VORNAME SPARTE LIGA MANNSCHAFT DBU-NR].join(";")}\n#{f}"
      # f = "#{%w{PASS-NR NACHNAME VORNAME SPARTE LIGA MANNSCHAFT DBU-NR}.join(";")}\n#{f}".encode("Windows-1252", crlf_newline: true)
      File.write("#{Rails.root}/tmp/#{season.name.tr("/", "-")}-players.csv", f)
    end
  end

  desc "test league scraping"
  task test_league_scraping: :environment do
    l = League[3553]
    l.scrape_single_league(game_details: true)
  end
  desc "test settings"
  task test_setting: :environment do
    Setting.connection
    Setting.key_delete(:admin_email)
  end
  desc "test version update"
  task test_version_update: :environment do
    Version.update_from_carambus_api(update_region_from_cc: 1, player_details: true)
  end

  desc "test_league 8"
  task test_league8: :environment do
    # League[3464].scrape_single_league(game_details: true)
    region = Region[1]
    season = Season[2]
    League.scrape_leagues_by_region_and_season(region, season, game_details: false, league_details: true)
  end

  task clean_local: :environment do
    TournamentMonitor.where("id > 50000000").destroy_all
    TableMonitor.where("id > 50000000").destroy_all
    Game.where("id > 50000000").destroy_all
    GameParticipation.where("id > 50000000").destroy_all
    Account.where("id > 50000000").destroy_all
    User.where("id > 50000000").destroy_all
  end

  task test_ko_plans: :environment do
    TournamentPlan.ko(20)
  end

  task test_player_id_from_ranking: :environment do
    tm = TournamentMonitor[50_000_018]
    player_id = tm.player_id_from_ranking("(g1.rk4 + g2.rk4 +g3.rk4).rk2")
    puts player_id
  end

  task test_accumulate_results: :environment do
    tm = TournamentMonitor[50_000_026]
    tm.accumulate_results
  end
end
