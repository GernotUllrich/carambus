# Streaming Production Deployment Guide

## Overview

This guide covers deploying the text-based streaming overlay system to production, including configuration via the admin dashboard and Raspberry Pi setup.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Admin Dashboard Configuration](#admin-dashboard-configuration)
3. [Raspberry Pi Setup](#raspberry-pi-setup)
4. [Deployment Steps](#deployment-steps)
5. [Monitoring & Troubleshooting](#monitoring--troubleshooting)

---

## Architecture Overview

### Components

```
Admin Dashboard (Rails Server)
  ‚Üì SSH
Raspberry Pi (Camera + FFmpeg)
  ‚Üì RTMP
YouTube Live Stream
  ‚Üì HTTP
Rails Server (Scoreboard Text Endpoint)
  ‚Üì Curl (every 1 second)
Raspberry Pi (Background updater)
  ‚Üì FFmpeg drawtext filter
YouTube Stream (Live Overlay)
```

### Key Files

- **Server**: `app/controllers/locations_controller.rb#scoreboard_text` - Text endpoint
- **Pi**: `/usr/local/bin/carambus-stream.sh` - Main streaming script
- **Pi**: `/etc/carambus/stream-table-N.conf` - Configuration (auto-generated by admin)
- **Pi**: `/tmp/carambus-overlay-text-table-N.txt` - Text file for overlay

---

## Admin Dashboard Configuration

### How Admin Dashboard Controls Streaming

The admin dashboard is the **primary control interface** for production streaming. When you use the dashboard:

1. **Configuration stored in database** (`StreamConfiguration` model)
2. **Start button** triggers `StreamControlJob`:
   - Generates config file from database settings
   - Deploys to Pi via SSH: `/etc/carambus/stream-table-N.conf`
   - Executes: `systemctl start carambus-stream@N.service`
3. **Stop button** executes: `systemctl stop carambus-stream@N.service`

### Important Parameters

The following database fields control the stream quality:

| Field | Recommended | Description |
|-------|-------------|-------------|
| `camera_width` | 1280 | Resolution width (720p) |
| `camera_height` | 720 | Resolution height |
| `camera_fps` | 30 | Frames per second |
| `video_bitrate` | 2500 | Video bitrate in kbps |
| `audio_bitrate` | 128 | Audio bitrate in kbps |
| `overlay_enabled` | true | Enable text overlay |
| `overlay_height` | 100 | Overlay area height |
| `raspi_ip` | 192.168.x.x | Pi IP address |
| `raspi_ssh_port` | 22 | SSH port |
| `raspi_ssh_user` | pi | SSH username |

### Configuring via Admin UI

1. Navigate to **Admin ‚Üí Stream Configurations**
2. Find the configuration for your table
3. Click **Edit**
4. Set the parameters:
   ```
   Camera Width: 1280
   Camera Height: 720
   Camera FPS: 30
   Video Bitrate: 2500
   Audio Bitrate: 128
   Raspberry Pi IP: 192.168.2.216  (club network)
   SSH Port: 22
   Overlay Enabled: ‚úì Yes
   Overlay Height: 100
   ```
5. Click **Update**
6. Use **Start** button to begin streaming

### Configuring via Rails Console

```ruby
# Connect to production server
ssh user@bc-wedel.duckdns.org
cd /path/to/carambus
RAILS_ENV=production rails console

# Find configuration (adjust table_id as needed)
config = StreamConfiguration.find_by(table_id: 2)

# Update settings
config.update!(
  camera_width: 1280,
  camera_height: 720,
  camera_fps: 30,
  video_bitrate: 2500,
  audio_bitrate: 128,
  overlay_enabled: true,
  overlay_height: 100,
  raspi_ip: '192.168.2.216',
  raspi_ssh_port: 22,
  raspi_ssh_user: 'pi'
)

# Verify
config.reload
puts "Resolution: #{config.camera_width}x#{config.camera_height} @ #{config.camera_fps}fps"
puts "Bitrate: #{config.video_bitrate}k"
puts "Pi: #{config.raspi_ip}:#{config.raspi_ssh_port}"
```

---

## Raspberry Pi Setup

### Prerequisites

The Pi should already have from initial setup:
- Carambus repository at `/home/pi/carambus_master`
- Systemd service files in `/etc/systemd/system/`
- Camera configured and working

### Update Script and Configuration

1. **SSH to Raspberry Pi**
   ```bash
   ssh pi@192.168.2.216
   ```

2. **Pull latest code**
   ```bash
   cd /home/pi/carambus_master
   git pull carambus master
   ```

3. **Deploy streaming script**
   ```bash
   sudo cp /home/pi/carambus_master/bin/carambus-stream.sh /usr/local/bin/
   sudo chmod +x /usr/local/bin/carambus-stream.sh
   ```

4. **Verify systemd service exists**
   ```bash
   sudo systemctl status carambus-stream@6.service
   ```

### Manual Configuration (if not using admin dashboard)

‚ö†Ô∏è **Note**: Admin dashboard will overwrite this file when starting stream!

Edit configuration manually only for testing:

```bash
sudo nano /etc/carambus/stream-table-6.conf
```

```bash
# Carambus Stream Configuration for Table 6 (ID: 2)
# Note: Table 6 refers to table name "Tisch 6", Rails table_id is 2

YOUTUBE_KEY=your-youtube-stream-key
CAMERA_DEVICE=/dev/video0
CAMERA_WIDTH=1280
CAMERA_HEIGHT=720
CAMERA_FPS=30

OVERLAY_ENABLED=true
OVERLAY_POSITION=bottom
OVERLAY_HEIGHT=100
OVERLAY_WIDTH=1280

VIDEO_BITRATE=2500
AUDIO_BITRATE=128

# Critical: TABLE_ID is Rails database ID, TABLE_NUMBER is for file naming
TABLE_ID=2
TABLE_NUMBER=6
LOCATION_MD5=your-location-md5
SERVER_URL=http://bc-wedel.duckdns.org:3131
```

### Finding Your Location MD5

```ruby
# In Rails console
location = Location.find_by(name: "BC Wedel 61 Vereinsheim")
puts location.md5
```

Or from URL when viewing scoreboard:
```
http://bc-wedel.duckdns.org:3131/locations/[LOCATION_MD5]/scoreboard?table_id=2
```

---

## Deployment Steps

### Production Deployment Checklist

#### 1. Server-Side (bc-wedel.duckdns.org:3131)

‚úÖ Deploy latest code:
```bash
ssh user@bc-wedel.duckdns.org
cd /path/to/carambus_bcw
git pull origin master
# Restart Rails if needed
```

‚úÖ Verify endpoint works:
```bash
curl -s "http://bc-wedel.duckdns.org:3131/locations/[MD5]/scoreboard_text?table_id=2"
```

Expected output:
```
T6 ‚Ä¢ LIVE
‚ñ∂ Player1:  50 (2)
  Player2:  13
```

#### 2. Configure Stream via Admin Dashboard

‚úÖ Open admin interface: `http://bc-wedel.duckdns.org:3131/admin/stream_configurations`

‚úÖ Edit Table 6 configuration:
- Set camera resolution: **1280x720 @ 30fps**
- Set video bitrate: **2500 kbps**
- Set Raspberry Pi IP: **192.168.2.216**
- Enable overlay
- Save configuration

#### 3. Raspberry Pi Setup (when at club)

‚úÖ Connect to club network and SSH:
```bash
ssh pi@192.168.2.216
```

‚úÖ Pull latest code:
```bash
cd /home/pi/carambus_master
git pull carambus master
```

‚úÖ Deploy script:
```bash
sudo cp /home/pi/carambus_master/bin/carambus-stream.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/carambus-stream.sh
```

‚úÖ Verify camera:
```bash
v4l2-ctl --device=/dev/video0 --list-formats-ext
```

#### 4. Start Streaming

**Option A: Via Admin Dashboard (Recommended)**
1. Open admin interface
2. Find Table 6 configuration
3. Click **Start** button
4. Monitor status (should show üü¢ Active)

**Option B: Manual (for testing)**
```bash
ssh pi@192.168.2.216
sudo systemctl start carambus-stream@6.service
sudo systemctl status carambus-stream@6.service
```

#### 5. Verify Stream

‚úÖ Check YouTube Studio after 30-60 seconds
- Resolution should show **720p**
- Keyframe interval: **2 seconds** (no warning)
- Stream delay: **~5-8 seconds**

‚úÖ Check overlay text appears:
```
T6 ‚Ä¢ LIVE
‚ñ∂ Gernot:  52 (2)
  J√∂rg:    15
```

‚úÖ Test live updates:
- Enter score in scoreboard
- Overlay should update within **~1 second**
- Numbers should be **right-aligned**
- Current inning balls in **parentheses**

---

## Monitoring & Troubleshooting

### Admin Dashboard Monitoring

The dashboard provides:
- **Real-time status** (Active, Inactive, Error)
- **Health checks** (automatic, every 2 minutes)
- **Recent logs** from Pi systemd journal
- **Start/Stop controls**
- **Restart** capability

### Manual Monitoring on Pi

```bash
# Check service status
sudo systemctl status carambus-stream@6.service

# Watch live logs
sudo journalctl -u carambus-stream@6.service -f

# Check FFmpeg is running
ps aux | grep ffmpeg

# Check text file content
cat /tmp/carambus-overlay-text-table-6.txt

# Test text endpoint
curl -s "http://bc-wedel.duckdns.org:3131/locations/[MD5]/scoreboard_text?table_id=2"
```

### Common Issues

#### Stream Not Starting

**Symptom**: Admin dashboard shows "Failed to start"

**Check**:
1. SSH connectivity from server to Pi:
   ```bash
   ssh pi@192.168.2.216 echo "connected"
   ```
2. Camera not in use:
   ```bash
   lsof /dev/video0
   ```
3. Configuration file deployed:
   ```bash
   cat /etc/carambus/stream-table-6.conf
   ```

#### Overlay Not Showing

**Symptom**: Stream works but no overlay text

**Check**:
1. Text file exists and updates:
   ```bash
   watch -n 1 cat /tmp/carambus-overlay-text-table-6.txt
   ```
2. Background curl process running:
   ```bash
   ps aux | grep curl | grep scoreboard_text
   ```
3. Server endpoint accessible from Pi:
   ```bash
   curl -s "http://bc-wedel.duckdns.org:3131/locations/[MD5]/scoreboard_text?table_id=2"
   ```

#### Text Not Updating

**Symptom**: Overlay frozen on old score

**Check**:
1. Background curl still running (might have crashed)
2. Restart service:
   ```bash
   sudo systemctl restart carambus-stream@6.service
   ```

#### Blurry or Pixelated

**Symptom**: Low quality stream

**Fix**: Increase resolution/bitrate via admin dashboard:
- For 720p: 2500 kbps
- For 1080p: 4500 kbps (may overload Pi4)

#### YouTube Keyframe Warning

**Symptom**: "Verwende eine Keyframe-Frequenz von vier Sekunden oder weniger"

**Fix**: Should be automatic (script sets `-g 60` for 2-second keyframes at 30fps)

If still appears, check FFmpeg command:
```bash
ps aux | grep ffmpeg | grep -o '\-g [0-9]*'
# Should show: -g 60
```

### Performance Monitoring

```bash
# CPU usage
htop

# FFmpeg stats
sudo journalctl -u carambus-stream@6.service -f | grep fps=

# Network bandwidth
iftop -i wlan0  # or eth0
```

### Stopping the Stream

**Via Admin Dashboard**:
- Click **Stop** button

**Manual**:
```bash
sudo systemctl stop carambus-stream@6.service
```

---

## Technical Notes

### TABLE_ID vs TABLE_NUMBER

- **TABLE_ID**: Rails database ID (e.g., `2`) - used for fetching scoreboard data
- **TABLE_NUMBER**: Table name suffix (e.g., `6` from "Tisch 6") - used for file naming

Example:
- Table in database: `id: 2, name: "Tisch 6"`
- Config file: `/etc/carambus/stream-table-6.conf`
- Text file: `/tmp/carambus-overlay-text-table-6.txt`
- Service: `carambus-stream@6.service`
- But fetches data: `?table_id=2`

### Font Sizing

The script auto-scales font based on resolution:
- **360p**: 16px
- **720p**: 24px
- **1080p**: 32px

### Text Format

Current format (monospace font for alignment):
```
Line 1: T6 ‚Ä¢ LIVE
Line 2: ‚ñ∂ Name1:  Score1 (InningBalls)
Line 3:   Name2:  Score2
```

- Right-aligned scores
- Current inning balls in parentheses (only when > 0)
- Active player indicator: `‚ñ∂`
- Inactive player: two spaces `  `

### Resolution Recommendations

| Resolution | Bitrate | CPU | Quality | Recommended |
|------------|---------|-----|---------|-------------|
| 360p (640x360) | 1000k | Low | Poor text | ‚ùå No |
| 720p (1280x720) | 2500k | Medium | Good | ‚úÖ **Yes** |
| 1080p (1920x1080) | 4500k | High | Excellent | ‚ö†Ô∏è May lag |

**Production recommendation**: **720p @ 30fps @ 2500k** - Best balance for Pi4.

---

## Security Notes

### SSH Authentication

Currently using password authentication via environment variables. Consider switching to SSH keys for production:

1. Generate key on server:
   ```bash
   ssh-keygen -t ed25519 -f ~/.ssh/carambus_streaming
   ```

2. Deploy to Pi:
   ```bash
   ssh-copy-id -i ~/.ssh/carambus_streaming.pub pi@192.168.2.216
   ```

3. Update environment variable:
   ```bash
   RASPI_SSH_KEY_PATH=/path/to/.ssh/carambus_streaming
   ```

### Network Security

- Raspberry Pi is only accessible within club LAN (192.168.2.x)
- No direct internet exposure
- Server initiates all connections (outbound SSH)
- YouTube stream key should be kept secret

---

## Related Documentation

- [Streaming Architecture](../developers/streaming-architecture.en.md)
- [Streaming Setup Guide](streaming-setup.en.md)
- [Systemd Services](systemd-streaming-services.md)

---

## Support

For issues or questions:
1. Check logs: `sudo journalctl -u carambus-stream@6.service -f`
2. Verify configuration: Admin Dashboard ‚Üí Stream Configurations
3. Test endpoint: `curl http://bc-wedel.duckdns.org:3131/locations/[MD5]/scoreboard_text?table_id=2`
4. Check GitHub issues: https://github.com/GernotUllrich/carambus

---

**Last Updated**: 2026-01-05  
**Version**: 1.0 (Text-based overlay system)

