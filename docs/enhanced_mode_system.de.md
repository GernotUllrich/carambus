# Carambus Enhanced Mode System

## üéØ **√úbersicht**

Das **Enhanced Mode System** erm√∂glicht das einfache Umschalten zwischen verschiedenen Deployment-Konfigurationen f√ºr Carambus. Es verwendet **Ruby/Rake Tasks** f√ºr maximale Debugging-Unterst√ºtzung und **Unix Sockets** f√ºr effiziente Kommunikation zwischen NGINX und Puma.

## üöÄ **Schnellstart**

### **Ruby/Rake Named Parameters System**

```bash
# API Server Mode
bundle exec rails 'mode:api' MODE_BASENAME=carambus_api MODE_DATABASE=carambus_api_production MODE_HOST=newapi.carambus.de MODE_PORT=3001

# Local Server Mode
bundle exec rails 'mode:local' MODE_SEASON_NAME='2025/2026' MODE_CONTEXT=NBV MODE_API_URL='https://newapi.carambus.de/'
```

## üìã **Verf√ºgbare Parameter**

### **Alle Parameter (alphabetisch)**
- `MODE_API_URL` - API URL f√ºr LOCAL Mode
- `MODE_APPLICATION_NAME` - Anwendungsname
- `MODE_BASENAME` - Deploy Basename
- `MODE_BRANCH` - Git Branch
- `MODE_CLUB_ID` - Club ID
- `MODE_CONTEXT` - Context Identifier
- `MODE_DATABASE` - Datenbankname
- `MODE_DOMAIN` - Domain Name
- `MODE_HOST` - Server Hostname
- `MODE_LOCATION_ID` - Location ID
- `MODE_NGINX_PORT` - NGINX Web Port (default: 80)
- `MODE_PORT` - Server Port
- `MODE_PUMA_SCRIPT` - Puma Management Script
- `MODE_PUMA_SOCKET` - Puma Socket Name (default: puma-{rails_env}.sock)
- `MODE_RAILS_ENV` - Rails Environment
- `MODE_SCOREBOARD_URL` - Scoreboard URL (auto-generated)
- `MODE_SEASON_NAME` - Season Identifier
- `MODE_SSL_ENABLED` - SSL aktiviert (true/false, default: false)

## üéØ **Verwendungsbeispiele**

### **1. API Server Deployment**
```bash
bundle exec rails 'mode:api' \
  MODE_BASENAME=carambus_api \
  MODE_DATABASE=carambus_api_production \
  MODE_HOST=newapi.carambus.de \
  MODE_PORT=3001 \
  MODE_DOMAIN=api.carambus.de \
  MODE_RAILS_ENV=production \
  MODE_BRANCH=master \
  MODE_PUMA_SCRIPT=manage-puma-api.sh \
  MODE_NGINX_PORT=80 \
  MODE_PUMA_SOCKET=puma-production.sock \
  MODE_SSL_ENABLED=true
```

### **2. Local Server Deployment**
```bash
bundle exec rails 'mode:local' \
  MODE_SEASON_NAME='2025/2026' \
  MODE_APPLICATION_NAME=carambus \
  MODE_CONTEXT=NBV \
  MODE_API_URL='https://newapi.carambus.de/' \
  MODE_BASENAME=carambus \
  MODE_DATABASE=carambus_api_development \
  MODE_DOMAIN=carambus.de \
  MODE_LOCATION_ID=1 \
  MODE_CLUB_ID=357 \
  MODE_HOST=new.carambus.de \
  MODE_RAILS_ENV=production \
  MODE_NGINX_PORT=80 \
  MODE_PUMA_SOCKET=puma-production.sock \
  MODE_SSL_ENABLED=false
```

### **3. Entwicklungsumgebung**
```bash
bundle exec rails 'mode:api' \
  MODE_BASENAME=carambus_api \
  MODE_DATABASE=carambus_api_development \
  MODE_HOST=localhost \
  MODE_PORT=3001 \
  MODE_RAILS_ENV=development \
  MODE_NGINX_PORT=3000 \
  MODE_PUMA_SOCKET=puma-development.sock \
  MODE_SSL_ENABLED=false
```

## üíæ **Konfigurationen Verwalten**

### **Konfiguration Speichern**
```bash
bundle exec rails 'mode:save[production_api]' \
  MODE_BASENAME=carambus_api \
  MODE_DATABASE=carambus_api_production \
  MODE_HOST=newapi.carambus.de \
  MODE_PORT=3001 \
  MODE_NGINX_PORT=80 \
  MODE_PUMA_SOCKET=puma-production.sock \
  MODE_SSL_ENABLED=true
```

### **Gespeicherte Konfigurationen Auflisten**
```bash
bundle exec rails 'mode:list'
```

### **Konfiguration Laden**
```bash
bundle exec rails 'mode:load[production_api]'
```

## üîß **Socket-basierte Architektur**

### **Unix Socket Vorteile**
- ‚úÖ **Effizienter** - Keine TCP/IP Overhead
- ‚úÖ **Sicherer** - Nur lokale Kommunikation
- ‚úÖ **Schneller** - Direkte Kernel-Kommunikation
- ‚úÖ **Skalierbarer** - Bessere Performance unter Last

### **Socket-Pfad Struktur**
```
/var/www/{basename}/shared/
‚îú‚îÄ‚îÄ sockets/
‚îÇ   ‚îî‚îÄ‚îÄ puma-{rails_env}.sock    # Unix Socket
‚îú‚îÄ‚îÄ pids/
‚îÇ   ‚îú‚îÄ‚îÄ puma-{rails_env}.pid     # Process ID
‚îÇ   ‚îî‚îÄ‚îÄ puma-{rails_env}.state   # State File
‚îî‚îÄ‚îÄ log/
    ‚îú‚îÄ‚îÄ puma.stdout.log          # Standard Output
    ‚îî‚îÄ‚îÄ puma.stderr.log          # Standard Error
```

## üîß **Automatische Template-Generierung**

### **Templates werden automatisch generiert**
Das System generiert und √ºbertr√§gt automatisch:

1. **NGINX Konfiguration** (`config/nginx.conf`)
   - Verwendet Unix Socket: `unix:/var/www/{basename}/shared/sockets/{puma_socket}`
   - Kopiert nach `/etc/nginx/sites-available/{basename}`
   - Erstellt Symlink in `/etc/nginx/sites-enabled/`
   - Testet Konfiguration und l√§dt NGINX neu

2. **Puma.rb Konfiguration** (`config/puma.rb`)
   - Bindet an Unix Socket: `unix://{shared_dir}/sockets/puma-{rails_env}.sock`
   - Erstellt Socket-Verzeichnisse automatisch
   - Setzt korrekte Socket-Berechtigungen (0666)
   - Konfiguriert PID- und State-Dateien

3. **Puma Service Konfiguration** (`config/puma.service`)
   - Kopiert nach `/etc/systemd/system/puma-{basename}.service`
   - Erstellt Socket-Verzeichnisse vor Service-Start
   - L√§dt systemd daemon neu
   - Aktiviert den Service

4. **Scoreboard URL** (`config/scoreboard_url`)
   - Kopiert nach `/var/www/{basename}/shared/config/scoreboard_url`

### **Templates √ºber Capistrano deployen**
```bash
# Alle Templates (automatisch nach Deployment)
bundle exec cap production deploy

# Einzelne Template-Tasks
bundle exec cap production deploy:nginx_config
bundle exec cap production deploy:puma_rb_config
bundle exec cap production deploy:puma_service_config
```

## üìã **Capistrano Integration**

### **Automatische Template-√úbertragung**

Die folgenden Dateien werden automatisch √ºbertragen:
- `config/nginx.conf` ‚Üí `/var/www/{basename}/shared/config/nginx.conf`
- `config/puma.rb` ‚Üí `/var/www/{basename}/shared/puma.rb`
- `config/puma.service` ‚Üí `/var/www/{basename}/shared/config/puma.service`
- `config/scoreboard_url` ‚Üí `/var/www/{basename}/shared/config/scoreboard_url`

### **Deployment-Hooks**

```ruby
# Automatisch nach jedem Deployment
after "deploy:published", "deploy:deploy_templates"
```

### **Verf√ºgbare Capistrano Tasks**

```bash
# Template-Deployment
cap deploy:deploy_templates              # Alle Templates deployen
cap deploy:nginx_config                  # NGINX Konfiguration deployen
cap deploy:puma_rb_config                # Puma.rb Konfiguration deployen
cap deploy:puma_service_config           # Puma Service deployen

# Puma Management
cap puma:restart                         # Puma neu starten
cap puma:stop                            # Puma stoppen
cap puma:start                           # Puma starten
cap puma:status                          # Puma Status anzeigen
```

## üîß **RubyMine Debugging**

### **Vollst√§ndige Debugging-Unterst√ºtzung**

Das Ruby/Rake-System bietet **perfekte RubyMine-Integration**:

#### **1. Breakpoints setzen**
```ruby
# In lib/tasks/mode.rake
def parse_named_parameters_from_env
  params = {}
  
  # Setze Breakpoint hier
  %i[season_name application_name context api_url basename database domain location_id club_id rails_env host port branch puma_script nginx_port puma_port ssl_enabled scoreboard_url puma_socket].each do |param|
    env_var = "MODE_#{param.to_s.upcase}"
    params[param] = ENV[env_var] if ENV[env_var]
  end
  
  params  # Setze Breakpoint hier
end
```

#### **2. RubyMine Run Configuration**
```
Run -> Edit Configurations -> Rake
Task: mode:api
Environment Variables:
  MODE_BASENAME=carambus_api
  MODE_DATABASE=carambus_api_production
  MODE_HOST=newapi.carambus.de
  MODE_PORT=3001
  MODE_NGINX_PORT=80
  MODE_PUMA_SOCKET=puma-production.sock
  MODE_SSL_ENABLED=true
```

#### **3. Step-by-Step Debugging**
- **Step Into**: Gehe in Methoden hinein
- **Step Over**: √úberspringe Methoden
- **Step Out**: Gehe aus Methoden heraus
- **Variables Inspector**: Sehe alle Parameter-Werte

## üéØ **Best Practices**

### **1. RubyMine Debugging Workflow**
```bash
# 1. Setze Breakpoints in lib/tasks/mode.rake
# 2. Erstelle RubyMine Run Configuration
# 3. Debugge step-by-step
# 4. Inspiziere Variablen
# 5. Teste verschiedene Parameter-Kombinationen
```

### **2. Konfigurationen Speichern**
```bash
# Speichere h√§ufig verwendete Konfigurationen
bundle exec rails 'mode:save[production_api]' MODE_BASENAME=carambus_api MODE_DATABASE=carambus_api_production MODE_HOST=newapi.carambus.de MODE_PORT=3001 MODE_NGINX_PORT=80 MODE_PUMA_SOCKET=puma-production.sock MODE_SSL_ENABLED=true
bundle exec rails 'mode:save[development_api]' MODE_BASENAME=carambus_api MODE_DATABASE=carambus_api_development MODE_HOST=localhost MODE_PORT=3001 MODE_NGINX_PORT=3000 MODE_PUMA_SOCKET=puma-development.sock MODE_SSL_ENABLED=false
```

### **3. Nur √Ñnderungen Angeben**
```bash
# Nur die Parameter angeben, die sich von den Defaults unterscheiden
bundle exec rails 'mode:api' MODE_HOST=localhost MODE_PORT=3001 MODE_RAILS_ENV=development MODE_NGINX_PORT=3000 MODE_PUMA_SOCKET=puma-development.sock MODE_SSL_ENABLED=false
```

## üöÄ **Deployment Workflow**

### **1. Konfiguration Vorbereiten**
```bash
# Lade gespeicherte Konfiguration
bundle exec rails 'mode:load[api_hetzner]'
```

### **2. Konfiguration Anwenden**
```bash
# Wende die geladenen Parameter an
bundle exec rails 'mode:api'
```

### **3. Konfiguration Validieren**
```bash
# √úberpr√ºfe die aktuelle Konfiguration
bundle exec rails 'mode:status'
```

### **4. Deployment Ausf√ºhren**
```bash
# Deploy mit der validierten Konfiguration
bundle exec cap production deploy
```

## üîÑ **Multi-Environment Deployment**

### **Deployment-Script Integration**
```bash
# API Server Deployment mit automatischem Pull
./bin/deploy.sh deploy-api

# Local Server Deployment mit automatischem Pull
./bin/deploy.sh deploy-local

# Full Local Deployment
./bin/deploy.sh full-local
```

### **Automatischer Repo-Pull**
Das Deployment-System f√ºhrt automatisch einen `git pull` f√ºr die jeweiligen Szenario-Ordner durch, bevor das Deployment startet.

## üîç **Troubleshooting**

### **Socket-Berechtigungen pr√ºfen**
```bash
# Socket-Verzeichnis pr√ºfen
ls -la /var/www/carambus_api/shared/sockets/

# Socket-Berechtigungen pr√ºfen
ls -la /var/www/carambus_api/shared/sockets/puma-production.sock
```

### **NGINX Socket-Konfiguration testen**
```bash
# Lokal testen
sudo nginx -t

# Auf Server testen
ssh -p 8910 www-data@newapi.carambus.de 'sudo nginx -t'
```

### **Puma Socket Status**
```bash
# Socket-Verbindung pr√ºfen
ssh -p 8910 www-data@newapi.carambus.de 'netstat -an | grep puma'

# Service Status
ssh -p 8910 www-data@newapi.carambus.de 'sudo systemctl status puma-carambus_api.service'
```

### **Socket-Verzeichnisse erstellen**
```bash
# Manuell Socket-Verzeichnisse erstellen
ssh -p 8910 www-data@newapi.carambus.de 'sudo mkdir -p /var/www/carambus_api/shared/sockets /var/www/carambus_api/shared/pids /var/www/carambus_api/shared/log'
```

## üìÅ **Dateistruktur**

### **Konfigurationsdateien**
```
config/
‚îú‚îÄ‚îÄ named_modes/           # Gespeicherte Named-Konfigurationen
‚îÇ   ‚îú‚îÄ‚îÄ api_hetzner.yml
‚îÇ   ‚îú‚îÄ‚îÄ local_hetzner.yml
‚îÇ   ‚îî‚îÄ‚îÄ development.yml
‚îú‚îÄ‚îÄ carambus.yml.erb      # ERB Template
‚îú‚îÄ‚îÄ database.yml.erb      # ERB Template
‚îú‚îÄ‚îÄ deploy.rb.erb         # ERB Template
‚îú‚îÄ‚îÄ nginx.conf.erb        # NGINX Template (Socket-basiert)
‚îú‚îÄ‚îÄ puma.rb.erb           # Puma.rb Template (Socket-basiert)
‚îú‚îÄ‚îÄ puma.service.erb      # Puma Service Template
‚îú‚îÄ‚îÄ scoreboard_url.erb    # Scoreboard URL Template
‚îú‚îÄ‚îÄ nginx.conf            # Generierte NGINX Konfiguration
‚îú‚îÄ‚îÄ puma.rb               # Generierte Puma.rb Konfiguration
‚îú‚îÄ‚îÄ puma.service          # Generierter Puma Service
‚îú‚îÄ‚îÄ scoreboard_url        # Generierte Scoreboard URL
‚îî‚îÄ‚îÄ deploy/
    ‚îî‚îÄ‚îÄ production.rb.erb # ERB Template
```

### **Rake Tasks**
```
lib/tasks/
‚îî‚îÄ‚îÄ mode.rake             # Hauptsystem mit Named Parameters

lib/capistrano/tasks/
‚îî‚îÄ‚îÄ templates.rake        # Capistrano Template-Tasks
```

## ‚úÖ **Vorteile des Enhanced Mode Systems**

1. **RubyMine Integration**: Perfekte Debugging-Unterst√ºtzung
2. **Type Safety**: Ruby-Typisierung und Validierung
3. **Error Handling**: Robuste Fehlerbehandlung
4. **Debugging**: Step-by-Step Debugging mit Breakpoints
5. **Variable Inspection**: Vollst√§ndige Variablen-Inspektion
6. **Call Stack**: Call Stack Navigation
7. **IDE Support**: Vollst√§ndige IDE-Unterst√ºtzung
8. **Maintainability**: Einfache Wartung und Erweiterung
9. **Socket Integration**: Vollst√§ndige Socket-basierte Architektur
10. **Template Generation**: Automatische Template-Generierung
11. **Performance**: Unix Sockets sind schneller als TCP/IP
12. **Security**: Keine Netzwerk-Exposition
13. **Efficiency**: Weniger Overhead
14. **Scalability**: Bessere Performance unter Last
15. **Automation**: Vollst√§ndige Automatisierung
16. **Multi-Environment**: Multi-Environment Support

## üéâ **Fazit**

Das **Enhanced Mode System** mit Socket-basierter Architektur ist die **ideale L√∂sung** f√ºr RubyMine-Nutzer:

- ‚úÖ **Vollst√§ndige Debugging-Unterst√ºtzung**
- ‚úÖ **Robuste Parameter-Behandlung**
- ‚úÖ **Einfache Wartung**
- ‚úÖ **IDE-Integration**
- ‚úÖ **Type Safety**
- ‚úÖ **Socket-basierte Architektur**
- ‚úÖ **Automatische Template-Generierung**
- ‚úÖ **Vollst√§ndige Automatisierung**
- ‚úÖ **Multi-Environment Support**
- ‚úÖ **Robuste Deployment-Pipeline**

**Empfehlung**: Verwende das Enhanced Mode System f√ºr alle Carambus-Deployments.

Das System macht die Deployment-Konfiguration **debuggbar, wartbar und robust**! üöÄ
