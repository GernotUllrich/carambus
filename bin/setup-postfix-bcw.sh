#!/bin/bash
# Script to set up Postfix mail server on carambus_bcw server (bc-wedel.duckdns.org)
# Configures Postfix for simple email sending (no authentication required in Rails)

set -e

SSH_HOST="bc-wedel.duckdns.org"
SSH_PORT="8910"
SSH_USER="www-data"
DOMAIN="bc-wedel.duckdns.org"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}

# Test SSH connection
test_ssh_connection() {
    log "Testing SSH connection to ${SSH_USER}@${SSH_HOST}:${SSH_PORT}..."
    if ! ssh -p "$SSH_PORT" -o ConnectTimeout=10 "${SSH_USER}@${SSH_HOST}" "echo 'Connection successful'" > /dev/null 2>&1; then
        error "Cannot connect to server. Please check:"
        error "  - Server is reachable: ${SSH_HOST}"
        error "  - SSH port is correct: ${SSH_PORT}"
        error "  - User has access: ${SSH_USER}"
        exit 1
    fi
    log "âœ… SSH connection successful"
}

# Install Postfix
install_postfix() {
    log "Installing Postfix and mail utilities..."
    
    ssh -p "$SSH_PORT" "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
        set -e
        
        # Check if Postfix is already installed
        if command -v postfix > /dev/null 2>&1; then
            echo "Postfix is already installed"
            postfix -v
            # Continue with configuration even if already installed
        else
        
        # Update package list
        sudo apt-get update
        
        # Install Postfix non-interactively
        # Set debconf selections for Postfix installation
        echo "postfix postfix/mailname string $(hostname -f)" | sudo debconf-set-selections
        echo "postfix postfix/main_mailer_type string 'Internet Site'" | sudo debconf-set-selections
        
            # Install Postfix and mail utilities
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils
            
            echo "Postfix installation completed"
        fi
ENDSSH
    
    log "âœ… Postfix installed successfully"
}

# Configure Postfix
configure_postfix() {
    log "Configuring Postfix for ${DOMAIN}..."
    
    # Create temporary config file
    local temp_config=$(mktemp)
    cat > "$temp_config" << EOF
# Postfix configuration for tournament results email sending
# Generated by setup-postfix-bcw.sh

# Basic settings
myhostname = ${DOMAIN}
mydomain = ${DOMAIN}
myorigin = \$mydomain

# Network settings - only listen on loopback (local sending only)
inet_interfaces = loopback-only
inet_protocols = ipv4

# Destination domains
mydestination = \$myhostname, localhost.\$mydomain, localhost

# No relay host - send directly
relayhost = 

# Mail delivery settings
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +

# Security settings
smtpd_banner = \$myhostname ESMTP
disable_vrfy_command = yes
smtpd_helo_required = yes

# Logging
maillog_file = /var/log/mail.log
EOF
    
    # Upload config file
    local temp_remote="/tmp/postfix-main.cf"
    scp -P "$SSH_PORT" "$temp_config" "${SSH_USER}@${SSH_HOST}:${temp_remote}"
    
    # Install config on server
    ssh -p "$SSH_PORT" "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
        set -e
        
        # Backup existing main.cf
        if [ -f /etc/postfix/main.cf ]; then
            sudo cp /etc/postfix/main.cf /etc/postfix/main.cf.backup.$(date +%Y%m%d_%H%M%S)
            echo "Backed up existing main.cf"
        fi
        
        # Install new config
        sudo mv /tmp/postfix-main.cf /etc/postfix/main.cf
        sudo chown root:root /etc/postfix/main.cf
        sudo chmod 644 /etc/postfix/main.cf
        
        echo "Postfix configuration updated"
ENDSSH
    
    # Clean up local temp file
    rm -f "$temp_config"
    
    log "âœ… Postfix configured"
}

# Restart Postfix
restart_postfix() {
    log "Restarting Postfix service..."
    
    ssh -p "$SSH_PORT" "${SSH_USER}@${SSH_HOST}" << 'ENDSSH'
        set -e
        
        # Test configuration
        if ! sudo postfix check; then
            echo "ERROR: Postfix configuration test failed"
            exit 1
        fi
        
        # Restart Postfix
        sudo systemctl restart postfix
        
        # Check status
        if sudo systemctl is-active --quiet postfix; then
            echo "Postfix is running"
        else
            echo "ERROR: Postfix failed to start"
            sudo systemctl status postfix
            exit 1
        fi
ENDSSH
    
    log "âœ… Postfix restarted and running"
}

# Test email sending
test_email() {
    log "Testing email sending..."
    
    info "This will send a test email. Please provide a test email address:"
    read -p "Test email address (or press Enter to skip): " TEST_EMAIL
    
    if [ -z "$TEST_EMAIL" ]; then
        warning "Skipping email test"
        return 0
    fi
    
    ssh -p "$SSH_PORT" "${SSH_USER}@${SSH_HOST}" << ENDSSH
        set -e
        
        echo "Test email from Postfix on ${DOMAIN}" | mail -s "Postfix Test - ${DOMAIN}" "${TEST_EMAIL}"
        echo "Test email sent to ${TEST_EMAIL}"
ENDSSH
    
    log "âœ… Test email sent to ${TEST_EMAIL}"
    info "Please check the inbox (and spam folder) for the test email"
}

# Main execution
main() {
    AUTO_CONFIRM=false
    
    # Check for -y flag
    if [[ "$1" == "-y" || "$1" == "--yes" ]]; then
        AUTO_CONFIRM=true
    fi
    
    log "ðŸš€ Setting up Postfix on ${SSH_HOST}"
    log "======================================"
    echo ""
    
    info "This script will:"
    info "  1. Install Postfix and mail utilities"
    info "  2. Configure Postfix for ${DOMAIN}"
    info "  3. Restart Postfix service"
    info "  4. Test email sending (optional)"
    echo ""
    
    if [ "$AUTO_CONFIRM" = false ]; then
        read -p "Continue? (y/N): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log "Setup cancelled"
            exit 0
        fi
    else
        log "Auto-confirming (non-interactive mode)"
    fi
    
    test_ssh_connection
    echo ""
    
    install_postfix
    echo ""
    
    configure_postfix
    echo ""
    
    restart_postfix
    echo ""
    
    test_email
    echo ""
    
    log "âœ… Postfix setup completed!"
    log ""
    log "Next steps:"
    log "  1. Rails is already configured to use sendmail (no changes needed)"
    log "  2. Update support_email in config/carambus.yml.erb if needed"
    log "  3. Test sending tournament results from the application"
    log ""
    log "To check Postfix status: ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} 'sudo systemctl status postfix'"
    log "To view mail logs: ssh -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} 'sudo tail -f /var/log/mail.log'"
}

# Run main function with arguments
main "$@"

